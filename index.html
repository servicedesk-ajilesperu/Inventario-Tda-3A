<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventario Tiendas 3A</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        /* Estilos Generales */
        body, html { margin: 0; padding: 0; font-family: sans-serif; background: #f7f7f7; }
        * { box-sizing: border-box; }

        /* Sidebar (Menú Lateral) */
        .sidebar { width: 260px; position: fixed; height: 100%; background: #ff4d00; color: white; display: flex; flex-direction: column; gap: 12px; padding: 20px; transition: 0.3s; overflow-y: auto; z-index: 10; }
        .sidebar.collapsed { width: 60px; padding: 20px 5px; }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.2rem; position: relative; margin-bottom: 10px; }
        #toggleSidebar { position: absolute; right: 0; top: 0; background: #cc3c00; color: white; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; }
        
        /* Acordeón del Menú */
        .menu-section { width: 100%; }
        .menu-section .accordion { background: transparent; color: white; border: none; padding: 10px; width: 100%; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; justify-content: space-between; transition: 0.2s; border-radius: 4px; }
        .menu-section .accordion.active, .menu-section .accordion:hover { background-color: #e64500; }
        .menu-section .panel { padding: 0 10px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; background-color: #e64500; display: flex; flex-direction: column; gap: 4px; }
        .menu-section .panel button { background: transparent; color: white; border: none; padding: 8px; text-align: left; display: flex; align-items: center; gap: 6px; cursor: pointer; width: 100%; border-radius: 4px; }
        .menu-section .panel button:hover { background-color: #cc4000; }
        
        /* Sidebar Colapsado */
        .sidebar.collapsed .brand span,
        .sidebar.collapsed .menu-section .accordion span,
        .sidebar.collapsed .panel button span { display: none; }
        .sidebar.collapsed .accordion { justify-content: center; }
        .sidebar.collapsed .accordion i.fa-chevron-down { display: none; }
        
        /* Contenido Principal */
        .main { margin-left: 260px; padding: 20px; transition: 0.3s; }
        .sidebar.collapsed ~ .main { margin-left: 60px; }
        
        /* Dashboard Cards */
        .cards { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .card { flex: 1; min-width: 150px; background: white; color: #ff4d00; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .card span { font-weight: 700; font-size: 1.3rem; display: block; margin-top: 5px;}
        .card i { font-size: 2rem; }
        
        /* Búsqueda */
        .search-bar { margin-bottom: 15px; display: flex; gap: 10px; }
        .search-bar input { flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }

        /* Tablas */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 0.9rem; }
        th { background: #ff4d00; color: white; font-weight: 600; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .actions button { margin: 0 2px; padding: 6px; border-radius: 50%; border: none; cursor: pointer; width: 32px; height: 32px; transition: 0.1s; }
        .actions button:hover { opacity: 0.8; }
        .btn-edit { background: #ffb86b; color: white; }
        .btn-del { background: #d9534f; color: white; }
        
        /* Modal */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 450px; max-width: 95%; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        input, select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; width: 100%; margin-bottom: 12px; font-size: 1rem; }
        .modal button { padding: 8px 15px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; transition: 0.1s; }
        .modal button:last-child { background:#ff4d00; color:white; }
        .modal button:last-child:hover { background:#cc3c00; }
        .modal button:first-child { background:#eee; color:#333; margin-right: 10px; }
        .modal button:first-child:hover { background:#ddd; }

        /* Responsiveness */
        @media(max-width:768px) {
            .sidebar { left: -260px; position: fixed; }
            .sidebar.collapsed { left: 0; }
            .main { margin-left: 0; padding: 10px; }
            .cards { flex-direction: column; }
            .card { min-width: 100%; }
        }
    </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <div class="brand">
        <i class="fa-solid fa-boxes-stacked"></i><span>Inventario 3A</span>
        <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
    </div>

    <div class="menu-section">
        <button class="accordion active" onclick="nav('dashboard')"><i class="fa-solid fa-house"></i><span>Dashboard</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel" style="max-height: 500px;">
            <button onclick="nav('dashboard')"><i class="fa-solid fa-gauge-high"></i><span>Ver Dashboard</span></button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-computer"></i><span>Inventario</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('inventario')"><i class="fa-solid fa-plus"></i><span>Agregar Inventario</span></button>
            <button onclick="nav('inventario')"><i class="fa-solid fa-table"></i><span>Ver Inventario</span></button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-tags"></i><span>Categorías</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('categoria')"><i class="fa-solid fa-plus"></i><span>Agregar Categoría</span></button>
            <button onclick="nav('categoria')"><i class="fa-solid fa-table"></i><span>Ver Categorías</span></button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-store"></i><span>Tiendas</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('tienda')"><i class="fa-solid fa-plus"></i><span>Agregar Tienda</span></button>
            <button onclick="nav('tienda')"><i class="fa-solid fa-table"></i><span>Ver Tiendas</span></button>
        </div>
    </div>
</aside>

<div class="main">
    <h2 id="main-title">Inventario de Tienda</h2>
    <div id="content"></div>
</div>

<div class="modal-backdrop" id="modal">
    <div class="modal">
        <h3 id="modal-title"></h3>
        <div id="modal-form"></div>
        <div style="text-align:right; margin-top:15px;">
            <button onclick="closeModal()">Cancelar</button>
            <button onclick="saveItem()">Guardar</button>
        </div>
    </div>
</div>

<script>
    // URL de tu Google Apps Script (¡REEMPLAZA ESTA URL CON LA TUYA!)
    const APPWEB_URL = "https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";
    
    // Variables de Estado
    let inventario = [], categorias = [], tiendas = [], pendingOps = [];
    let editItemIndex = null;
    let currentView = 'dashboard';
    let currentSearch = '';
    const STORAGE_KEY = 'inventario3a';

    // ————— Sidebar & Acordeon —————
    document.getElementById('toggleSidebar').onclick = function() {
        document.getElementById('sidebar').classList.toggle('collapsed');
    };

    function toggleAccordion(button) {
        // Cierra todos los paneles activos, excepto el que ya está activo
        document.querySelectorAll('.accordion').forEach(acc => {
            if (acc !== button && acc.classList.contains('active')) {
                acc.classList.remove('active');
                acc.nextElementSibling.style.maxHeight = null;
            }
        });

        // Toggle del panel actual
        button.classList.toggle('active');
        const panel = button.nextElementSibling;
        if (panel.style.maxHeight) {
            panel.style.maxHeight = null;
        } else {
            panel.style.maxHeight = panel.scrollHeight + "px";
        }
    }

    // Adjuntar la lógica de acordeón a todos los botones
    document.querySelectorAll('.accordion').forEach(button => {
        button.addEventListener('click', () => {
             // Si el botón es el dashboard, solo navegamos, si no, lo manejamos con el toggle
            if (button.innerText.includes('Dashboard')) {
                nav('dashboard');
            }
            toggleAccordion(button);
        });
    });

    // ————— Local Storage —————
    function saveData(){
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ inventario, categorias, tiendas, pendingOps }));
    }
    function loadData(){
        const data = localStorage.getItem(STORAGE_KEY);
        if(data){
            const parsed = JSON.parse(data);
            inventario = parsed.inventario || [];
            categorias = parsed.categorias || [];
            tiendas = parsed.tiendas || [];
            pendingOps = parsed.pendingOps || [];
        }
    }

    // ————— Fetch inicial desde Sheets —————
    async function fetchSheet(sheet){
        try {
            // Usa 'sheet' en minúscula para el parámetro
            const res = await fetch(`${APPWEB_URL}?sheet=${sheet}&action=get&t=${Date.now()}`); 
            const json = await res.json();
            
            // Mapeo adaptado a la respuesta del Apps Script
            return json.map(row => ({
                idSheet: row.id, // Usamos 'id' de la respuesta del Apps Script
                nombre: row.nombre || row.Nombre || row.Categoria || row.Tienda || '',
                Codigo: row.Codigo || '',
                Serie: row.Serie || '',
                Equipo: row.Equipo || '',
                Marca: row.Marca || '',
                Modelo: row.Modelo || '',
                Categoria: row.Categoria || '',
                Tienda: row.Tienda || ''
            }));
        } catch(e) {
            console.warn(`Error fetchSheet (${sheet}):`, e);
            return [];
        }
    }

    async function loadInitialData(){
        const [inv, cat, td] = await Promise.all([
            fetchSheet('inventario'), // Usa minúsculas para el parámetro
            fetchSheet('categoria'),
            fetchSheet('tienda')
        ]);
        inventario = inv;
        categorias = cat;
        tiendas = td;
        // No limpiamos pendingOps aquí, ya que pueden ser operaciones no sincronizadas antes del reinicio
        saveData();
        render(); // Render con la data fresca
    }

    // ————— Sincronización (CORRECCIÓN DE ERROR "append") —————
    async function syncItem(tipo, item, action){
        // Usa el parámetro 'tipo' en minúsculas para el sheet
        const sheet = (tipo === 'inventario') ? 'inventario' : (tipo === 'categoria' ? 'categoria' : 'tienda');
        
        // CORRECCIÓN: Creamos el objeto params paso a paso para evitar el error de append
        const params = new URLSearchParams();
        params.append('sheet', sheet);
        params.append('action', action);

        if(action === 'add'){
            Object.keys(item).forEach(k => {
                // Excluimos idLocal (temporal) e idSheet (aún nulo)
                if(k !== 'idLocal' && k !== 'idSheet') params.append(k, item[k] || '');
            });
        } else if(action === 'update' || action === 'delete'){
            // Usamos idSheet para identificar la fila en Google Sheets
            params.append('idCol', 'id').append('idValue', item.idSheet); 
            if(action === 'update'){
                Object.keys(item).forEach(k => {
                    // Solo enviamos los campos de valor para actualizar
                    if(k !== 'idLocal' && k !== 'idSheet'){
                        params.append(k, item[k] || '');
                    }
                });
            }
        }
        
        try {
            // Usamos POST para todas las operaciones de escritura (ADD, UPDATE, DELETE)
            const res = await fetch(`${APPWEB_URL}?${params.toString()}`, {method: 'POST'});
            const data = await res.json();
            
            if(data.success && action === 'add' && data.id){
                item.idSheet = data.id;
                replaceLocalId(item); 
            }
            return data.success; // Devuelve el estado de éxito del servidor
        } catch (e) {
            console.warn("syncItem error:", e);
            return false;
        }
    }

    function replaceLocalId(item){
        const arr = (item.Equipo !== undefined) ? inventario : (item.Tienda !== undefined ? tiendas : categorias);
        let idx = arr.findIndex(r => r.idLocal === item.idLocal);
        if(idx >= 0 && arr[idx].idLocal === item.idLocal){
            arr[idx].idSheet = item.idSheet;
            delete arr[idx].idLocal;
        }
    }

    async function syncPending(){
        if(pendingOps.length === 0) return;
        
        let successfulOps = [];
        for(let op of pendingOps){
            // El item en pendingOps ya tiene el idSheet/idLocal, lo pasamos para la sync
            const success = await syncItem(op.tipo, op.item, op.action);
            if(success){
                successfulOps.push(op);
            }
        }
        
        // Eliminar solo las operaciones exitosas
        pendingOps = pendingOps.filter(p => !successfulOps.includes(p));
        saveData();
        render(); // Actualiza el dashboard para reflejar el cambio en pendingOps
    }

    // ————— Modal / Formulario —————
    function openAddForm(tipo, index = null){
        editItemIndex = index;
        document.getElementById('modal').style.display = 'flex';
        const titleEl = document.getElementById('modal-title');
        const form = document.getElementById('modal-form');
        form.innerHTML = '';
        form.dataset.tipo = tipo;

        if(tipo === 'inventario'){
            titleEl.innerText = (index !== null ? 'Editar' : 'Agregar') + ' Inventario';
            const fields = ['Codigo','Serie','Equipo','Marca','Modelo'];
            fields.forEach(k => {
                const inp = document.createElement('input');
                inp.placeholder = k;
                inp.id = 'f_' + k;
                form.appendChild(inp);
            });
            
            // Combobox Categoría
            const catSel = document.createElement('select');
            catSel.id = 'f_Categoria';
            catSel.innerHTML = '<option value="">Seleccione Categoría</option>';
            categorias.forEach(c => {
                catSel.innerHTML += `<option value="${c.nombre}">${c.nombre}</option>`;
            });
            form.appendChild(catSel);
            
            // Combobox Tienda
            const tSel = document.createElement('select');
            tSel.id = 'f_Tienda';
            tSel.innerHTML = '<option value="">Seleccione Tienda</option>';
            tiendas.forEach(t => {
                tSel.innerHTML += `<option value="${t.nombre}">${t.nombre}</option>`;
            });
            form.appendChild(tSel);
            
            // Llenar data si es edición
            if(index !== null){
                const item = inventario[index];
                fields.forEach(k => document.getElementById('f_' + k).value = item[k] || '');
                catSel.value = item.Categoria || '';
                tSel.value = item.Tienda || '';
            }

        } else {
            const name = tipo.charAt(0).toUpperCase() + tipo.slice(1);
            titleEl.innerText = (index !== null ? 'Editar' : 'Agregar') + ' ' + name;
            const inp = document.createElement('input');
            inp.placeholder = 'Nombre de la ' + name;
            inp.id = 'f_nombre';
            form.appendChild(inp);
            
            // Llenar data si es edición
            if(index !== null){
                const item = tipo === 'categoria' ? categorias[index] : tiendas[index];
                document.getElementById('f_nombre').value = item.nombre || '';
            }
        }
    }

    function closeModal(){
        document.getElementById('modal').style.display = 'none';
        editItemIndex = null;
    }

    function saveItem(){
        const form = document.getElementById('modal-form');
        const tipo = form.dataset.tipo;
        let obj = {};
        const isEditing = editItemIndex !== null;

        let arr;
        if(tipo === 'inventario') arr = inventario;
        else if(tipo === 'categoria') arr = categorias;
        else arr = tiendas;

        const itemBase = isEditing ? arr[editItemIndex] : {};
            
        if(tipo === 'inventario'){
            obj = {
                idSheet: itemBase.idSheet || null, 
                idLocal: itemBase.idLocal || null,
                Codigo: document.getElementById('f_Codigo').value,
                Serie: document.getElementById('f_Serie').value,
                Equipo: document.getElementById('f_Equipo').value,
                Marca: document.getElementById('f_Marca').value,
                Modelo: document.getElementById('f_Modelo').value,
                Categoria: document.getElementById('f_Categoria').value,
                Tienda: document.getElementById('f_Tienda').value
            };
        } else {
            obj = {
                idSheet: itemBase.idSheet || null,
                idLocal: itemBase.idLocal || null,
                nombre: document.getElementById('f_nombre').value
            };
        }
            
        if(isEditing) arr[editItemIndex] = obj;
        else {
            obj.idLocal = crypto.randomUUID(); // ID temporal para el local storage
            arr.push(obj);
        }

        // Agregar a operaciones pendientes
        const action = isEditing ? 'update' : 'add';
        pendingOps.push({ tipo, action, item: obj });
        
        saveData();
        render();
        closeModal();
    }

    // ————— Edit / Delete —————
    function editItemFunc(tipo, index){
        openAddForm(tipo, index);
    }

    function deleteItem(tipo, index){
        if(!confirm('¿Eliminar este registro?')) return;
        
        const arr = (tipo === 'inventario' ? inventario : (tipo === 'categoria' ? categorias : tiendas));
        const item = arr[index];
        
        if(item.idSheet){
            // Solo se intenta sincronizar si el ítem ya existe en Sheets
            pendingOps.push({ tipo, action: 'delete', item: item });
        }
        
        // Quitar de la matriz local
        arr.splice(index, 1); 
        
        saveData();
        render();
    }

    // ————— Búsqueda (Filtro) —————
    function applySearch(query){
        currentSearch = query.toLowerCase().trim();
        render();
    }

    function filterData(arr){
        if (!currentSearch) return arr;
        
        // Filtra buscando la cadena en cualquier valor de la propiedad del objeto
        return arr.filter(item => {
            return Object.values(item).some(value => 
                (value || '').toString().toLowerCase().includes(currentSearch)
            );
        });
    }

    // ————— Render —————
    function render(){
        const c = document.getElementById('content');
        const titleEl = document.getElementById('main-title');
        c.innerHTML = '';

        if(currentView === 'dashboard'){
            titleEl.innerText = 'Dashboard de Inventario';
            const cards = document.createElement('div');
            cards.className = 'cards';
            
            const createCard = (label, count, view, icon, color = '#ff4d00', bgColor = 'white') => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.color = color;
                card.style.backgroundColor = bgColor;
                card.innerHTML = `<i class="fa-solid ${icon}"></i><span>${label}: ${count}</span>`;
                card.onclick = () => nav(view);
                return card;
            };

            cards.appendChild(createCard('Equipos', inventario.length, 'inventario', 'fa-computer'));
            cards.appendChild(createCard('Categorías', categorias.length, 'categoria', 'fa-tags'));
            cards.appendChild(createCard('Tiendas', tiendas.length, 'tienda', 'fa-store'));
            
            const pendingCount = pendingOps.length;
            const pendingCard = createCard(
                'Pendientes', 
                pendingCount, 
                'dashboard', 
                pendingCount > 0 ? 'fa-sync-alt fa-spin' : 'fa-check-circle', 
                pendingCount > 0 ? '#cc3c00' : '#28a745',
                pendingCount > 0 ? '#fff0e0' : 'white'
            );
            pendingCard.onclick = syncPending; 
            cards.appendChild(pendingCard);
            
            c.appendChild(cards);
        } else {
            // Configurar Barra de Búsqueda
            const searchBar = document.createElement('div');
            searchBar.className = 'search-bar';
            searchBar.innerHTML = `<input type="text" id="search-input" placeholder="Buscar en tabla..." onkeyup="applySearch(this.value)" value="${currentSearch}">`;
            c.appendChild(searchBar);
            
            let arr = [];
            let headers = [];
            let tipoTitle = '';

            if(currentView === 'inventario'){
                titleEl.innerText = 'Ver Inventario';
                arr = filterData(inventario);
                headers = ['ID', 'Código', 'Serie', 'Equipo', 'Marca', 'Modelo', 'Categoría', 'Tienda', 'Acciones'];
                tipoTitle = 'inventario';
            } else if(currentView === 'categoria'){
                titleEl.innerText = 'Ver Categorías';
                arr = filterData(categorias);
                headers = ['ID', 'Nombre', 'Acciones'];
                tipoTitle = 'categoria';
            } else if(currentView === 'tienda'){
                titleEl.innerText = 'Ver Tiendas';
                arr = filterData(tiendas);
                headers = ['ID', 'Nombre', 'Acciones'];
                tipoTitle = 'tienda';
            }

            const tbl = document.createElement('table');
            tbl.innerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
            
            const tb = document.createElement('tbody');
            arr.forEach((item, idx) => {
                const tr = document.createElement('tr');
                
                let cells = [];
                // Determina si el registro está sincronizado (tiene idSheet) o pendiente (idLocal)
                const idDisplay = item.idSheet || (item.idLocal ? `PENDIENTE (${item.idLocal.slice(0, 4)}...)` : 'ERROR');

                if(currentView === 'inventario'){
                    cells = [
                        idDisplay,
                        item.Codigo, item.Serie, item.Equipo, item.Marca, item.Modelo, item.Categoria, item.Tienda
                    ];
                } else {
                    cells = [idDisplay, item.nombre];
                }
                
                const dataCells = cells.map(cell => `<td>${cell}</td>`).join('');
                
                // Necesitamos el índice original en la matriz global (inventario, categorias, tiendas)
                // Usamos findIndex para obtener el índice real del elemento filtrado, ya que idx es solo el índice en el array filtrado.
                const realIndex = (tipoTitle === 'inventario' ? inventario : (tipoTitle === 'categoria' ? categorias : tiendas)).findIndex(i => i.idSheet === item.idSheet || i.idLocal === item.idLocal);

                tr.innerHTML = `${dataCells}
                    <td class="actions">
                        <button class="btn-edit" onclick="editItemFunc('${tipoTitle}',${realIndex})"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-del" onclick="deleteItem('${tipoTitle}',${realIndex})"><i class="fa-solid fa-trash"></i></button>
                    </td>`;
                tb.appendChild(tr);
            });
            
            tbl.appendChild(tb);
            c.appendChild(tbl);
        }
    }

    // ————— Navegación —————
    function nav(view){
        currentView = view;
        currentSearch = ''; // Limpia la búsqueda al cambiar de vista
        
        // Activa el acordeón correspondiente al navegar
        const viewToButtonMap = {
            'dashboard': document.querySelector('.menu-section .accordion i.fa-house').closest('button'),
            'inventario': document.querySelector('.menu-section .accordion i.fa-computer').closest('button'),
            'categoria': document.querySelector('.menu-section .accordion i.fa-tags').closest('button'),
            'tienda': document.querySelector('.menu-section .accordion i.fa-store').closest('button')
        };

        const targetButton = viewToButtonMap[view];
        if (targetButton) {
            // Asegura que el botón esté activo y el panel abierto
            toggleAccordion(targetButton); 
        }

        render();
    }

    // ————— Inicialización —————
    loadData();          // 1. Carga la data local (para un inicio rápido)
    nav(currentView);    // 2. Renderiza la vista inicial (Dashboard por defecto)

    // 3. Carga la data real desde la webapp, guarda y re-renderiza
    loadInitialData(); 

    // 4. Inicia el proceso de sincronización automática cada 10 segundos
    setInterval(syncPending, 10000); 
</script>

</body>
</html>
