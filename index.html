<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Inventario Tiendas 3A</title>
<!-- Font Awesome para iconos -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<style>
/* Estilos (sin modificar tu diseño) */
body, html { margin:0; padding:0; font-family:sans-serif; background:#f7f7f7; }
* { box-sizing:border-box; }

/* Sidebar (Menú Lateral) */
.sidebar { width:260px; position:fixed; height:100%; background:#ff4d00; color:white; display:flex; flex-direction:column; gap:12px; padding:20px; transition:0.3s; overflow-y:auto; z-index:10; }
.sidebar.collapsed { width:60px; padding:20px 5px; }
.brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.2rem; position:relative; margin-bottom:10px; }
#toggleSidebar { position:absolute; right:0; top:0; background:#cc3c00; color:white; border:none; border-radius:6px; padding:4px 8px; cursor:pointer; }

/* Acordeón */
.menu-section { width:100%; }
.menu-section .accordion { background:transparent; color:white; border:none; padding:10px; width:100%; display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:600; justify-content:space-between; transition:0.2s; border-radius:4px; }
.menu-section .accordion.active, .menu-section .accordion:hover { background-color:#e64500; }
.menu-section .panel { padding:0 10px; max-height:0; overflow:hidden; transition:max-height 0.28s ease-in-out; background-color:#e64500; display:flex; flex-direction:column; gap:4px; }
.menu-section .panel button { background:transparent; color:white; border:none; padding:8px; text-align:left; display:flex; align-items:center; gap:6px; cursor:pointer; width:100%; border-radius:4px; }
.menu-section .panel button:hover { background-color:#cc4000; }
.sidebar.collapsed .brand span, .sidebar.collapsed .menu-section .accordion span, .sidebar.collapsed .panel button span { display:none; }
.sidebar.collapsed .accordion { justify-content:center; }
.sidebar.collapsed .accordion i.fa-chevron-down { display:none; }

/* Contenido Principal */
.main { margin-left:260px; padding:20px; transition:0.3s; }
.sidebar.collapsed ~ .main { margin-left:60px; }

/* Cards */
.cards { display:flex; gap:20px; margin-top:20px; flex-wrap:wrap; }
.card { flex:1; min-width:150px; background:white; color:#ff4d00; padding:20px; border-radius:12px; text-align:center; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.1); transition:0.2s; }
.card:hover{ transform:translateY(-3px); box-shadow:0 6px 12px rgba(0,0,0,0.15); }
.card span{ font-weight:700; font-size:1.3rem; display:block; margin-top:5px; }
.card i{ font-size:2rem; }

/* Búsqueda */
.search-bar{ margin-bottom:15px; display:flex; gap:10px; }
.search-bar input{ flex-grow:1; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:1rem; }

/* Tablas */
table{ width:100%; border-collapse:collapse; margin-top:20px; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); display:block; overflow-x:auto; white-space:nowrap; }
th, td{ border:1px solid #eee; padding:10px; text-align:center; font-size:0.9rem; }
th{ background:#ff4d00; color:white; font-weight:600; }
tr:nth-child(even){ background-color:#f9f9f9; }
.actions button{ margin:0 2px; padding:6px; border-radius:50%; border:none; cursor:pointer; width:32px; height:32px; transition:0.1s; }
.actions button:hover{ opacity:0.8; }
.btn-edit{ background:#ffb86b; color:white; }
.btn-del{ background:#d9534f; color:white; }

/* Modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:50; }
.modal{ background:white; padding:25px; border-radius:12px; width:450px; max-width:95%; box-shadow:0 10px 20px rgba(0,0,0,0.2); }
input, select, datalist { padding:10px; border-radius:6px; border:1px solid #ccc; width:100%; margin-bottom:12px; font-size:1rem; }
.modal button{ padding:8px 15px; border-radius:6px; cursor:pointer; border:none; font-weight:600; transition:0.1s; }
.modal button:last-child{ background:#ff4d00; color:white; }
.modal button:last-child:hover{ background:#cc3c00; }
.modal button:first-child{ background:#eee; color:#333; margin-right:10px; }
.modal button:first-child:hover{ background:#ddd; }

/* Responsive */
@media(max-width:768px){
  .cards{ flex-direction:column; }
  .card{ min-width:100%; }
  .sidebar{ left:-260px; position:fixed; }
  .sidebar.collapsed{ left:0; }
  .main{ margin-left:0; padding:10px; }
  .search-bar input{ font-size:0.9rem; padding:8px; }
  table{ display:block; }
  th, td{ display:table-cell; }
}
</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="brand">
    <i class="fa-solid fa-boxes-stacked"></i><span>Inventario 3A</span>
    <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
  </div>

  <div class="menu-section">
    <button class="accordion active"><i class="fa-solid fa-house"></i><span>Dashboard</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel" style="max-height:500px;">
      <button onclick="nav('dashboard')"><i class="fa-solid fa-gauge-high"></i><span>Ver Dashboard</span></button>
    </div>
  </div>

  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-computer"></i><span>Inventario</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('inventario')"><i class="fa-solid fa-plus"></i><span>Agregar Inventario</span></button>
      <button onclick="nav('inventario')"><i class="fa-solid fa-table"></i><span>Ver Inventario</span></button>
    </div>
  </div>

  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-tags"></i><span>Categorías</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('categoria')"><i class="fa-solid fa-plus"></i><span>Agregar Categoría</span></button>
      <button onclick="nav('categoria')"><i class="fa-solid fa-table"></i><span>Ver Categorías</span></button>
    </div>
  </div>

  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-store"></i><span>Tiendas</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('tienda')"><i class="fa-solid fa-plus"></i><span>Agregar Tienda</span></button>
      <button onclick="nav('tienda')"><i class="fa-solid fa-table"></i><span>Ver Tiendas</span></button>
    </div>
  </div>
</aside>

<div class="main">
  <h2 id="main-title">Inventario de Tienda</h2>
  <div id="content"></div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h3 id="modal-title"></h3>
    <div id="modal-form"></div>

    <div style="text-align:right; margin-top:15px;">
      <button onclick="closeModal()">Cancelar</button>
      <button onclick="saveItem()">Guardar</button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const APPWEB_URL = "https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";
let inventario = [], categorias = [], tiendas = [], pendingOps = [];
let editItemIndex = null;
let currentView = 'dashboard';
let currentSearch = '';
const STORAGE_KEY = 'inventario3a';
/* ========================================== */

/* --- Sidebar & acordeón (funcional y estable) --- */
document.getElementById('toggleSidebar').onclick = () => document.getElementById('sidebar').classList.toggle('collapsed');

function toggleAccordion(button){
  const panel = button.nextElementSibling;
  const active = button.classList.contains('active');

  // cerrar todas menos la seleccionada
  document.querySelectorAll('.accordion').forEach(acc => {
    if(acc !== button){
      acc.classList.remove('active');
      if(acc.nextElementSibling) acc.nextElementSibling.style.maxHeight = null;
    }
  });

  if(active){
    button.classList.remove('active');
    panel.style.maxHeight = null;
  } else {
    button.classList.add('active');
    panel.style.maxHeight = panel.scrollHeight + "px";
  }
}
document.querySelectorAll('.accordion').forEach(btn => btn.addEventListener('click', () => toggleAccordion(btn)));

/* --- localStorage helpers --- */
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({ inventario, categorias, tiendas, pendingOps })); }
function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const parsed = JSON.parse(raw);
    inventario = parsed.inventario || [];
    categorias = parsed.categorias || [];
    tiendas = parsed.tiendas || [];
    pendingOps = parsed.pendingOps || [];
  }catch(e){
    console.warn('loadData parse error', e);
  }
}

/* --- fetch from Google Apps Script (sólo lectura) --- */
async function fetchSheet(sheet){
  try{
    const res = await fetch(`${APPWEB_URL}?sheet=${sheet}&action=get&t=${Date.now()}`);
    const json = await res.json();
    return (Array.isArray(json) ? json : []).map(row => ({
      idSheet: row.id || '',
      nombre: row.nombre || row.Categoria || row.Tienda || '',
      Codigo: row.Codigo || '',
      Serie: row.Serie || '',
      Equipo: row.Equipo || '',
      Marca: row.Marca || '',
      Modelo: row.Modelo || '',
      Categoria: row.Categoria || '',
      Tienda: row.Tienda || ''
    }));
  }catch(e){
    console.warn('fetchSheet error', e);
    return [];
  }
}

async function loadInitialData(){
  // cargamos sólo si no hay datos locales o para refrescar
  const [inv, cat, td] = await Promise.all([
    fetchSheet('inventario'),
    fetchSheet('categoria'),
    fetchSheet('tienda')
  ]);
  // respetamos items locales pendientes: solo sobrescribimos si arrays estan vacíos
  if(inventario.length === 0) inventario = inv;
  if(categorias.length === 0) categorias = cat;
  if(tiendas.length === 0) tiendas = td;
  saveData();
  render();
}

/* --- syncItem / syncPending (guarda en segundo plano) --- */
async function syncItem(tipo, item, action){
  if(!item) return false;
  const sheet = (tipo === 'inventario') ? 'inventario' : (tipo === 'categoria' ? 'categoria' : 'tienda');
  const params = new URLSearchParams();
  params.append('sheet', sheet);
  params.append('action', action);

  // campos
  const fields = (tipo === 'inventario') ? ['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda'] : ['nombre'];

  if(action === 'update' || action === 'delete'){
    if(!item.idSheet){
      // si no hay idSheet para update/delete, lo ignoramos (probablemente local-only)
      return true;
    }
    params.append('idCol','id');
    params.append('idValue', item.idSheet);
  }

  if(action === 'add' || action === 'update'){
    fields.forEach(k => params.append(k, item[k] || ''));
  }

  try{
    const res = await fetch(`${APPWEB_URL}?${params.toString()}`, { method: 'POST' });
    const data = await res.json();
    if(data && data.success && action === 'add' && data.id){
      // asignar idSheet devuelto por server
      item.idSheet = data.id;
      // si el item tenía idLocal, sincronizamos el objeto en el array correcto
      replaceLocalId(item);
    }
    return data && !!data.success;
  }catch(e){
    console.warn('syncItem error', e);
    return false;
  }
}

function replaceLocalId(item){
  const arr = (item.Equipo !== undefined) ? inventario : (item.Tienda !== undefined ? tiendas : categorias);
  const idx = arr.findIndex(r => r.idLocal && item.idLocal && r.idLocal === item.idLocal);
  if(idx >= 0){
    arr[idx].idSheet = item.idSheet;
    delete arr[idx].idLocal;
    saveData();
  }
}

let syncing = false;
async function syncPending(){
  if(syncing) return;
  if(pendingOps.length === 0) return;
  syncing = true;
  try{
    const newPending = [];
    for(const op of pendingOps){
      // si es update/delete y no tiene idSheet, saltarlo (se consideró local-only)
      if((op.action === 'update' || op.action === 'delete') && !op.item.idSheet){
        // omitimos
        continue;
      }
      const ok = await syncItem(op.tipo, op.item, op.action);
      if(!ok) newPending.push(op);
    }
    pendingOps = newPending;
    saveData();
    render();
  } finally {
    syncing = false;
  }
}

/* --- Render (optimizado con DocumentFragment) --- */
function filterData(arr){
  if(!currentSearch) return arr;
  const q = currentSearch.toLowerCase();
  return arr.filter(item => Object.values(item).some(v => (v||'').toString().toLowerCase().includes(q)));
}

function render(){
  const container = document.getElementById('content');
  container.innerHTML = '';
  const titleEl = document.getElementById('main-title');

  // DASHBOARD
  if(currentView === 'dashboard'){
    titleEl.innerText = 'Dashboard de Inventario';
    const frag = document.createDocumentFragment();
    const cards = document.createElement('div'); cards.className = 'cards';

    const createCard = (label, count, view, icon) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<i class="fa-solid ${icon}"></i><span>${label}: ${count}</span>`;
      card.onclick = () => nav(view);
      return card;
    };

    cards.appendChild(createCard('Equipos', inventario.length, 'inventario', 'fa-computer'));
    cards.appendChild(createCard('Categorías', categorias.length, 'categoria', 'fa-tags'));
    cards.appendChild(createCard('Tiendas', tiendas.length, 'tienda', 'fa-store'));
    cards.appendChild(createCard('Pendientes', pendingOps.length, 'dashboard', pendingOps.length ? 'fa-sync-alt' : 'fa-check-circle'));

    frag.appendChild(cards);
    container.appendChild(frag);
    return;
  }

  // TABLA (Inventario / Categorías / Tiendas)
  const frag = document.createDocumentFragment();

  // Buscar
  const searchBar = document.createElement('div'); searchBar.className = 'search-bar';
  searchBar.innerHTML = `<input type="text" placeholder="Buscar..." value="${currentSearch}" onkeyup="applySearch(this.value)">`;
  frag.appendChild(searchBar);

  let arr = [], headers = [];
  if(currentView === 'inventario'){ titleEl.innerText = 'Ver Inventario'; arr = filterData(inventario); headers = ['ID','Código','Serie','Equipo','Marca','Modelo','Categoría','Tienda','Acciones']; }
  else if(currentView === 'categoria'){ titleEl.innerText = 'Ver Categorías'; arr = filterData(categorias); headers = ['ID','Nombre','Acciones']; }
  else { titleEl.innerText = 'Ver Tiendas'; arr = filterData(tiendas); headers = ['ID','Nombre','Acciones']; }

  const table = document.createElement('table');
  table.innerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
  const tbody = document.createElement('tbody');

  // Construir filas (DOM nodes para mejor performance)
  for(const item of arr){
    const tr = document.createElement('tr');

    const idDisplay = item.idSheet ? item.idSheet : (item.idLocal ? `<span style="color:red; font-weight:700;">PENDIENTE</span>` : '<span style="color:orange;">NUEVO</span>');

    if(currentView === 'inventario'){
      const cells = [idDisplay, item.Codigo || '', item.Serie || '', item.Equipo || '', item.Marca || '', item.Modelo || '', item.Categoria || '', item.Tienda || ''];
      for(const cell of cells){
        const td = document.createElement('td');
        td.innerHTML = cell;
        tr.appendChild(td);
      }
    } else {
      const tdId = document.createElement('td'); tdId.innerHTML = idDisplay; tr.appendChild(tdId);
      const tdName = document.createElement('td'); tdName.textContent = item.nombre || ''; tr.appendChild(tdName);
    }

    // acciones (encontrar índice real en el array global)
    const globalArr = (currentView === 'inventario') ? inventario : (currentView === 'categoria' ? categorias : tiendas);
    const realIndex = globalArr.findIndex(i => (i.idSheet && item.idSheet && i.idSheet === item.idSheet) || (i.idLocal && item.idLocal && i.idLocal === item.idLocal));
    const tdActions = document.createElement('td'); tdActions.className = 'actions';

    const btnEdit = document.createElement('button'); btnEdit.className = 'btn-edit';
    btnEdit.innerHTML = '<i class="fa-solid fa-pen"></i>';
    btnEdit.onclick = () => editItemFunc(currentView, realIndex);

    const btnDel = document.createElement('button'); btnDel.className = 'btn-del';
    btnDel.innerHTML = '<i class="fa-solid fa-trash"></i>';
    btnDel.onclick = () => deleteItem(currentView, realIndex);

    tdActions.appendChild(btnEdit);
    tdActions.appendChild(btnDel);
    tr.appendChild(tdActions);

    tbody.appendChild(tr);
  }

  table.appendChild(tbody);
  frag.appendChild(table);
  container.appendChild(frag);
}

/* --- Navegación que abre acordeón correspondiente --- */
function nav(view){
  currentView = view;
  currentSearch = '';

  // expandir acordeón relacionado
  document.querySelectorAll('.accordion').forEach(acc => {
    const span = acc.querySelector('span')?.innerText?.toLowerCase() || '';
    const matches = (view === 'dashboard' && span === 'dashboard') ||
                    (view === 'inventario' && span === 'inventario') ||
                    (view === 'categoria' && span === 'categorías') ||
                    (view === 'tienda' && span === 'tiendas');
    if(matches){
      if(!acc.classList.contains('active')) toggleAccordion(acc);
    } else {
      acc.classList.remove('active');
      if(acc.nextElementSibling) acc.nextElementSibling.style.maxHeight = null;
    }
  });

  render();
}

function applySearch(q){ currentSearch = q.toLowerCase().trim(); render(); }

/* --- Abrir formulario (Agregar / Editar). Combobox con datalist para permitir escribir + ver opciones) --- */
function openAddForm(tipo, index = null){
  editItemIndex = (index !== null) ? index : null;
  document.getElementById('modal').style.display = 'flex';
  const titleEl = document.getElementById('modal-title');
  const form = document.getElementById('modal-form');
  form.innerHTML = '';
  form.dataset.tipo = tipo;

  if(tipo === 'inventario'){
    titleEl.innerText = (index !== null ? 'Editar' : 'Agregar') + ' Inventario';

    // Crear inputs
    const fields = ['Codigo','Serie','Equipo','Marca','Modelo'];
    fields.forEach(k => {
      const inp = document.createElement('input');
      inp.placeholder = k;
      inp.id = 'f_' + k;
      form.appendChild(inp);
    });

    // datalist para categorias
    const catInput = document.createElement('input');
    catInput.setAttribute('list','d_cats');
    catInput.id = 'f_Categoria';
    catInput.placeholder = 'Categoria';
    form.appendChild(catInput);
    const dCats = document.createElement('datalist');
    dCats.id = 'd_cats';
    categorias.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.nombre;
      dCats.appendChild(opt);
    });
    form.appendChild(dCats);

    // datalist para tiendas
    const tInput = document.createElement('input');
    tInput.setAttribute('list','d_tiendas');
    tInput.id = 'f_Tienda';
    tInput.placeholder = 'Tienda';
    form.appendChild(tInput);
    const dTds = document.createElement('datalist');
    dTds.id = 'd_tiendas';
    tiendas.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.nombre;
      dTds.appendChild(opt);
    });
    form.appendChild(dTds);

    // si editando, llenar valores
    if(index !== null){
      const item = inventario[index] || {};
      fields.forEach(k => {
        const el = document.getElementById('f_' + k);
        if(el) el.value = item[k] || '';
      });
      catInput.value = item.Categoria || '';
      tInput.value = item.Tienda || '';
    }
  } else {
    // Categoria o Tienda
    const name = tipo.charAt(0).toUpperCase() + tipo.slice(1);
    titleEl.innerText = (index !== null ? 'Editar ' : 'Agregar ') + name;
    const inp = document.createElement('input');
    inp.placeholder = 'Nombre';
    inp.id = 'f_nombre';
    form.appendChild(inp);

    if(index !== null){
      const item = (tipo === 'categoria') ? categorias[index] : tiendas[index];
      if(item) inp.value = item.nombre || '';
    }
  }
}

/* --- Editar (abre el formulario y coloca datos) --- */
function editItemFunc(tipo, index){
  if(index === -1 || index === undefined || index === null){
    console.warn('editItemFunc: índice inválido', tipo, index);
    return;
  }
  openAddForm(tipo, index);
}

/* --- Cerrar modal --- */
function closeModal(){
  document.getElementById('modal').style.display = 'none';
  editItemIndex = null;
}

/* --- Guardar item (local primero, luego pendingOps para sync) --- */
function saveItem(){
  const form = document.getElementById('modal-form');
  const tipo = form.dataset.tipo;
  const isEditing = editItemIndex !== null;
  let arr = (tipo === 'inventario') ? inventario : (tipo === 'categoria' ? categorias : tiendas);

  if(tipo === 'inventario'){
    const obj = {
      idSheet: isEditing ? (arr[editItemIndex] && arr[editItemIndex].idSheet ? arr[editItemIndex].idSheet : null) : null,
      idLocal: isEditing ? (arr[editItemIndex] && arr[editItemIndex].idLocal ? arr[editItemIndex].idLocal : null) : crypto.randomUUID(),
      Codigo: document.getElementById('f_Codigo').value.trim(),
      Serie: document.getElementById('f_Serie').value.trim(),
      Equipo: document.getElementById('f_Equipo').value.trim(),
      Marca: document.getElementById('f_Marca').value.trim(),
      Modelo: document.getElementById('f_Modelo').value.trim(),
      Categoria: document.getElementById('f_Categoria').value.trim(),
      Tienda: document.getElementById('f_Tienda').value.trim()
    };

    if(isEditing){
      // no cambiar idSheet, sólo campos
      arr[editItemIndex] = Object.assign({}, arr[editItemIndex], obj);
      pendingOps.push({ tipo, action: 'update', item: arr[editItemIndex] });
    } else {
      arr.push(obj);
      pendingOps.push({ tipo, action: 'add', item: obj });
    }
  } else {
    const obj = {
      idSheet: isEditing ? (arr[editItemIndex] && arr[editItemIndex].idSheet ? arr[editItemIndex].idSheet : null) : null,
      idLocal: isEditing ? (arr[editItemIndex] && arr[editItemIndex].idLocal ? arr[editItemIndex].idLocal : crypto.randomUUID()) : crypto.randomUUID(),
      nombre: document.getElementById('f_nombre').value.trim()
    };

    if(isEditing){
      arr[editItemIndex] = Object.assign({}, arr[editItemIndex], obj);
      pendingOps.push({ tipo, action: 'update', item: arr[editItemIndex] });
    } else {
      arr.push(obj);
      pendingOps.push({ tipo, action: 'add', item: obj });
    }
  }

  saveData();
  render();
  closeModal();

  // sincronizar en segundo plano (rápido)
  setTimeout(syncPending, 200);
}

/* --- Eliminar --- */
function deleteItem(tipo, index){
  if(index === -1 || index === undefined || index === null){
    console.warn('deleteItem: índice inválido', tipo, index);
    return;
  }
  if(!confirm('¿Eliminar este registro?')) return;

  const arr = (tipo === 'inventario') ? inventario : (tipo === 'categoria' ? categorias : tiendas);
  const item = arr[index];
  if(item && item.idSheet){
    pendingOps.push({ tipo, action: 'delete', item: item });
  }
  arr.splice(index, 1);
  saveData();
  render();

  // intentar sincronizar rápido
  setTimeout(syncPending, 200);
}

/* --- Inicialización --- */
loadData(); // load from local
nav(currentView);
loadInitialData(); // load remote if empty
// sincronizar periódicamente (segundo plano)
setInterval(syncPending, 10000);
</script>

</body>
</html>
