const SS = SpreadsheetApp.getActiveSpreadsheet();

function capitalize(str) {
  if (!str) return null;
  const lowerStr = str.toLowerCase();
  if (lowerStr === "categoria") return "Categorias";
  if (lowerStr === "tienda") return "Tiendas";
  if (lowerStr === "inventario") return "Inventario";
  return null;
}

// === Manejo CORS ===
function outputJSON(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*");
}

function doGet(e) {
  const sheetName = capitalize(e.parameter.sheet);
  const action = e.parameter.action;
  if (!sheetName || action !== 'get') {
    return outputJSON({ success: false, msg: "Faltan parámetros 'sheet' o 'action' para GET." });
  }
  try {
    const data = readData(SS, sheetName);
    return outputJSON(data);
  } catch (error) {
    return outputJSON({ success: false, msg: "Error al leer datos: " + error.toString() });
  }
}

function doPost(e) {
  const params = e.parameter;
  const sheetName = capitalize(params.sheet);
  const action = params.action;
  if (!sheetName || !action) {
    return outputJSON({ success: false, msg: "Faltan parámetros 'sheet' o 'action' para POST." });
  }
  try {
    let result = { success: false, msg: "Acción no reconocida." };
    switch (action) {
      case 'add':
        result = addData(SS, sheetName, params);
        break;
      case 'update':
        if (!params.idCol || !params.idValue) {
          result = { success: false, msg: "Faltan parámetros de ID para UPDATE." };
        } else {
          result = updateData(SS, sheetName, params);
        }
        break;
      case 'delete':
        if (!params.idValue) {
          result = { success: false, msg: "Falta idValue para DELETE." };
        } else {
          result = deleteData(SS, sheetName, params.idValue);
        }
        break;
    }
    return outputJSON(result);
  } catch (error) {
    return outputJSON({ success: false, msg: "Error en el servidor: " + error.toString() });
  }
}

// === Leer datos ===
function readData(ss, sheetName) {
  const sh = ss.getSheetByName(sheetName);
  if (!sh) throw new Error("Hoja no encontrada: " + sheetName);
  const values = sh.getDataRange().getValues();
  if (values.length <= 1) return [];

  const headers = values[0];
  const data = [];

  for (let i = 1; i < values.length; i++) {
    const row = {};
    for (let j = 0; j < headers.length; j++) {
      if (sheetName === "Tiendas") { // mostrar código y nombre
        row[headers[j].toLowerCase()] = values[i][j];
      } else {
        if (headers[j].toLowerCase() === "id") continue;
        row[headers[j]] = values[i][j];
      }
    }
    data.push(row);
  }
  return data;
}

// === Agregar ===
function addData(ss, sheetName, params) {
  const sh = ss.getSheetByName(sheetName);
  if (!sh) return { success: false, msg: "Hoja no encontrada." };
  const headers = sh.getRange(1, 1, 1, sh.getLastColumn()).getValues()[0];

  const newRow = [];
  let newId = sh.getLastRow();
  if (sheetName !== "Tiendas" && headers[0].toLowerCase() === "id") newRow.push(newId);

  for (let i = sheetName==="Tiendas"?0:1; i < headers.length; i++) {
    const header = headers[i];
    newRow.push(params[header] || '');
  }

  if (newRow.slice(sheetName==="Tiendas"?0:1).every(v => v === "")) return { success: false, msg: "Fila vacía, no se insertó." };

  sh.appendRow(newRow);
  return { success: true, id: newId };
}

// === Editar ===
function updateData(ss, sheetName, params) {
  const sh = ss.getSheetByName(sheetName);
  if (!sh) return { success: false, msg: "Hoja no encontrada." };
  const headers = sh.getRange(1, 1, 1, sh.getLastColumn()).getValues()[0];

  const idValue = params.idValue;
  const idValues = sh.getRange(2, 1, sh.getLastRow() - 1, 1).getValues();
  const rowIndex = idValues.findIndex(row => row[0] == idValue);
  if (rowIndex === -1) return { success: false, msg: "ID no encontrado." };

  const sheetRow = rowIndex + 2;
  for (let i = 1; i < headers.length; i++) {
    const header = headers[i];
    if (params.hasOwnProperty(header)) sh.getRange(sheetRow, i + 1).setValue(params[header]);
  }
  return { success: true, msg: "Registro actualizado." };
}

// === Eliminar ===
function deleteData(ss, sheetName, idValue) {
  const sh = ss.getSheetByName(sheetName);
  if (!sh) return { success: false, msg: "Hoja no encontrada: " + sheetName };

  const idValues = sh.getRange(2, 1, sh.getLastRow() - 1, 1).getValues();
  const rowIndex = idValues.findIndex(row => row[0] == idValue);
  if (rowIndex === -1) return { success: false, msg: "ID no encontrado." };

  sh.deleteRow(rowIndex + 2);

  if (sheetName !== "Tiendas") {
    const headers = sh.getRange(1, 1, 1, sh.getLastColumn()).getValues()[0];
    if (headers[0].toLowerCase() === "id") {
      const totalRows = sh.getLastRow();
      for (let i = 2; i <= totalRows; i++) sh.getRange(i, 1).setValue(i - 1);
    }
  }

  return { success: true, msg: "Registro eliminado." };
}
