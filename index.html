<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
/* === ESTILOS GENERALES === */
body {
  font-family: 'Poppins', sans-serif;
  margin: 0;
  background: #f5f6fa;
  color: #333;
}
header {
  display: flex;
  align-items: center;
  background: #2f3640;
  color: white;
  padding: 10px 20px;
}
header h1 { flex: 1; font-size: 20px; }
#toggleSidebar { cursor: pointer; font-size: 20px; }
#sidebar {
  width: 220px; background: #353b48; height: 100vh;
  position: fixed; top: 0; left: 0; overflow-y: auto;
  transition: all 0.3s; padding-top: 60px;
}
#sidebar.collapsed { width: 0; overflow: hidden; }
#sidebar button {
  width: 100%; border: none; background: none; color: white;
  padding: 12px 20px; text-align: left; cursor: pointer;
}
#sidebar button:hover { background: #40739e; }
main { margin-left: 220px; padding: 20px; transition: all 0.3s; }
#sidebar.collapsed + main { margin-left: 0; }
.card {
  display: inline-flex; flex-direction: column; justify-content: center;
  align-items: center; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 15px; width: 180px; height: 130px;
  margin: 15px; cursor: pointer; transition: transform 0.2s;
}
.card:hover { transform: scale(1.05); }
.card i { font-size: 35px; color: #273c75; }
.card span { font-size: 22px; font-weight: bold; margin-top: 10px; }
.search-bar { margin: 10px 0; }
.search-bar input {
  width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc;
}
table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; }
th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
th { background: #273c75; color: white; }
.actions button {
  background: none; border: none; cursor: pointer; font-size: 16px;
}
.btn-edit i { color: #44bd32; }
.btn-del i { color: #e84118; }

/* === MODAL === */
#modal {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
}
#modal-content {
  background: white; padding: 20px; border-radius: 10px; width: 350px;
}
#modal-content input, #modal-content select {
  width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 6px; border: 1px solid #ccc;
}
.modal-actions { text-align: right; }
.modal-actions button {
  margin-left: 8px; padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer;
}
.btn-save { background: #44bd32; color: white; }
.btn-cancel { background: #e84118; color: white; }
</style>
</head>
<body>
<header>
  <i id="toggleSidebar" class="fa-solid fa-bars"></i>
  <h1 id="main-title">Dashboard</h1>
</header>

<div id="sidebar">
  <button onclick="renderDashboard()"> Dashboard</button>
  <button onclick="nav('inventario')"> Inventario</button>
  <button onclick="nav('categoria')"> Categor铆as</button>
  <button onclick="nav('tienda')"> Tiendas</button>
</div>

<main>
  <div id="dashboard-cards"></div>
  <div id="content"></div>
</main>

<!-- Modal -->
<div id="modal">
  <div id="modal-content">
    <h3 id="modal-title"></h3>
    <div id="modal-form"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn-save" onclick="saveItem()">Guardar</button>
    </div>
  </div>
</div>

<script>
const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxZYvau-tS7jCLqsNmwUkxK4wfkcL2AveUVJGUNKw2nPhFsMPt4Yw0dh-PYjsieW2j9HA/exec';
let dataStore = { inventario:[], categoria:[], tienda:[] };
let currentSheet = '';
let editingIndex = null;

// Sidebar
document.getElementById('toggleSidebar').addEventListener('click',()=>{ 
  document.getElementById('sidebar').classList.toggle('collapsed'); 
});

// Fetch Sheet
function fetchSheet(sheet){
  return new Promise((resolve,reject)=>{
    const cb = 'cb_'+Math.random().toString(36).substring(2,15);
    window[cb] = function(res){
      if(res.success){ dataStore[sheet]=res.data; resolve(res.data); }
      else reject(res.msg);
      delete window[cb];
    };
    const s = document.createElement('script');
    s.src = `${APP_SCRIPT_URL}?sheet=${sheet}&callback=${cb}`;
    s.onerror = ()=>reject('Error cargando datos');
    document.body.appendChild(s);
  });
}

// Render Table (oculta oldId)
function renderTable(sheet){
  currentSheet=sheet;
  document.getElementById('main-title').textContent = sheet.charAt(0).toUpperCase()+sheet.slice(1);
  document.getElementById('dashboard-cards').innerHTML='';
  const data = dataStore[sheet];
  let html = `<div class="search-bar"><input type="text" placeholder="Buscar..." oninput="filterTable(this.value)"></div>`;
  html += `<button class="btn-save" style="margin-bottom:10px" onclick="openAddForm('${sheet}')"><i class="fa-solid fa-plus"></i> Agregar</button>`;
  
  if(data.length>0){
    html += `<table><thead><tr>`;
    Object.keys(data[0]).forEach(h=>{
      if(h.toLowerCase()!=='oldid') html+=`<th>${h}</th>`;
    });
    html += `<th>Acciones</th></tr></thead><tbody>`;
    data.forEach((r,i)=>{
      html+=`<tr>`;
      Object.entries(r).forEach(([k,v])=>{
        if(k.toLowerCase()!=='oldid') html+=`<td>${v}</td>`;
      });
      html+=`<td class="actions">
        <button class="btn-edit" onclick="editItem(${i})"><i class="fa-solid fa-pen"></i></button>
        <button class="btn-del" onclick="deleteItem(${i})"><i class="fa-solid fa-trash"></i></button>
      </td></tr>`;
    });
    html+=`</tbody></table>`;
  } else html+=`<table><tr><td colspan="100%">No hay datos</td></tr></table>`;
  document.getElementById('content').innerHTML = html;
}

// Filter Table
function filterTable(value){
  const tbody = document.querySelector('tbody');
  if(!tbody) return;
  Array.from(tbody.rows).forEach(r=>
    r.style.display = Array.from(r.cells).some(c=>c.textContent.toLowerCase().includes(value.toLowerCase())) ? '' : 'none'
  );
}

// Modal Form
function openAddForm(sheet,index=null){
  currentSheet=sheet;
  editingIndex=index;
  document.getElementById('modal-title').textContent = index!==null?'Editar '+sheet:'Agregar '+sheet;
  let html='';
  const item=index!==null?dataStore[sheet][index]:{};

  if(sheet==='categoria'){
    html=`<input type="text" id="nombre" placeholder="Nombre de Categoria" value="${item.nombre||''}">`;
  } 
  else if(sheet==='tienda'){
    html=`<input type="text" id="codigo" placeholder="Codigo de Tienda" value="${item.codigo||''}">
          <input type="text" id="nombre" placeholder="Nombre de Tienda" value="${item.nombre||''}">`;
  } 
  else if(sheet==='inventario'){
    html=`<input type="text" id="codigo" placeholder="C贸digo" value="${item.codigo||''}">
          <input type="text" id="serie" placeholder="Serie" value="${item.serie||''}">
          <input type="text" id="equipo" placeholder="Equipo" value="${item.equipo||''}">
          <input type="text" id="marca" placeholder="Marca" value="${item.marca||''}">
          <input type="text" id="modelo" placeholder="Modelo" value="${item.modelo||''}">`;

    html+=`<select id="categoria"><option value="">Selecciona Categoria</option>`;
    dataStore.categoria.forEach(c=>{
      html+=`<option value="${c.nombre}" ${item.categoria===c.nombre?'selected':''}>${c.nombre}</option>`;
    });
    html+=`</select>`;

    html+=`<select id="tienda"><option value="">Selecciona Tienda</option>`;
    dataStore.tienda.forEach(t=>{
      html+=`<option value="${t.nombre}" ${item.tienda===t.nombre?'selected':''}>${t.nombre}</option>`;
    });
    html+=`</select>`;
  }

  document.getElementById('modal-form').innerHTML = html;
  document.getElementById('modal').style.display='flex';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }

// Save Item
function saveItem(){
  const form={};
  document.querySelectorAll('#modal-form input,#modal-form select').forEach(el=> form[el.id]=el.value.trim());

  if(currentSheet==='tienda' && (!form.codigo || !form.nombre)){ alert('Codigo y Nombre son obligatorios'); return; }
  if(currentSheet==='inventario' && form.codigo){
    if(dataStore.inventario.some((d,i)=>i!==editingIndex && d.codigo===form.codigo)){ alert('El c贸digo ya existe'); return; }
  }

  if(editingIndex===null){
    form.id = dataStore[currentSheet].length>0 ? Math.max(...dataStore[currentSheet].map(d=>Number(d.id)))+1 : 1;
  } else {
    form.id = dataStore[currentSheet][editingIndex].id;
  }

  if(editingIndex!==null){
    dataStore[currentSheet][editingIndex] = {...dataStore[currentSheet][editingIndex], ...form};
  } else {
    dataStore[currentSheet].push(form);
  }

  closeModal();
  renderTable(currentSheet);

  // Sincronizar con App Web
  let payload = {...form, sheet: currentSheet, action: editingIndex!==null?'update':'add'};
  if(editingIndex!==null) payload.idValue = form.id;

  fetch(APP_SCRIPT_URL, { method:'POST', body:new URLSearchParams(payload) })
  .then(r=>r.json())
  .then(res=>{ if(!res.success) alert('Error sincronizando App Web: '+res.msg); })
  .catch(e=>console.log('Error sincronizando App Web:', e.message));
}

// Edit
function editItem(i){ openAddForm(currentSheet,i); }

// Delete
function deleteItem(i){
  if(!confirm('驴Seguro de eliminar este registro?')) return;

  const sheet = currentSheet;
  const delId = dataStore[sheet][i].id;

  // Eliminar local
  dataStore[sheet].splice(i,1);

  // Reestructurar IDs locales
  dataStore[sheet].forEach((item, idx) => {
    item.oldId = item.id;
    item.id = idx+1;
  });

  renderTable(sheet);

  // Eliminar en App Web
  fetch(APP_SCRIPT_URL, { 
    method:'POST', 
    body: new URLSearchParams({ sheet, action:'delete', idValue:delId }) 
  })
  .then(r=>r.json())
  .then(res=>{ if(!res.success) console.log('Error eliminando App Web:', res.msg); })
  .catch(e=>console.log('Error eliminando App Web:', e.message));

  // Reestructurar IDs en App Web
  dataStore[sheet].forEach(item=>{
    const payload = {...item, sheet, action:'update', idValue:item.oldId};
    delete payload.oldId;
    fetch(APP_SCRIPT_URL, { method:'POST', body: new URLSearchParams(payload) })
      .then(r=>r.json())
      .then(res=>{ if(!res.success) console.log('Error reestructurando App Web:', res.msg); })
      .catch(e=>console.log('Error reestructurando App Web:', e.message));
  });
}

// Dashboard
function renderDashboard(){
  const cardsDiv=document.getElementById('dashboard-cards');
  cardsDiv.innerHTML='';
  cardsDiv.innerHTML+=`<div class="card" onclick="nav('inventario')"><i class="fa-solid fa-computer"></i><span>${dataStore.inventario.length}</span>Inventario</div>`;
  cardsDiv.innerHTML+=`<div class="card" onclick="nav('categoria')"><i class="fa-solid fa-tags"></i><span>${dataStore.categoria.length}</span>Categor铆as</div>`;
  cardsDiv.innerHTML+=`<div class="card" onclick="nav('tienda')"><i class="fa-solid fa-store"></i><span>${dataStore.tienda.length}</span>Tiendas</div>`;
  document.getElementById('main-title').textContent = 'Dashboard';
  document.getElementById('content').innerHTML='';
}

// Navegaci贸n
function nav(sheet){ renderTable(sheet); }

// Inicializaci贸n
Promise.all([fetchSheet('tienda'),fetchSheet('categoria'),fetchSheet('inventario')])
  .then(()=>{ renderDashboard(); });
</script>
</body>
</html>
