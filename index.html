<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body,html{margin:0;padding:0;font-family:sans-serif;}
*{box-sizing:border-box;}
.sidebar{width:260px;position:fixed;height:100%;background:#ff4d00;color:white;display:flex;flex-direction:column;gap:12px;padding:20px;transition:0.3s;overflow-y:auto;}
.sidebar.collapsed{width:60px;padding:20px 5px;}
.brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:1.2rem;position:relative;}
#toggleSidebar{position:absolute;right:10px;top:10px;background:#ff4d00;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;}
.menu-section .accordion{background:transparent;color:white;border:none;padding:10px;width:100%;display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:600;justify-content:space-between;}
.menu-section .panel{display:none;flex-direction:column;padding-left:10px;gap:6px;}
.menu-section .panel button{background:transparent;color:white;border:none;padding:6px;text-align:left;display:flex;align-items:center;gap:6px;cursor:pointer;}
.sidebar.collapsed .brand span,
.sidebar.collapsed .menu-section .accordion span,
.sidebar.collapsed .panel button span{display:none;}
.main{margin-left:260px;padding:20px;transition:0.3s;}
.sidebar.collapsed ~ .main{margin-left:60px;}
.cards{display:flex;gap:20px;margin-top:20px;flex-wrap:wrap;}
.card{flex:1;min-width:150px;background:white;color:#ff4d00;padding:15px;border-radius:12px;text-align:center;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.card span{font-weight:700;font-size:1.2rem;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#ff4d00;color:white;}
.actions button{margin:0 2px;padding:6px;border-radius:50%;border:none;cursor:pointer;width:32px;height:32px;}
.btn-edit{background:#ffb86b;color:white;}
.btn-del{background:#6b0000;color:white;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:50;}
.modal{background:white;padding:20px;border-radius:12px;width:400px;max-width:95%;}
input,select{padding:6px;border-radius:6px;border:1px solid #ccc;width:100%;margin-bottom:8px;}
@media(max-width:768px){.sidebar{left:-260px;position:fixed}.sidebar.collapsed{left:0}.main{margin-left:0}}
</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="brand">
    <i class="fa-solid fa-boxes-stacked"></i><span>3A</span>
    <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
  </div>

  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-house"></i><span>Dashboard</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="nav('dashboard')">Ver Dashboard</button>
    </div>
  </div>

  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-computer"></i><span>Inventario</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('inventario')">Agregar Inventario</button>
      <button onclick="nav('inventario')">Ver Inventario</button>
    </div>
  </div>

  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-tags"></i><span>Categorías</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('categoria')">Agregar Categoría</button>
      <button onclick="nav('categoria')">Ver Categorías</button>
    </div>
  </div>

  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-store"></i><span>Tiendas</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('tienda')">Agregar Tienda</button>
      <button onclick="nav('tienda')">Ver Tiendas</button>
    </div>
  </div>
</aside>

<div class="main">
  <h2>Inventario de Tienda</h2>
  <div id="content"></div>
</div>

<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h3 id="modal-title"></h3>
    <div id="modal-form"></div>
    <div style="text-align:right;margin-top:10px;">
      <button onclick="closeModal()">Cancelar</button>
      <button onclick="saveItem()">Guardar</button>
    </div>
  </div>
</div>

<script>
const APPWEB_URL="https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";
let inventario=[], categorias=[], tiendas=[];
let editItemIndex=null;
let currentView='dashboard';
const STORAGE_KEY='inventario3a';

// Cargar y guardar datos
function loadData(){
  const data=localStorage.getItem(STORAGE_KEY);
  if(data){
    const parsed=JSON.parse(data);
    inventario=parsed.inventario||[];
    categorias=parsed.categorias||[];
    tiendas=parsed.tiendas||[];
  }
}
function saveData(){localStorage.setItem(STORAGE_KEY,JSON.stringify({inventario,categorias,tiendas}));}

// Fetch normalizado
async function fetchSheet(sheet){
  try{
    const res=await fetch(`${APPWEB_URL}?sheet=${sheet}&action=get`);
    const json=await res.json();
    return json.map((row,i)=>{
      return {
        id:i+1,
        nombre:row.nombre || row.Nombre || row.Categoria || row.Tienda || `Item ${i+1}`,
        Codigo:row.Codigo||'',
        Serie:row.Serie||'',
        Equipo:row.Equipo||'',
        Marca:row.Marca||'',
        Modelo:row.Modelo||'',
        Categoria:row.Categoria||'',
        Tienda:row.Tienda||''
      };
    });
  }catch(e){console.warn("Error fetching sheet",e); return [];}
}

async function loadInitialData(){
  const [inv,cat,td]=await Promise.all([fetchSheet('Inventario'),fetchSheet('Categorias'),fetchSheet('Tiendas')]);
  inventario=inv; categorias=cat; tiendas=td;
  saveData(); render();
}

// Sync AppWeb
async function syncItem(tipo,item,action){
  let sheet = tipo==="inventario"?"Inventario": tipo==="categoria"?"Categorias":"Tiendas";
  const params = new URLSearchParams({sheet, action});
  if(action==="add" || action==="update"){
    Object.keys(item).forEach(k=>params.append(k, item[k]||""));
    if(action==="update") params.append("idCol","id").append("idValue",item.id);
  } else if(action==="delete"){
    params.append("idCol","id").append("idValue",item.id);
  }
  try{await fetch(`${APPWEB_URL}?${params.toString()}`).then(r=>r.json());}catch(e){console.warn("Error sincronizando:",e);}
}

// Sidebar toggle y colapso
document.getElementById('toggleSidebar').onclick = function(){
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('collapsed');
  if(sidebar.classList.contains('collapsed')){
    document.querySelectorAll('.accordion').forEach(a=>a.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
  }
};

// Accordion
document.querySelectorAll('.accordion').forEach(acc=>{
  acc.onclick=function(){
    const isActive=this.classList.contains('active');
    document.querySelectorAll('.accordion').forEach(a=>a.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
    if(!isActive){this.classList.add('active'); this.nextElementSibling.style.display='flex';}
  };
});

// Navigation
function nav(view){currentView=view; render();}

// Modal open
function openAddForm(tipo){
  editItemIndex=null;
  document.getElementById('modal').style.display='flex';
  const title=document.getElementById('modal-title');
  const form=document.getElementById('modal-form'); form.innerHTML='';
  if(tipo==='inventario'){
    title.innerText='Agregar Inventario';
    ['Codigo','Serie','Equipo','Marca','Modelo'].forEach(k=>{
      const inp=document.createElement('input'); inp.placeholder=k; inp.id='f_'+k; form.appendChild(inp);
    });
    const catSel=document.createElement('select'); catSel.id='f_Categoria';
    catSel.innerHTML='<option value="">Seleccione Categoría</option>';
    categorias.forEach(c=>{const o=document.createElement('option'); o.value=c.nombre; o.innerText=c.nombre; catSel.appendChild(o);}); form.appendChild(catSel);
    const tSel=document.createElement('select'); tSel.id='f_Tienda';
    tSel.innerHTML='<option value="">Seleccione Tienda</option>';
    tiendas.forEach(t=>{const o=document.createElement('option'); o.value=t.nombre; o.innerText=t.nombre; tSel.appendChild(o);}); form.appendChild(tSel);
  } else {
    title.innerText='Agregar '+tipo.charAt(0).toUpperCase()+tipo.slice(1);
    const inp=document.createElement('input'); inp.placeholder='Nombre'; inp.id='f_nombre'; form.appendChild(inp);
  }
  form.dataset.tipo=tipo;
}
function closeModal(){document.getElementById('modal').style.display='none';}

// Save item y recalc IDs
function saveItem(){
  const form=document.getElementById('modal-form'); const tipo=form.dataset.tipo;
  if(tipo==='inventario'){
    const obj={id:editItemIndex!==null?inventario[editItemIndex].id:inventario.length+1,
      Codigo:document.getElementById('f_Codigo').value,
      Serie:document.getElementById('f_Serie').value,
      Equipo:document.getElementById('f_Equipo').value,
      Marca:document.getElementById('f_Marca').value,
      Modelo:document.getElementById('f_Modelo').value,
      Categoria:document.getElementById('f_Categoria').value,
      Tienda:document.getElementById('f_Tienda').value};
    if(editItemIndex!==null) inventario[editItemIndex]=obj;
    else inventario.push(obj);
    syncItem('inventario',obj,editItemIndex!==null?'update':'add');
  } else if(tipo==='categoria'){
    const name=document.getElementById('f_nombre').value;
    const obj={id:editItemIndex!==null?categorias[editItemIndex].id:categorias.length+1,nombre:name};
    if(editItemIndex!==null) categorias[editItemIndex]=obj;
    else categorias.push(obj);
    syncItem('categoria',obj,editItemIndex!==null?'update':'add');
  } else if(tipo==='tienda'){
    const name=document.getElementById('f_nombre').value;
    const obj={id:editItemIndex!==null?tiendas[editItemIndex].id:tiendas.length+1,nombre:name};
    if(editItemIndex!==null) tiendas[editItemIndex]=obj;
    else tiendas.push(obj);
    syncItem('tienda',obj,editItemIndex!==null?'update':'add');
  }
  recalcIDs(); saveData(); render(); closeModal();
}

// Edit
function editItemFunc(tipo,index){
  editItemIndex=index; openAddForm(tipo);
  if(tipo==='inventario'){
    document.getElementById('f_Codigo').value=inventario[index].Codigo;
    document.getElementById('f_Serie').value=inventario[index].Serie;
    document.getElementById('f_Equipo').value=inventario[index].Equipo;
    document.getElementById('f_Marca').value=inventario[index].Marca;
    document.getElementById('f_Modelo').value=inventario[index].Modelo;
    document.getElementById('f_Categoria').value=inventario[index].Categoria;
    document.getElementById('f_Tienda').value=inventario[index].Tienda;
  } else {
    document.getElementById('f_nombre').value=(tipo==='categoria'?categorias[index].nombre:tiendas[index].nombre);
  }
}

// Delete y recalc IDs
function deleteItem(tipo,index){
  if(!confirm('¿Eliminar este registro?')) return;
  if(tipo==='inventario'){syncItem('inventario',{id:inventario[index].id},'delete'); inventario.splice(index,1);}
  else if(tipo==='categoria'){syncItem('categoria',{id:categorias[index].id},'delete'); categorias.splice(index,1);}
  else if(tipo==='tienda'){syncItem('tienda',{id:tiendas[index].id},'delete'); tiendas.splice(index,1);}
  recalcIDs(); saveData(); render();
}

function recalcIDs(){
  inventario.forEach((i,idx)=>i.id=idx+1);
  categorias.forEach((c,idx)=>c.id=idx+1);
  tiendas.forEach((t,idx)=>t.id=idx+1);
}

// Render
function render(){
  const c=document.getElementById('content'); c.innerHTML='';
  if(currentView==='dashboard'){
    const cards=document.createElement('div'); cards.className='cards';
    const invCard=document.createElement('div'); invCard.className='card'; invCard.innerHTML=`<i class="fa-solid fa-computer"></i><span>Equipos: ${inventario.length}</span>`; invCard.onclick=()=>nav('inventario'); cards.appendChild(invCard);
    const catCard=document.createElement('div'); catCard.className='card'; catCard.innerHTML=`<i class="fa-solid fa-tags"></i><span>Categorías: ${categorias.length}</span>`; catCard.onclick=()=>nav('categoria'); cards.appendChild(catCard);
    const tdCard=document.createElement('div'); tdCard.className='card'; tdCard.innerHTML=`<i class="fa-solid fa-store"></i><span>Tiendas: ${tiendas.length}</span>`; tdCard.onclick=()=>nav('tienda'); cards.appendChild(tdCard);
    c.appendChild(cards);
  } else if(currentView==='inventario'){
    const tbl=document.createElement('table'); tbl.innerHTML='<thead><tr><th>ID</th><th>Código</th><th>Serie</th><th>Equipo</th><th>Marca</th><th>Modelo</th><th>Categoría</th><th>Tienda</th><th>Acciones</th></tr></thead>';
    const tb=document.createElement('tbody');
    inventario.forEach((i,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i.id}</td><td>${i.Codigo}</td><td>${i.Serie}</td><td>${i.Equipo}</td><td>${i.Marca}</td><td>${i.Modelo}</td><td>${i.Categoria||''}</td><td>${i.Tienda||''}</td>
      <td class="actions"><button class="btn-edit" onclick="editItemFunc('inventario',${idx})"><i class="fa-solid fa-pen"></i></button>
      <button class="btn-del" onclick="deleteItem('inventario',${idx})"><i class="fa-solid fa-trash"></i></button></td>`; tb.appendChild(tr);
    });
    tbl.appendChild(tb); c.appendChild(tbl);
  } else if(currentView==='categoria'){
    const tbl=document.createElement('table'); tbl.innerHTML='<thead><tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr></thead>';
    const tb=document.createElement('tbody');
    categorias.forEach((i,idx)=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${i.id}</td><td>${i.nombre||''}</td><td class="actions">
      <button class="btn-edit" onclick="editItemFunc('categoria',${idx})"><i class="fa-solid fa-pen"></i></button>
      <button class="btn-del" onclick="deleteItem('categoria',${idx})"><i class="fa-solid fa-trash"></i></button></td>`; tb.appendChild(tr);
    });
    tbl.appendChild(tb); c.appendChild(tbl);
  } else if(currentView==='tienda'){
    const tbl=document.createElement('table'); tbl.innerHTML='<thead><tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr></thead>';
    const tb=document.createElement('tbody');
    tiendas.forEach((i,idx)=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${i.id}</td><td>${i.nombre||''}</td><td class="actions">
      <button class="btn-edit" onclick="editItemFunc('tienda',${idx})"><i class="fa-solid fa-pen"></i></button>
      <button class="btn-del" onclick="deleteItem('tienda',${idx})"><i class="fa-solid fa-trash"></i></button></td>`; tb.appendChild(tr);
    });
    tbl.appendChild(tb); c.appendChild(tbl);
  }
}

// Inicialización
loadData(); render(); loadInitialData();
</script>

</body>
</html>
