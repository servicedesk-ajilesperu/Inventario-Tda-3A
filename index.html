<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario Tiendas 3A</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    /* ===== ESTILOS GENERALES ===== */
    body,html{margin:0;padding:0;font-family:sans-serif;height:100%;overflow:hidden;}
    .container{display:flex;height:100vh;}
    /* ===== SIDEBAR ===== */
    .sidebar{width:250px;background:#2c3e50;color:#fff;display:flex;flex-direction:column;transition:.3s;}
    .sidebar.collapsed{width:60px;}
    .sidebar .logo{padding:20px;text-align:center;font-weight:bold;background:#1a252f;}
    .sidebar ul{list-style:none;margin:0;padding:0;flex:1;overflow:auto;}
    .sidebar li{border-bottom:1px solid rgba(255,255,255,0.1);}
    .sidebar a,.accordion{display:block;padding:15px;color:#fff;text-decoration:none;cursor:pointer;}
    .sidebar a:hover,.accordion:hover{background:#34495e;}
    .panel{max-height:0;overflow:hidden;transition:max-height .2s ease-out;background:#34495e;}
    .panel a{padding-left:40px;}
    /* ===== MAIN ===== */
    .main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
    .topbar{background:#ecf0f1;padding:10px;display:flex;align-items:center;justify-content:space-between;}
    .topbar button{background:none;border:none;font-size:20px;cursor:pointer;}
    .content{flex:1;overflow:auto;padding:20px;}
    /* ===== DASHBOARD ===== */
    #dashboard-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;}
    .card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.1);text-align:center;}
    .card i{font-size:30px;margin-bottom:10px;color:#2980b9;}
    .card span{display:block;font-size:24px;font-weight:bold;}
    /* ===== TABLAS ===== */
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;}
    th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left;}
    th{background:#3498db;color:#fff;}
    tr:hover{background:#f1f1f1;}
    .actions button{border:none;padding:6px 10px;margin:0 2px;border-radius:6px;cursor:pointer;color:#fff;}
    .btn-edit{background:#27ae60;}
    .btn-del{background:#e74c3c;}
    .search-bar{margin-bottom:10px;}
    .search-bar input{padding:8px;width:100%;border:1px solid #ccc;border-radius:6px;}
    /* ===== MODAL ===== */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;}
    .modal-content{background:#fff;padding:20px;border-radius:8px;width:90%;max-width:400px;}
    .modal-content input,.modal-content select{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:6px;}
    .modal-footer{text-align:right;margin-top:10px;}
    .modal-footer button{padding:8px 14px;margin-left:8px;border:none;border-radius:6px;cursor:pointer;}
    .btn-save{background:#3498db;color:#fff;}
    .btn-cancel{background:#7f8c8d;color:#fff;}
  </style>
</head>
<body>
<div class="container">
  <div class="sidebar" id="sidebar">
    <div class="logo">Tiendas 3A</div>
    <ul>
      <li><a href="#" onclick="nav('dashboard')"><i class="fa fa-chart-pie"></i> Dashboard</a></li>
      <li>
        <div class="accordion"><i class="fa fa-database"></i> Tablas</div>
        <div class="panel">
          <a href="#" onclick="nav('tienda')">Tiendas</a>
          <a href="#" onclick="nav('categoria')">Categorias</a>
          <a href="#" onclick="nav('inventario')">Inventario</a>
        </div>
      </li>
    </ul>
  </div>
  <div class="main">
    <div class="topbar">
      <button id="toggleSidebar"><i class="fa fa-bars"></i></button>
      <h2 id="main-title">Dashboard</h2>
      <button onclick="openAddForm(currentSheet)"><i class="fa fa-plus"></i></button>
    </div>
    <div class="content" id="content">
      <div id="dashboard-cards"></div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3 id="modal-title"></h3>
    <div id="modal-form"></div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn-save" onclick="saveItem()">Guardar</button>
    </div>
  </div>
</div>

<script>
const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZYvau-tS7jCLqsNmwUkxK4wfkcL2AveUVJGUNKw2n/exec";
let currentSheet="dashboard";
let dataStore={tienda:[],categoria:[],inventario:[]};
let editingIndex=null;

// Sidebar & acordeón
document.getElementById('toggleSidebar').addEventListener('click',()=>{document.getElementById('sidebar').classList.toggle('collapsed');});
document.querySelectorAll('.accordion').forEach(acc=>{
  acc.addEventListener('click',function(){
    this.classList.toggle('active');
    let panel=this.nextElementSibling;
    panel.style.maxHeight=panel.style.maxHeight?null:panel.scrollHeight+'px';
  });
});

// ====== FETCH JSONP ======
function fetchSheet(sheet){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).substring(2,15);
    window[cb]=function(res){
      if(res.success){dataStore[sheet]=res.data;resolve(res.data);}
      else reject(res.msg);
      delete window[cb];
    };
    const s=document.createElement('script');
    s.src=`${APP_SCRIPT_URL}?sheet=${sheet}&callback=${cb}`;
    s.onerror=()=>reject('Error cargando datos');
    document.body.appendChild(s);
  });
}

// ====== RENDER TABLE ======
function renderTable(sheet){
  if(sheet==='dashboard'){ renderDashboard(); return; }
  fetchSheet(sheet).then(data=>{
    currentSheet=sheet;
    document.getElementById('main-title').textContent=sheet.charAt(0).toUpperCase()+sheet.slice(1);
    let html='<div class="search-bar"><input type="text" placeholder="Buscar..." oninput="filterTable(this.value)"></div>';
    if(data.length>0){
      html+='<table><thead><tr>';
      Object.keys(data[0]).forEach(h=> html+=`<th>${h}</th>`);
      html+='<th>Acciones</th></tr></thead><tbody>';
      data.forEach((r,i)=>{
        html+='<tr>';
        Object.values(r).forEach(v=> html+=`<td>${v}</td>`);
        html+=`<td class="actions">
          <button class="btn-edit" onclick="editItem(${i})"><i class="fa fa-pen"></i></button>
          <button class="btn-del" onclick="deleteItem(${i})"><i class="fa fa-trash"></i></button>
        </td>`;
        html+='</tr>';
      });
      html+='</tbody></table>';
    } else html+='<table><tr><td colspan="100%">No hay datos</td></tr></table>';
    document.getElementById('content').innerHTML=html;
  }).catch(err=>{
    document.getElementById('content').innerHTML=`<p style="color:red;">${err}</p>`;
  });
}

// ====== FILTRO ======
function filterTable(value){
  const tbody=document.querySelector('tbody'); if(!tbody) return;
  Array.from(tbody.rows).forEach(r=>{
    r.style.display=Array.from(r.cells).some(c=>c.textContent.toLowerCase().includes(value.toLowerCase()))?'':'none';
  });
}

// ====== MODAL ======
function openAddForm(sheet,index=null){
  if(sheet==='dashboard') return;
  currentSheet=sheet; editingIndex=index;
  document.getElementById('modal-title').textContent=index!==null?'Editar '+sheet:'Agregar '+sheet;
  let html='';
  if(sheet==='categoria'){
    const item=index!==null?dataStore.categoria[index]:{};
    html=`<input type="text" id="nombre" placeholder="Nombre de Categoria" value="${item.nombre||''}">`;
  } else if(sheet==='tienda'){
    const item=index!==null?dataStore.tienda[index]:{};
    html=`<input type="text" id="codigo" placeholder="Código" value="${item.codigo||''}">
          <input type="text" id="nombre" placeholder="Nombre de Tienda" value="${item.nombre||''}">`;
  } else if(sheet==='inventario'){
    const item=index!==null?dataStore.inventario[index]:{};
    html=`<input type="text" id="nombre" placeholder="Nombre de Item" value="${item.nombre||''}">`;
    html+=`<select id="categoria"><option value="">Selecciona Categoria</option>`;
    dataStore.categoria.forEach(c=>{
      html+=`<option value="${c.codigo||c.id}" ${item.categoria==c.codigo?'selected':''}>${c.nombre}</option>`;
    });
    html+=`</select>`;
    html+=`<select id="tienda"><option value="">Selecciona Tienda</option>`;
    dataStore.tienda.forEach(t=>{
      html+=`<option value="${t.codigo||t.id}" ${item.tienda==t.codigo?'selected':''}>${t.nombre}</option>`;
    });
    html+=`</select>`;
  }
  document.getElementById('modal-form').innerHTML=html;
  document.getElementById('modal').style.display='flex';
}
function closeModal(){document.getElementById('modal').style.display='none';}

// ====== SAVE ======
function saveItem(){
  const form={}; document.querySelectorAll('#modal-form input,#modal-form select').forEach(el=> form[el.id]=el.value);
  let action=editingIndex!==null?'update':'add';
  if(editingIndex!==null) form.idValue=currentSheet==='tienda'?form.codigo:dataStore[currentSheet][editingIndex].codigo||dataStore[currentSheet][editingIndex].id;
  fetch(APP_SCRIPT_URL,{method:'POST',body:new URLSearchParams({sheet:currentSheet,action,...form})})
  .then(r=>r.json()).then(res=>{
    if(res.success){ closeModal(); fetchSheet(currentSheet).then(()=>renderTable(currentSheet)); }
    else alert('Error: '+res.msg);
  }).catch(e=>alert('Error al guardar'));
}

// ====== EDIT & DELETE ======
function editItem(i){ openAddForm(currentSheet,i); }
function deleteItem(i){
  if(confirm('¿Seguro de eliminar?')){
    const id=currentSheet==='tienda'?dataStore[currentSheet][i].codigo:dataStore[currentSheet][i].codigo||dataStore[currentSheet][i].id;
    fetch(APP_SCRIPT_URL,{method:'POST',body:new URLSearchParams({sheet:currentSheet,action:'delete',idValue:id,codigo:id})})
    .then(r=>r.json()).then(res=>{
      if(res.success) fetchSheet(currentSheet).then(()=>renderTable(currentSheet));
      else alert('Error: '+res.msg);
    }).catch(e=>alert('Error al eliminar'));
  }
}

// ====== DASHBOARD ======
function renderDashboard(){
  currentSheet='dashboard';
  document.getElementById('main-title').textContent="Dashboard";
  const cardsDiv=document.getElementById('dashboard-cards');
  cardsDiv.innerHTML='';
  cardsDiv.innerHTML+=`<div class="card"><i class="fa fa-store"></i><span>${dataStore.tienda.length}</span>Tiendas</div>`;
  cardsDiv.innerHTML+=`<div class="card"><i class="fa fa-tags"></i><span>${dataStore.categoria.length}</span>Categorias</div>`;
  cardsDiv.innerHTML+=`<div class="card"><i class="fa fa-boxes-stacked"></i><span>${dataStore.inventario.length}</span>Inventario</div>`;
  document.getElementById('content').innerHTML='<div id="dashboard-cards">'+cardsDiv.innerHTML+'</div>';
}

// ====== NAV ======
function nav(sheet){ renderTable(sheet); }

// ====== INIT ======
Promise.all([fetchSheet('tienda'),fetchSheet('categoria'),fetchSheet('inventario')]).then(()=>{ renderTable('dashboard'); });
</script>
</body>
</html>
