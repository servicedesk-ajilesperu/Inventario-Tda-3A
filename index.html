<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
/* ————— Estilos (igual que tu versión original) ————— */
body, html { margin: 0; padding: 0; font-family: sans-serif; background: #f7f7f7; }
* { box-sizing: border-box; }
.sidebar { width: 260px; position: fixed; height: 100%; background: #ff4d00; color: white; display: flex; flex-direction: column; gap: 12px; padding: 20px; transition: 0.3s; overflow-y: auto; z-index: 10; }
.sidebar.collapsed { width: 60px; padding: 20px 5px; }
.brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.2rem; position: relative; margin-bottom: 10px; }
#toggleSidebar { position: absolute; right: 0; top: 0; background: #cc3c00; color: white; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; }
.menu-section { width: 100%; }
.menu-section .accordion { background: transparent; color: white; border: none; padding: 10px; width: 100%; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; justify-content: space-between; transition: 0.2s; border-radius: 4px; }
.menu-section .accordion.active, .menu-section .accordion:hover { background-color: #e64500; }
.menu-section .panel { padding: 0 10px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; background-color: #e64500; display: flex; flex-direction: column; gap: 4px; }
.menu-section .panel button { background: transparent; color: white; border: none; padding: 8px; text-align: left; display: flex; align-items: center; gap: 6px; cursor: pointer; width: 100%; border-radius: 4px; }
.menu-section .panel button:hover { background-color: #cc4000; }
.sidebar.collapsed .brand span,
.sidebar.collapsed .menu-section .accordion span,
.sidebar.collapsed .panel button span { display: none; }
.sidebar.collapsed .accordion { justify-content: center; }
.sidebar.collapsed .accordion i.fa-chevron-down { display: none; }
.main { margin-left: 260px; padding: 20px; transition: 0.3s; }
.sidebar.collapsed ~ .main { margin-left: 60px; }
.cards { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
.card { flex: 1; min-width: 150px; background: white; color: #ff4d00; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: 0.2s; }
.card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
.card span { font-weight: 700; font-size: 1.3rem; display: block; margin-top: 5px;}
.card i { font-size: 2rem; }
.search-bar { margin-bottom: 15px; display: flex; gap: 10px; }
.search-bar input { flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
th, td { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 0.9rem; }
th { background: #ff4d00; color: white; font-weight: 600; }
tr:nth-child(even) { background-color: #f9f9f9; }
.actions button { margin: 0 2px; padding: 6px; border-radius: 50%; border: none; cursor: pointer; width: 32px; height: 32px; transition: 0.1s; }
.actions button:hover { opacity: 0.8; }
.btn-edit { background: #ffb86b; color: white; }
.btn-del { background: #d9534f; color: white; }
.modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 50; }
.modal { background: white; padding: 25px; border-radius: 12px; width: 450px; max-width: 95%; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
input, select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; width: 100%; margin-bottom: 12px; font-size: 1rem; }
.modal button { padding: 8px 15px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; transition: 0.1s; }
.modal button:last-child { background:#ff4d00; color:white; }
.modal button:last-child:hover { background:#cc3c00; }
.modal button:first-child { background:#eee; color:#333; margin-right: 10px; }
.modal button:first-child:hover { background:#ddd; }
@media(max-width:768px) {
    .sidebar { left: -260px; position: fixed; }
    .sidebar.collapsed { left: 0; }
    .main { margin-left: 0; padding: 10px; }
    .cards { flex-direction: column; }
    .card { min-width: 100%; }
}
</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
<div class="brand">
<i class="fa-solid fa-boxes-stacked"></i><span>Inventario 3A</span>
<button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
</div>

<div class="menu-section">
<button class="accordion active" onclick="nav('dashboard')"><i class="fa-solid fa-house"></i><span>Dashboard</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel" style="max-height: 500px;">
<button onclick="nav('dashboard')"><i class="fa-solid fa-gauge-high"></i><span>Ver Dashboard</span></button>
</div>
</div>

<div class="menu-section">
<button class="accordion"><i class="fa-solid fa-computer"></i><span>Inventario</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel">
<button onclick="openAddForm('inventario')"><i class="fa-solid fa-plus"></i><span>Agregar Inventario</span></button>
<button onclick="nav('inventario')"><i class="fa-solid fa-table"></i><span>Ver Inventario</span></button>
</div>
</div>

<div class="menu-section">
<button class="accordion"><i class="fa-solid fa-tags"></i><span>Categorías</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel">
<button onclick="openAddForm('categoria')"><i class="fa-solid fa-plus"></i><span>Agregar Categoría</span></button>
<button onclick="nav('categoria')"><i class="fa-solid fa-table"></i><span>Ver Categorías</span></button>
</div>
</div>

<div class="menu-section">
<button class="accordion"><i class="fa-solid fa-store"></i><span>Tiendas</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel">
<button onclick="openAddForm('tienda')"><i class="fa-solid fa-plus"></i><span>Agregar Tienda</span></button>
<button onclick="nav('tienda')"><i class="fa-solid fa-table"></i><span>Ver Tiendas</span></button>
</div>
</div>
</aside>

<div class="main">
<h2 id="main-title">Inventario de Tienda</h2>
<div id="content"></div>
</div>

<div class="modal-backdrop" id="modal">
<div class="modal">
<h3 id="modal-title"></h3>
<div id="modal-form"></div>
<div style="text-align:right; margin-top:15px;">
<button onclick="closeModal()">Cancelar</button>
<button onclick="saveItem()">Guardar</button>
</div>
</div>
</div>

<script>
const APPWEB_URL = "https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";

let inventario = [], categorias = [], tiendas = [], pendingOps = [];
let editItemIndex = null, currentView = 'dashboard', currentSearch = '';
const STORAGE_KEY = 'inventario3a';

// Sidebar toggle
document.getElementById('toggleSidebar').onclick = () => document.getElementById('sidebar').classList.toggle('collapsed');
document.querySelectorAll('.accordion').forEach(btn => btn.addEventListener('click', ()=>{toggleAccordion(btn);} ));
function toggleAccordion(button){
document.querySelectorAll('.accordion').forEach(acc=>{
if(acc!==button && acc.classList.contains('active')){ acc.classList.remove('active'); acc.nextElementSibling.style.maxHeight=null; }
});
button.classList.toggle('active');
const panel = button.nextElementSibling;
panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight+'px';
}

// Local Storage
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({ inventario,categorias,tiendas,pendingOps })); }
function loadData(){
const data = localStorage.getItem(STORAGE_KEY);
if(data){ const parsed = JSON.parse(data); inventario = parsed.inventario || []; categorias = parsed.categorias || []; tiendas = parsed.tiendas || []; pendingOps = parsed.pendingOps || []; }
}

// Fetch inicial
async function fetchSheet(sheet){
try{
const res = await fetch(`${APPWEB_URL}?sheet=${sheet}&action=get&t=${Date.now()}`);
const json = await res.json();
return json.map(row=>({
idSheet: row.id,
nombre: row.nombre||row.Nombre||row.Categoria||row.Tienda||'',
Codigo: row.Codigo||'',
Serie: row.Serie||'',
Equipo: row.Equipo||'',
Marca: row.Marca||'',
Modelo: row.Modelo||'',
Categoria: row.Categoria||'',
Tienda: row.Tienda||''
}));
}catch(e){ console.warn("Error fetchSheet",sheet,e); return []; }
}

async function loadInitialData(){
[inventario,categorias,tiendas] = await Promise.all([fetchSheet('inventario'),fetchSheet('categoria'),fetchSheet('tienda')]);
saveData(); render();
}

// ————— FUNCIONES DE SINCRONIZACIÓN —————
async function syncItem(tipo, item, action){
    if(!item){ console.warn("syncItem: item indefinido", {tipo, action}); return false; }
    const params = new URLSearchParams();
    const sheet = tipo==='inventario'?'inventario':tipo==='categoria'?'categoria':'tienda';
    params.append('sheet',sheet); params.append('action',action);

    const fields = tipo==='inventario'?['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda']:['nombre'];

    if(action==='add' || action==='update'){
        if(action==='update' && !item.idSheet){ console.warn("syncItem update sin idSheet", item); return false; }
        fields.forEach(k=>params.append(k, item[k]!==undefined?item[k]:'')); 
        if(action==='update'){ params.append('idCol','id'); params.append('idValue',item.idSheet); }
    }
    if(action==='delete'){ params.append('idCol','id'); params.append('idValue',item.idSheet); }

    try{
        const resp = await fetch(APPWEB_URL,{method:'POST',body:params});
        const data = await resp.json();
        if(data.success) return true;
        console.warn("syncItem fallo:", data.msg);
        return false;
    }catch(e){ console.warn("syncItem error:", e); return false; }
}

async function syncPending(){
    if(!pendingOps || pendingOps.length===0) return;
    let newPending=[];
    for(let op of pendingOps){
        if(!op.item){ console.warn("syncPending: item indefinido, se omite", op); continue; }
        const success = await syncItem(op.tipo, op.item, op.action);
        if(!success) newPending.push(op);
    }
    pendingOps=newPending;
    saveData();
    render();
}

// ————— RENDER TABLAS Y DASHBOARD —————
function render(){
    const content = document.getElementById('content'); content.innerHTML='';
    if(currentView==='dashboard'){
        const cardsDiv = document.createElement('div'); cardsDiv.className='cards';
        cardsDiv.innerHTML=`
        <div class="card"><i class="fa-solid fa-computer"></i><span>${inventario.length}</span>Inventario</div>
        <div class="card"><i class="fa-solid fa-tags"></i><span>${categorias.length}</span>Categorías</div>
        <div class="card"><i class="fa-solid fa-store"></i><span>${tiendas.length}</span>Tiendas</div>`;
        content.appendChild(cardsDiv); return;
    }
    let dataArray=[];
    if(currentView==='inventario') dataArray=inventario;
    else if(currentView==='categoria') dataArray=categorias;
    else if(currentView==='tienda') dataArray=tiendas;
    const searchHTML=`<div class="search-bar"><input placeholder="Buscar..." oninput="currentSearch=this.value; render();"/></div>`; content.innerHTML=searchHTML;
    const table = document.createElement('table'); const thead = document.createElement('thead'); const tbody = document.createElement('tbody');
    if(currentView==='inventario'){ thead.innerHTML='<tr><th>Código</th><th>Serie</th><th>Equipo</th><th>Marca</th><th>Modelo</th><th>Categoría</th><th>Tienda</th><th>Acciones</th></tr>'; }
    else{ thead.innerHTML='<tr><th>Nombre</th><th>Acciones</th></tr>'; }
    dataArray.filter(r=>JSON.stringify(r).toLowerCase().includes(currentSearch.toLowerCase())).forEach((row,i)=>{
        const tr=document.createElement('tr');
        if(currentView==='inventario'){
            tr.innerHTML=`<td>${row.Codigo}</td><td>${row.Serie}</td><td>${row.Equipo}</td><td>${row.Marca}</td><td>${row.Modelo}</td><td>${row.Categoria}</td><td>${row.Tienda}</td>
            <td class="actions">
                <button class="btn-edit" onclick="editItem(${i})"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-del" onclick="deleteItem(${i})"><i class="fa-solid fa-trash"></i></button>
            </td>`;
        }else{
            tr.innerHTML=`<td>${row.nombre}</td>
            <td class="actions">
                <button class="btn-edit" onclick="editItem(${i})"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-del" onclick="deleteItem(${i})"><i class="fa-solid fa-trash"></i></button>
            </td>`;
        }
        tbody.appendChild(tr);
    });
    table.appendChild(thead); table.appendChild(tbody); content.appendChild(table);
}

// ————— MODAL Y FORMULARIOS —————
function openAddForm(tipo){
    document.getElementById('modal-title').textContent=`Agregar ${tipo}`;
    const formDiv=document.getElementById('modal-form'); formDiv.innerHTML='';
    if(tipo==='inventario'){
        ['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda'].forEach(f=>formDiv.innerHTML+=`<input placeholder="${f}" id="form-${f}"/>`);
    }else{ formDiv.innerHTML=`<input placeholder="Nombre" id="form-nombre"/>`; }
    editItemIndex=null; document.getElementById('modal').style.display='flex';
}

function saveItem(){
    const tipo=currentView;
    let item={};
    if(tipo==='inventario'){ ['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda'].forEach(f=>item[f]=document.getElementById(`form-${f}`).value); }
    else{ item.nombre=document.getElementById('form-nombre').value; }
    if(editItemIndex!==null){
        item.idSheet=(tipo==='inventario'?inventario[editItemIndex]:tipo==='categoria'?categorias[editItemIndex]:tiendas[editItemIndex]).idSheet;
        (tipo==='inventario'?inventario:tipo==='categoria'?categorias:tiendas)[editItemIndex]=item;
        pendingOps.push({tipo,action:'update',item});
    }else{
        (tipo==='inventario'?inventario:tipo==='categoria'?categorias:tiendas).push(item);
        pendingOps.push({tipo,action:'add',item});
    }
    closeModal(); saveData(); render(); syncPending();
}

function closeModal(){ document.getElementById('modal').style.display='none'; }

function editItem(i){
    const tipo=currentView;
    const item=(tipo==='inventario'?inventario:tipo==='categoria'?categorias:tiendas)[i]; editItemIndex=i;
    document.getElementById('modal-title').textContent=`Editar ${tipo}`;
    const formDiv=document.getElementById('modal-form'); formDiv.innerHTML='';
    if(tipo==='inventario'){ ['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda'].forEach(f=>formDiv.innerHTML+=`<input id="form-${f}" value="${item[f]}"/>`); }
    else{ formDiv.innerHTML=`<input id="form-nombre" value="${item.nombre}"/>`; }
    document.getElementById('modal').style.display='flex';
}

function deleteItem(i){
    if(!confirm('¿Desea eliminar este registro?')) return;
    const tipo=currentView;
    const arr=(tipo==='inventario'?inventario:tipo==='categoria'?categorias:tiendas);
    const item=arr[i]; arr.splice(i,1); pendingOps.push({tipo,action:'delete',item}); saveData(); render(); syncPending();
}

function nav(view){ currentView=view; document.getElementById('main-title').textContent=view.charAt(0).toUpperCase()+view.slice(1); render(); }

loadData();
loadInitialData();

</script>
</body>
</html>
