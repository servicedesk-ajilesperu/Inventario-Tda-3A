<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  body, html { margin:0; padding:0; font-family:sans-serif; background:#f7f7f7; }
  * { box-sizing:border-box; }
  .sidebar { width:260px; position:fixed; height:100%; background:#ff4d00; color:white; display:flex; flex-direction:column; gap:12px; padding:20px; transition:0.3s; overflow-y:auto; z-index:10; }
  .sidebar.collapsed { width:60px; padding:20px 5px; }
  .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.2rem; position:relative; margin-bottom:10px; }
  #toggleSidebar { position:absolute; right:0; top:0; background:#cc3c00; color:white; border:none; border-radius:6px; padding:4px 8px; cursor:pointer; }
  .menu-section .accordion { background:transparent; color:white; border:none; padding:10px; width:100%; display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:600; justify-content:space-between; border-radius:4px; }
  .menu-section .accordion.active, .menu-section .accordion:hover { background-color:#e64500; }
  .menu-section .panel { padding:0 10px; max-height:0; overflow:hidden; transition:max-height 0.3s ease-in-out; background-color:#e64500; display:flex; flex-direction:column; gap:4px; }
  .menu-section .panel button { background:transparent; color:white; border:none; padding:8px; text-align:left; display:flex; align-items:center; gap:6px; cursor:pointer; width:100%; border-radius:4px; }
  .menu-section .panel button:hover { background-color:#cc4000; }
  .sidebar.collapsed .brand span, .sidebar.collapsed .accordion span, .sidebar.collapsed .panel button span { display:none; }
  .sidebar.collapsed .accordion { justify-content:center; }
  .sidebar.collapsed .accordion i.fa-chevron-down { display:none; }
  .main { margin-left:260px; padding:20px; transition:0.3s; }
  .sidebar.collapsed ~ .main { margin-left:60px; }
  .cards { display:flex; gap:20px; margin-top:20px; flex-wrap:wrap; }
  .card { flex:1; min-width:150px; background:white; color:#ff4d00; padding:20px; border-radius:12px; text-align:center; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.1); transition:0.2s; }
  .card:hover { transform:translateY(-3px); box-shadow:0 6px 12px rgba(0,0,0,0.15); }
  .card span { font-weight:700; font-size:1.3rem; display:block; margin-top:5px; }
  .card i { font-size:2rem; }
  .search-bar { margin-bottom:15px; display:flex; gap:10px; }
  .search-bar input { flex-grow:1; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:1rem; }
  table { width:100%; border-collapse:collapse; margin-top:20px; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); display:block; overflow-x:auto; white-space:nowrap; }
  th, td { border:1px solid #eee; padding:10px; text-align:center; font-size:0.9rem; }
  th { background:#ff4d00; color:white; font-weight:600; }
  tr:nth-child(even) { background-color:#f9f9f9; }
  .actions button { margin:0 2px; padding:6px; border-radius:50%; border:none; cursor:pointer; width:32px; height:32px; transition:0.1s; }
  .actions button:hover { opacity:0.8; }
  .btn-edit { background:#ffb86b; color:white; }
  .btn-del { background:#d9534f; color:white; }
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:50; }
  .modal { background:white; padding:25px; border-radius:12px; width:450px; max-width:95%; box-shadow:0 10px 20px rgba(0,0,0,0.2); }
  input, select { padding:10px; border-radius:6px; border:1px solid #ccc; width:100%; margin-bottom:12px; font-size:1rem; }
  .modal button { padding:8px 15px; border-radius:6px; cursor:pointer; border:none; font-weight:600; transition:0.1s; }
  .modal button:last-child { background:#ff4d00; color:white; }
  .modal button:last-child:hover { background:#cc3c00; }
  .modal button:first-child { background:#eee; color:#333; margin-right:10px; }
  .modal button:first-child:hover { background:#ddd; }
  @media(max-width:768px){ .cards{flex-direction:column;} .card{min-width:100%;} .sidebar{left:-260px;position:fixed;} .sidebar.collapsed{left:0;} .main{margin-left:0; padding:10px;} }
</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
<div class="brand">
<i class="fa-solid fa-boxes-stacked"></i><span>Inventario 3A</span>
<button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
</div>

<div class="menu-section">
<button class="accordion active" onclick="nav('Dashboard')"><i class="fa-solid fa-house"></i><span>Dashboard</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel" style="max-height:500px;">
<button onclick="nav('Dashboard')"><i class="fa-solid fa-gauge-high"></i><span>Ver Dashboard</span></button>
</div>
</div>

<div class="menu-section">
<button class="accordion"><i class="fa-solid fa-computer"></i><span>Inventario</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel">
<button onclick="openAddForm('Inventario')"><i class="fa-solid fa-plus"></i><span>Agregar Inventario</span></button>
<button onclick="nav('Inventario')"><i class="fa-solid fa-table"></i><span>Ver Inventario</span></button>
</div>
</div>

<div class="menu-section">
<button class="accordion"><i class="fa-solid fa-tags"></i><span>Categorias</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel">
<button onclick="openAddForm('Categorias')"><i class="fa-solid fa-plus"></i><span>Agregar Categoria</span></button>
<button onclick="nav('Categorias')"><i class="fa-solid fa-table"></i><span>Ver Categorias</span></button>
</div>
</div>

<div class="menu-section">
<button class="accordion"><i class="fa-solid fa-store"></i><span>Tiendas</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel">
<button onclick="openAddForm('Tiendas')"><i class="fa-solid fa-plus"></i><span>Agregar Tienda</span></button>
<button onclick="nav('Tiendas')"><i class="fa-solid fa-table"></i><span>Ver Tiendas</span></button>
</div>
</div>
</aside>

<div class="main">
<h2 id="main-title">Dashboard</h2>
<div id="content"></div>
</div>

<div class="modal-backdrop" id="modal">
<div class="modal">
<h3 id="modal-title"></h3>
<div id="modal-form"></div>
<div style="text-align:right; margin-top:15px;">
<button onclick="closeModal()">Cancelar</button>
<button onclick="saveItem()">Guardar</button>
</div>
</div>
</div>

<script>
let currentSheet=''; 
const APP_SCRIPT_URL='https://script.google.com/macros/s/AKfycbxZYvau-tS7jCLqsNmwUkxK4wfkcL2AveUVJGUNKw2nPhFsMPt4Yw0dh-PYjsieW2j9HA/exec';
let dataStore={Inventario:[],Categorias:[],Tiendas:[]};
let editingIndex=null;

// ==== SIDEBAR ACORDEON ====
document.getElementById('toggleSidebar').addEventListener('click',()=>document.getElementById('sidebar').classList.toggle('collapsed'));
document.querySelectorAll('.accordion').forEach(acc=>{
  acc.addEventListener('click', function(){
    const isActive = this.classList.contains('active');
    // cerrar todos
    document.querySelectorAll('.accordion').forEach(a=>{
      a.classList.remove('active');
      a.nextElementSibling.style.maxHeight = null;
    });
    // abrir solo el seleccionado
    if(!isActive){
      this.classList.add('active');
      this.nextElementSibling.style.maxHeight=this.nextElementSibling.scrollHeight+"px";
    }
  });
});

// ==== FETCH JSONP ====
function fetchSheet(sheet){
  return new Promise((resolve,reject)=>{
    const cbName='cb_'+Math.random().toString(36).substring(2,15);
    window[cbName]=function(response){
      dataStore[sheet]=response || [];
      resolve(dataStore[sheet]);
      delete window[cbName];
    };
    const script=document.createElement('script');
    script.src=`${APP_SCRIPT_URL}?sheet=${sheet}&action=get&callback=${cbName}`;
    script.onerror=()=>reject('Error cargando datos');
    document.body.appendChild(script);
  });
}

// ==== RENDER TABLE ====
function renderTable(sheet){
  fetchSheet(sheet).then(data=>{
    let html=`<div class="search-bar"><input type="text" placeholder="Buscar..." oninput="filterTable(this.value)"></div>`;
    if(data.length>0){
      html+=`<table><thead><tr>`;
      Object.keys(data[0]).forEach(h=>html+=`<th>${h}</th>`);
      html+=`<th>Acciones</th></tr></thead><tbody>`;
      data.forEach((r,i)=>{
        html+=`<tr>`;
        Object.values(r).forEach(v=>html+=`<td>${v}</td>`);
        html+=`<td class="actions">
          <button class="btn-edit" onclick="editItem(${i})"><i class="fa-solid fa-pen"></i></button>
          <button class="btn-del" onclick="deleteItem(${i})"><i class="fa-solid fa-trash"></i></button>
        </td>`;
        html+=`</tr>`;
      });
      html+=`</tbody></table>`;
    } else html+=`<table><tr><td colspan="100%">No hay datos</td></tr></table>`;
    document.getElementById('content').innerHTML=html;
  }).catch(err=>document.getElementById('content').innerHTML=err);
}

// ==== FILTER ====
function filterTable(value){
  const tbody=document.querySelector('tbody'); if(!tbody) return;
  Array.from(tbody.rows).forEach(row=>{
    row.style.display=Array.from(row.cells).some(c=>c.textContent.toLowerCase().includes(value.toLowerCase()))?'':'none';
  });
}

// ==== MODAL ====
function openAddForm(sheet,index=null){
  currentSheet=sheet; editingIndex=index;
  document.getElementById('modal-title')=index!==null?'Editar '+sheet:'Agregar '+sheet;
  let html='';
  if(sheet==='Categorias'){ const item=index!==null?dataStore[sheet][index]:{}; html=`<input type="text" id="nombre" placeholder="Nombre de Categoria" value="${item.nombre||''}">`; }
  else if(sheet==='Tiendas'){ const item=index!==null?dataStore[sheet][index]:{}; html=`<input type="text" id="codigo" placeholder="Código de Tienda" value="${item.codigo||''}"><input type="text" id="nombre" placeholder="Nombre de Tienda" value="${item.nombre||''}">`; }
  else if(sheet==='Inventario'){ const item=index!==null?dataStore[sheet][index]:{}; 
    html=`<input type="text" id="nombre" placeholder="Nombre de Item" value="${item.nombre||''}">`;
    html+=`<select id="categoria"><option value="">Selecciona Categoría</option>${dataStore['Categorias'].map(c=>`<option value="${c.id}" ${item.categoria==c.id?'selected':''}>${c.nombre}</option>`).join('')}</select>`;
    html+=`<select id="tienda"><option value="">Selecciona Tienda</option>${dataStore['Tiendas'].map(t=>`<option value="${t.id}" ${item.tienda==t.id?'selected':''}>${t.nombre}</option>`).join('')}</select>`;}
  document.getElementById('modal-form').innerHTML=html;
  document.getElementById('modal').style.display='flex';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }

// ==== SAVE ====
function saveItem(){
  const form={}; document.querySelectorAll('#modal-form input,#modal-form select').forEach(el=>form[el.id]=el.value);
  const action=editingIndex!==null?'update':'add'; if(editingIndex!==null) form.idValue=dataStore[currentSheet][editingIndex].id;
  fetch(APP_SCRIPT_URL,{ method:'POST', body:new URLSearchParams({sheet:currentSheet, action,...form})}).then(r=>r.json()).then(()=>{ closeModal(); renderTable(currentSheet); });
}

// ==== EDIT & DELETE ====
function editItem(i){ openAddForm(currentSheet,i); }
function deleteItem(i){
  if(confirm("¿Seguro de eliminar?")){
    const item=dataStore[currentSheet][i]; const id=item.id||item.codigo;
    fetch(APP_SCRIPT_URL,{ method:'POST', body:new URLSearchParams({sheet:currentSheet, action:'delete', idValue:id, codigo:id})}).then(r=>r.json()).then(()=> renderTable(currentSheet));
  }
}

// ==== NAV ====
function nav(sheet){
  currentSheet=sheet;
  document.getElementById('main-title').textContent=sheet;
  // Abrir acordeón correspondiente
  document.querySelectorAll('.accordion').forEach(acc=>{
    const panel=acc.nextElementSibling;
    if(acc.textContent.trim().includes(sheet)){ acc.classList.add('active'); panel.style.maxHeight=panel.scrollHeight+"px"; }
    else { acc.classList.remove('active'); panel.style.maxHeight=null; }
  });
  if(sheet==='Dashboard'){
    // Mostrar tarjetas resumen
    document.getElementById('content')=`<div class="cards">
      <div class="card"><i class="fa-solid fa-store"></i><span>${dataStore['Tiendas'].length}</span>TOTAL TIENDAS</div>
      <div class="card"><i class="fa-solid fa-tags"></i><span>${dataStore['Categorias'].length}</span>TOTAL CATEGORIAS</div>
      <div class="card"><i class="fa-solid fa-computer"></i><span>${dataStore['Inventario'].length}</span>TOTAL INVENTARIO</div>
    </div>`;
    return;
  }
  renderTable(sheet);
}

// ==== INIT ====
Promise.all([fetchSheet('Tiendas'), fetchSheet('Categorias'), fetchSheet('Inventario')])
.then(()=> nav('Dashboard'));
</script>

</body>
</html>
