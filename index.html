<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root { --primary:#ff6600; --bg:#f8f9fa; --text:#333; }
body { margin:0; font-family:Arial; display:flex; background:var(--bg); color:var(--text); height:100vh; }
.sidebar { width:250px; background:var(--primary); color:white; display:flex; flex-direction:column; transition:width 0.3s; }
.sidebar.collapsed { width:60px; }
.sidebar button { background:none; border:none; color:white; margin:10px 0; cursor:pointer; font-size:18px; display:flex; align-items:center; gap:10px; padding:8px; }
.sidebar.collapsed button span { display:none; }
.main { flex:1; padding:20px; overflow:auto; }
.cards { display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
.card { flex:1; min-width:200px; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; }
.card h2 { margin:10px 0; }
table { width:100%; border-collapse:collapse; background:white; }
th, td { padding:8px; border:1px solid #ddd; text-align:left; }
th { background:var(--primary); color:white; }
.actions button { background:none; border:none; cursor:pointer; font-size:14px; margin:0 4px; }
.modal { position:fixed; top:0; left:0; width:100%; height:100%; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.5); }
.modal-content { background:white; padding:20px; border-radius:10px; width:90%; max-width:500px; }
.modal-content input, .modal-content select { width:100%; padding:8px; margin:5px 0; border:1px solid #ccc; border-radius:5px; }
.btn-add-sidebar { background:white; color:var(--primary); border:none; padding:6px 10px; border-radius:5px; margin:5px 0; cursor:pointer; width:90%; font-weight:bold; }
@media(max-width:768px){ .cards{flex-direction:column;} .sidebar{position:absolute; z-index:100; height:100%;} }
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <button onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i><span>Menu</span></button>
  <button onclick="showView('dashboard')"><i class="fa-solid fa-chart-pie"></i><span>Dashboard</span></button>
  <hr style="width:90%;border-color:white;">
  <button onclick="showView('inventario')"><i class="fa-solid fa-box"></i><span>Inventario</span></button>
  <button class="btn-add-sidebar" onclick="openModal('Inventario')">+ Agregar</button>
  <button onclick="showView('categorias')"><i class="fa-solid fa-tags"></i><span>Categorias</span></button>
  <button class="btn-add-sidebar" onclick="openModal('Categorias')">+ Agregar</button>
  <button onclick="showView('tiendas')"><i class="fa-solid fa-store"></i><span>Tiendas</span></button>
  <button class="btn-add-sidebar" onclick="openModal('Tiendas')">+ Agregar</button>
</div>

<div class="main">
  <div id="content"></div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <h2 id="modalTitle"></h2>
    <form id="modalForm"></form>
    <button type="button" class="btn-add-sidebar" onclick="saveForm()">Guardar</button>
    <button type="button" onclick="closeModal()">Cancelar</button>
  </div>
</div>

<script>
const api="https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";
let data={inventario:[],categorias:[],tiendas:[]},currentSheet="",editIndex=null;

function toggleSidebar(){ document.getElementById("sidebar").classList.toggle("collapsed"); }

/* ---------- Cache ---------- */
function saveCache(){ localStorage.setItem("inventarioData",JSON.stringify(data)); }
function loadCache(){ const c=localStorage.getItem("inventarioData"); if(c)data=JSON.parse(c); }

/* ---------- Fetch ---------- */
async function fetchData(sheet){
  try{ const res=await fetch(`${api}?sheet=${sheet}&action=get`); return await res.json(); }catch{return[];}
}
async function syncData(){
  data.inventario=await fetchData("Inventario");
  data.categorias=await fetchData("Categorias");
  data.tiendas=await fetchData("Tiendas");
  saveCache();
  showView("dashboard");
}
async function loadAll(){ loadCache(); showView("dashboard"); syncData(); }

/* ---------- Views ---------- */
function showView(view){
  const c=document.getElementById("content");
  if(view==="dashboard"){
    c.innerHTML=`<div class="cards">
      <div class="card"><h3>Inventario</h3><h2>${data.inventario.length}</h2></div>
      <div class="card"><h3>Categorias</h3><h2>${data.categorias.length}</h2></div>
      <div class="card"><h3>Tiendas</h3><h2>${data.tiendas.length}</h2></div>
    </div>`;
  } else {
    let arr=data[view];
    let headers=view==="inventario"?["#","Codigo","Serie","Equipo","Marca","Modelo","Categoria","Tienda","Acciones"]:["#","Nombre","Acciones"];
    let html=`<table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>`;
    arr.forEach((r,i)=>{
      html+=`<tr><td>${i+1}</td>`;
      if(view==="inventario"){
        html+=`<td>${r.Codigo}</td><td>${r.Serie}</td><td>${r.Equipo}</td><td>${r.Marca}</td><td>${r.Modelo}</td>`;
        html+=`<td>${r.Categoria}</td><td>${r.Tienda}</td>`;
      }else{ html+=`<td>${r.Nombre||""}</td>`;}
      html+=`<td class="actions">
        <button onclick="editItem('${view}',${i})"><i class="fa-solid fa-pen"></i></button>
        <button onclick="deleteItem('${view}','${view==="inventario"?"Codigo":"Nombre"}','${view==="inventario"?r.Codigo:r.Nombre}')"><i class="fa-solid fa-trash"></i></button>
      </td></tr>`;
    });
    html+="</tbody></table>";
    c.innerHTML=html;
  }
}

/* ---------- Modal ---------- */
function openModal(sheet,i=null){
  currentSheet=sheet; editIndex=i;
  document.getElementById("modal").style.display="flex";
  let fields=[];
  if(sheet==="inventario") fields=["Codigo","Serie","Equipo","Marca","Modelo","Categoria","Tienda"];
  else fields=["Nombre"];
  const values=i!==null?data[sheet][i]:{};
  document.getElementById("modalTitle").innerText=(i!==null?"Editar ":"Agregar ")+sheet;
  document.getElementById("modalForm").innerHTML=fields.map(f=>{
    if(f==="Categoria") return `<label>${f}</label><select name="${f}">${data.categorias.map(c=>`<option value="${c.Nombre}">${c.Nombre}</option>`).join("")}</select>`;
    if(f==="Tienda") return `<label>${f}</label><select name="${f}">${data.tiendas.map(s=>`<option value="${s.Nombre}">${s.Nombre}</option>`).join("")}</select>`;
    return `<label>${f}</label><input name="${f}" value="${values[f]||""}" required />`;
  }).join("");
}
function closeModal(){document.getElementById("modal").style.display="none";}

/* ---------- Guardar ---------- */
function saveForm(){
  const form=document.getElementById("modalForm");
  const fd=new FormData(form);
  const newItem={};
  fd.forEach((v,k)=>newItem[k]=v);
  const idCol=currentSheet==="inventario"?"Codigo":"Nombre";
  
  if(editIndex!==null){
    data[currentSheet][editIndex]=newItem;
    const idValue=newItem[idCol];
    let params=[...fd.entries()].map(([k,v])=>`${k}=${encodeURIComponent(v)}`).join("&");
    fetch(`${api}?sheet=${currentSheet}&action=update&idCol=${idCol}&idValue=${idValue}&${params}`);
  } else {
    data[currentSheet].push(newItem);
    let params=[...fd.entries()].map(([k,v])=>`${k}=${encodeURIComponent(v)}`).join("&");
    fetch(`${api}?sheet=${currentSheet}&action=add&${params}`);
  }
  saveCache();
  closeModal();
  showView(currentSheet);
}

/* ---------- Editar / Eliminar ---------- */
function editItem(sheet,i){ openModal(sheet,i); }
function deleteItem(sheet,idCol,idValue){
  data[sheet]=data[sheet].filter(r=>r[idCol]!==idValue);
  saveCache();
  showView(sheet);
  fetch(`${api}?sheet=${sheet}&action=delete&idCol=${idCol}&idValue=${idValue}`);
}

/* ---------- Init ---------- */
loadAll();
</script>
</body>
</html>
