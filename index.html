<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventario Tiendas 3A</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        body, html { margin: 0; padding: 0; font-family: sans-serif; }
        * { box-sizing: border-box; }
        .sidebar { width: 260px; position: fixed; height: 100%; background: #ff4d00; color: white; display: flex; flex-direction: column; gap: 12px; padding: 20px; transition: 0.3s; overflow-y: auto; }
        .sidebar.collapsed { width: 60px; padding: 20px 5px; }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.2rem; position: relative; }
        #toggleSidebar { position: absolute; right: 0; top: 0; background: #ff4d00; color: white; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; }
        .menu-section { width: 100%; }
        .menu-section .accordion { background: transparent; color: white; border: none; padding: 10px; width: 100%; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; justify-content: space-between; transition: 0.4s; }
        .menu-section .accordion.active, .menu-section .accordion:hover { background-color: #e64500; }
        .menu-section .panel { padding: 0 10px; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; background-color: #e64500; display: flex; flex-direction: column; gap: 6px; }
        .menu-section .panel button { background: transparent; color: white; border: none; padding: 8px; text-align: left; display: flex; align-items: center; gap: 6px; cursor: pointer; width: 100%; }
        .menu-section .panel button:hover { background-color: #cc4000; }

        .sidebar.collapsed .brand span,
        .sidebar.collapsed .menu-section .accordion span,
        .sidebar.collapsed .panel button span { display: none; }
        .sidebar.collapsed .accordion { justify-content: center; }
        .sidebar.collapsed .accordion i.fa-chevron-down { display: none; }
        
        .main { margin-left: 260px; padding: 20px; transition: 0.3s; }
        .sidebar.collapsed ~ .main { margin-left: 60px; }
        .cards { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .card { flex: 1; min-width: 150px; background: white; color: #ff4d00; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .card span { font-weight: 700; font-size: 1.2rem; display: block; margin-top: 5px;}
        .card i { font-size: 1.5rem; }
        
        .search-bar { margin-bottom: 15px; display: flex; gap: 10px; }
        .search-bar input { flex-grow: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #ff4d00; color: white; }
        .actions button { margin: 0 2px; padding: 6px; border-radius: 50%; border: none; cursor: pointer; width: 32px; height: 32px; }
        .btn-edit { background: #ffb86b; color: white; }
        .btn-del { background: #6b0000; color: white; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal { background: white; padding: 20px; border-radius: 12px; width: 400px; max-width: 95%; }
        input, select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 100%; margin-bottom: 8px; }
        
        @media(max-width:768px) {
            .sidebar { left: -260px; position: fixed; }
            .sidebar.collapsed { left: 0; }
            .main { margin-left: 0; }
        }
    </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <div class="brand">
        <i class="fa-solid fa-boxes-stacked"></i><span>Inventario 3A</span>
        <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
    </div>

    <div class="menu-section">
        <button class="accordion active" onclick="nav('dashboard')"><i class="fa-solid fa-house"></i><span>Dashboard</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel" style="max-height: 500px;">
            <button onclick="nav('dashboard')">Ver Dashboard</button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-computer"></i><span>Inventario</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('inventario')"><i class="fa-solid fa-plus"></i><span>Agregar Inventario</span></button>
            <button onclick="nav('inventario')"><i class="fa-solid fa-table"></i><span>Ver Inventario</span></button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-tags"></i><span>Categorías</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('categoria')"><i class="fa-solid fa-plus"></i><span>Agregar Categoría</span></button>
            <button onclick="nav('categoria')"><i class="fa-solid fa-table"></i><span>Ver Categorías</span></button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-store"></i><span>Tiendas</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('tienda')"><i class="fa-solid fa-plus"></i><span>Agregar Tienda</span></button>
            <button onclick="nav('tienda')"><i class="fa-solid fa-table"></i><span>Ver Tiendas</span></button>
        </div>
    </div>
</aside>

<div class="main">
    <h2 id="main-title">Inventario de Tienda</h2>
    <div id="content"></div>
</div>

<div class="modal-backdrop" id="modal">
    <div class="modal">
        <h3 id="modal-title"></h3>
        <div id="modal-form"></div>
        <div style="text-align:right; margin-top:10px;">
            <button onclick="closeModal()">Cancelar</button>
            <button onclick="saveItem()" style="background:#ff4d00; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Guardar</button>
        </div>
    </div>
</div>

<script>
    const APPWEB_URL = "https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";
    let inventario = [], categorias = [], tiendas = [], pendingOps = [];
    let editItemIndex = null;
    let currentView = 'dashboard';
    let currentSearch = '';
    const STORAGE_KEY = 'inventario3a';

    // ————— Sidebar & Acordeon —————
    document.getElementById('toggleSidebar').onclick = function() {
        document.getElementById('sidebar').classList.toggle('collapsed');
    };

    function toggleAccordion(button) {
        // Cierra todos los paneles, excepto el que ya está activo
        document.querySelectorAll('.accordion').forEach(acc => {
            if (acc !== button && acc.classList.contains('active')) {
                acc.classList.remove('active');
                acc.nextElementSibling.style.maxHeight = null;
            }
        });

        // Toggle del panel actual
        button.classList.toggle('active');
        const panel = button.nextElementSibling;
        if (panel.style.maxHeight) {
            panel.style.maxHeight = null;
        } else {
            panel.style.maxHeight = panel.scrollHeight + "px";
        }
    }

    // Attach toggleAccordion to all accordions
    document.querySelectorAll('.accordion').forEach(button => {
        // Prevents navigation button in the panel from triggering the accordion logic
        if (button.innerText.includes('Dashboard')) {
            button.onclick = () => { nav('dashboard'); toggleAccordion(button); };
        } else {
            button.onclick = () => toggleAccordion(button);
        }
    });

    // ————— Local Storage —————
    function saveData(){
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ inventario, categorias, tiendas, pendingOps }));
    }
    function loadData(){
        const data = localStorage.getItem(STORAGE_KEY);
        if(data){
            const parsed = JSON.parse(data);
            inventario = parsed.inventario || [];
            categorias = parsed.categorias || [];
            tiendas = parsed.tiendas || [];
            pendingOps = parsed.pendingOps || [];
        }
    }

    // ————— Fetch inicial desde Sheets —————
    async function fetchSheet(sheet){
        try {
            // Se añade un timestamp para evitar caché
            const res = await fetch(`${APPWEB_URL}?sheet=${sheet}&action=get&t=${Date.now()}`); 
            const json = await res.json();
            return json.map(row => ({
                idSheet: row.id,
                nombre: row.nombre || row.Nombre || row.Categoria || row.Tienda || '',
                Codigo: row.Codigo || '',
                Serie: row.Serie || '',
                Equipo: row.Equipo || '',
                Marca: row.Marca || '',
                Modelo: row.Modelo || '',
                Categoria: row.Categoria || '',
                Tienda: row.Tienda || ''
            }));
        } catch(e) {
            console.warn(`Error fetchSheet (${sheet}):`, e);
            return [];
        }
    }

    async function loadInitialData(){
        const [inv, cat, td] = await Promise.all([
            fetchSheet('Inventario'),
            fetchSheet('Categorias'),
            fetchSheet('Tiendas')
        ]);
        inventario = inv;
        categorias = cat;
        tiendas = td;
        pendingOps = []; // Clear pending ops on successful initial load
        saveData();
        render(); // Render with the fresh data
    }

    // ————— Sincronización —————
    async function syncItem(tipo, item, action){
        let sheet = (tipo === 'inventario') ? 'Inventario' : (tipo === 'categoria' ? 'Categorias' : 'Tiendas');
        const params = new URLSearchParams({ sheet, action });

        if(action === 'add'){
            Object.keys(item).forEach(k => {
                if(k !== 'idLocal') params.append(k, item[k] || '');
            });
        } else if(action === 'update' || action === 'delete'){
            // Usamos idSheet para identificar la fila en Google Sheets
            params.append('idCol', 'id').append('idValue', item.idSheet); 
            if(action === 'update'){
                Object.keys(item).forEach(k => {
                    if(k !== 'idLocal' && k !== 'idSheet'){
                        params.append(k, item[k] || '');
                    }
                });
            }
        }
        
        try {
            const res = await fetch(`${APPWEB_URL}?${params.toString()}`);
            const data = await res.json();
            if(action === 'add' && data.id){
                item.idSheet = data.id;
                // Busca y actualiza el item local si tiene un idLocal temporal
                replaceLocalId(item); 
            }
            return true;
        } catch (e) {
             // Si falla la sincronización, el item sigue en pendingOps
            console.warn("syncItem error:", e);
            return false;
        }
    }

    function replaceLocalId(item){
        let arr = (item.Equipo !== undefined) ? inventario : (item.Tienda !== undefined ? tiendas : categorias);
        let idx = arr.findIndex(r => r.idLocal === item.idLocal);
        if(idx >= 0 && arr[idx].idLocal === item.idLocal){ // Safety check
            arr[idx].idSheet = item.idSheet;
            delete arr[idx].idLocal;
        }
    }

    async function syncPending(){
        if(pendingOps.length === 0) return;
        
        let successfulOps = [];
        for(let op of pendingOps){
            const success = await syncItem(op.tipo, op.item, op.action);
            if(success){
                successfulOps.push(op);
            }
        }
        
        // Remove only successful operations
        pendingOps = pendingOps.filter(p => !successfulOps.includes(p));
        saveData();
    }

    // ————— Modal / Formulario —————
    function openAddForm(tipo, index = null){
        editItemIndex = index;
        document.getElementById('modal').style.display = 'flex';
        const titleEl = document.getElementById('modal-title');
        const form = document.getElementById('modal-form');
        form.innerHTML = '';
        form.dataset.tipo = tipo;

        if(tipo === 'inventario'){
            titleEl.innerText = (index !== null ? 'Editar' : 'Agregar') + ' Inventario';
            const fields = ['Codigo','Serie','Equipo','Marca','Modelo'];
            fields.forEach(k => {
                const inp = document.createElement('input');
                inp.placeholder = k;
                inp.id = 'f_' + k;
                form.appendChild(inp);
            });
            
            // Combobox Categoría
            const catSel = document.createElement('select');
            catSel.id = 'f_Categoria';
            catSel.innerHTML = '<option value="">Seleccione Categoría</option>';
            categorias.forEach(c => {
                catSel.innerHTML += `<option value="${c.nombre}">${c.nombre}</option>`;
            });
            form.appendChild(catSel);
            
            // Combobox Tienda
            const tSel = document.createElement('select');
            tSel.id = 'f_Tienda';
            tSel.innerHTML = '<option value="">Seleccione Tienda</option>';
            tiendas.forEach(t => {
                tSel.innerHTML += `<option value="${t.nombre}">${t.nombre}</option>`;
            });
            form.appendChild(tSel);
            
            // Fill data for edit mode
            if(index !== null){
                const item = inventario[index];
                fields.forEach(k => document.getElementById('f_' + k).value = item[k] || '');
                catSel.value = item.Categoria || '';
                tSel.value = item.Tienda || '';
            }

        } else {
            const name = tipo.charAt(0).toUpperCase() + tipo.slice(1);
            titleEl.innerText = (index !== null ? 'Editar' : 'Agregar') + ' ' + name;
            const inp = document.createElement('input');
            inp.placeholder = 'Nombre de la ' + name;
            inp.id = 'f_nombre';
            form.appendChild(inp);
            
            // Fill data for edit mode
            if(index !== null){
                const item = tipo === 'categoria' ? categorias[index] : tiendas[index];
                document.getElementById('f_nombre').value = item.nombre || '';
            }
        }
    }

    function closeModal(){
        document.getElementById('modal').style.display = 'none';
        editItemIndex = null;
    }

    function saveItem(){
        const form = document.getElementById('modal-form');
        const tipo = form.dataset.tipo;
        let obj = {};
        const isEditing = editItemIndex !== null;

        if(tipo === 'inventario'){
            const arr = inventario;
            const item = isEditing ? arr[editItemIndex] : {};
            
            obj = {
                // Keep the original IDs for reference, but Sheet uses idSheet/idLocal
                idSheet: item.idSheet || null, 
                idLocal: item.idLocal || null,
                Codigo: document.getElementById('f_Codigo').value,
                Serie: document.getElementById('f_Serie').value,
                Equipo: document.getElementById('f_Equipo').value,
                Marca: document.getElementById('f_Marca').value,
                Modelo: document.getElementById('f_Modelo').value,
                Categoria: document.getElementById('f_Categoria').value,
                Tienda: document.getElementById('f_Tienda').value
            };
            
            if(isEditing) arr[editItemIndex] = obj;
            else {
                obj.idLocal = crypto.randomUUID(); // Unique ID for unsynced item
                arr.push(obj);
            }
        } else if(tipo === 'categoria' || tipo === 'tienda'){
            const arr = tipo === 'categoria' ? categorias : tiendas;
            const item = isEditing ? arr[editItemIndex] : {};
            
            obj = {
                idSheet: item.idSheet || null,
                idLocal: item.idLocal || null,
                nombre: document.getElementById('f_nombre').value
            };
            
            if(isEditing) arr[editItemIndex] = obj;
            else {
                obj.idLocal = crypto.randomUUID();
                arr.push(obj);
            }
        }

        // Add to pending operations
        const action = isEditing ? 'update' : 'add';
        pendingOps.push({ tipo, action, item: obj });
        
        saveData();
        render();
        closeModal();
    }

    // ————— Edit / Delete —————
    function editItemFunc(tipo, index){
        openAddForm(tipo, index);
    }

    function deleteItem(tipo, index){
        if(!confirm('¿Eliminar este registro?')) return;
        
        const arr = (tipo === 'inventario' ? inventario : (tipo === 'categoria' ? categorias : tiendas));
        const item = arr[index];
        
        if(item.idSheet){
            // Only add to pendingOps if the item has been synced before
            pendingOps.push({ tipo, action: 'delete', item: item });
        }
        
        // Remove item from local array
        arr.splice(index, 1); 
        
        saveData();
        render();
    }

    // ————— Búsqueda (Filtro) —————
    function applySearch(query){
        currentSearch = query.toLowerCase();
        render();
    }

    function filterData(arr){
        if (!currentSearch) return arr;
        
        return arr.filter(item => {
            return Object.values(item).some(value => 
                (value || '').toString().toLowerCase().includes(currentSearch)
            );
        });
    }

    // ————— Render —————
    function render(){
        const c = document.getElementById('content');
        const titleEl = document.getElementById('main-title');
        c.innerHTML = '';
        currentSearch = ''; // Clear search on view change

        if(currentView === 'dashboard'){
            titleEl.innerText = 'Dashboard de Inventario';
            const cards = document.createElement('div');
            cards.className = 'cards';
            
            const createCard = (label, count, view, icon) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<i class="fa-solid ${icon}"></i><span>${label}: ${count}</span>`;
                card.onclick = () => nav(view);
                return card;
            };

            cards.appendChild(createCard('Equipos', inventario.length, 'inventario', 'fa-computer'));
            cards.appendChild(createCard('Categorías', categorias.length, 'categoria', 'fa-tags'));
            cards.appendChild(createCard('Tiendas', tiendas.length, 'tienda', 'fa-store'));
            
            const pendingCard = createCard('Pendientes', pendingOps.length, 'dashboard', 'fa-sync-alt');
            pendingCard.style.backgroundColor = pendingOps.length > 0 ? '#ffb86b' : 'lightgreen';
            pendingCard.style.color = pendingOps.length > 0 ? 'white' : 'green';
            pendingCard.onclick = syncPending; // Trigger sync on click
            cards.appendChild(pendingCard);
            
            c.appendChild(cards);
        } else {
            // Setup Search Bar for table views
            const searchBar = document.createElement('div');
            searchBar.className = 'search-bar';
            searchBar.innerHTML = `<input type="text" id="search-input" placeholder="Buscar en tabla..." onkeyup="applySearch(this.value)">`;
            c.appendChild(searchBar);
            
            let arr = [];
            let headers = [];
            let tipoTitle = '';

            if(currentView === 'inventario'){
                titleEl.innerText = 'Ver Inventario';
                arr = filterData(inventario);
                headers = ['ID', 'Código', 'Serie', 'Equipo', 'Marca', 'Modelo', 'Categoría', 'Tienda', 'Acciones'];
                tipoTitle = 'inventario';
            } else if(currentView === 'categoria'){
                titleEl.innerText = 'Ver Categorías';
                arr = filterData(categorias);
                headers = ['ID', 'Nombre', 'Acciones'];
                tipoTitle = 'categoria';
            } else if(currentView === 'tienda'){
                titleEl.innerText = 'Ver Tiendas';
                arr = filterData(tiendas);
                headers = ['ID', 'Nombre', 'Acciones'];
                tipoTitle = 'tienda';
            }

            const tbl = document.createElement('table');
            // Headers
            tbl.innerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
            
            // Body
            const tb = document.createElement('tbody');
            arr.forEach((item, idx) => {
                const tr = document.createElement('tr');
                
                let cells = [];
                if(currentView === 'inventario'){
                    cells = [
                        item.idSheet || 'PENDIENTE',
                        item.Codigo, item.Serie, item.Equipo, item.Marca, item.Modelo, item.Categoria, item.Tienda
                    ];
                } else {
                    cells = [item.idSheet || 'PENDIENTE', item.nombre];
                }
                
                const dataCells = cells.map(cell => `<td>${cell}</td>`).join('');
                
                tr.innerHTML = `${dataCells}
                    <td class="actions">
                        <button class="btn-edit" onclick="editItemFunc('${tipoTitle}',${inventario.indexOf(item) !== -1 ? inventario.indexOf(item) : categorias.indexOf(item) !== -1 ? categorias.indexOf(item) : tiendas.indexOf(item) !== -1 ? tiendas.indexOf(item) : idx})"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-del" onclick="deleteItem('${tipoTitle}',${inventario.indexOf(item) !== -1 ? inventario.indexOf(item) : categorias.indexOf(item) !== -1 ? categorias.indexOf(item) : tiendas.indexOf(item) !== -1 ? tiendas.indexOf(item) : idx})"><i class="fa-solid fa-trash"></i></button>
                    </td>`;
                tb.appendChild(tr);
            });
            
            tbl.appendChild(tb);
            c.appendChild(tbl);
        }
    }

    // ————— Navegación —————
    function nav(view){
        currentView = view;
        // Close all accordion panels when navigating, except the active one (handled by toggleAccordion)
        
        // Find the corresponding accordion button and activate it
        const viewToButtonMap = {
            'dashboard': document.querySelector('.menu-section .accordion i.fa-house').closest('button'),
            'inventario': document.querySelector('.menu-section .accordion i.fa-computer').closest('button'),
            'categoria': document.querySelector('.menu-section .accordion i.fa-tags').closest('button'),
            'tienda': document.querySelector('.menu-section .accordion i.fa-store').closest('button')
        };

        const targetButton = viewToButtonMap[view];
        if (targetButton && !targetButton.classList.contains('active')) {
             // Only toggle if not already active to avoid closing the panel immediately
            toggleAccordion(targetButton); 
        }

        render();
    }

    // ————— Inicialización —————
    loadData(); // 1. Load data from local storage (quick display)
    nav(currentView); // 2. Render initial view (default dashboard)

    // 3. Load actual data from webapp, save and re-render
    loadInitialData(); 

    // 4. Start sync process
    setInterval(syncPending, 10000); // Sync every 10 seconds
</script>

</body>
</html>
