<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body,html{margin:0;padding:0;font-family:sans-serif;}
*{box-sizing:border-box;}
.sidebar{width:260px;position:fixed;height:100%;background:#ff4d00;color:white;display:flex;flex-direction:column;gap:12px;padding:20px;transition:0.3s;}
.sidebar.collapsed{width:60px;padding:20px 5px;}
.brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:1.2rem;position:relative;}
#toggleSidebar{position:absolute;right:10px;top:10px;background:#ff4d00;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;}
.menu-section button{background:transparent;color:white;border:none;padding:10px;width:100%;display:flex;align-items:center;gap:10px;cursor:pointer;}
.menu-section .panel{display:flex;flex-direction:column;padding-left:10px;gap:6px;}
.sidebar.collapsed .brand span,
.sidebar.collapsed .menu-section button span{display:none;}
.main{margin-left:260px;padding:20px;transition:0.3s;}
.sidebar.collapsed ~ .main{margin-left:60px;}
.cards{display:flex;gap:20px;margin-top:20px;flex-wrap:wrap;}
.card{flex:1;min-width:150px;background:white;color:#ff4d00;padding:15px;border-radius:12px;text-align:center;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.card span{font-weight:700;font-size:1.2rem;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#ff4d00;color:white;}
.actions button{margin:0 2px;padding:6px;border-radius:50%;border:none;cursor:pointer;width:32px;height:32px;}
.btn-edit{background:#ffb86b;color:white;}
.btn-del{background:#6b0000;color:white;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:50;}
.modal{background:white;padding:20px;border-radius:12px;width:400px;max-width:95%;}
input,select{padding:6px;border-radius:6px;border:1px solid #ccc;width:100%;margin-bottom:8px;}
@media(max-width:768px){.sidebar{left:-260px;position:fixed}.sidebar.collapsed{left:0}.main{margin-left:0}}
</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="brand">
    <i class="fa-solid fa-boxes-stacked"></i><span>3A</span>
    <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
  </div>

  <div class="menu-section">
    <button onclick="nav('dashboard')"><i class="fa-solid fa-house"></i><span>Dashboard</span></button>
  </div>

  <div class="menu-section">
    <button onclick="openAddForm('inventario')"><i class="fa-solid fa-plus"></i><span>Agregar Inventario</span></button>
    <button onclick="nav('inventario')"><i class="fa-solid fa-computer"></i><span>Ver Inventario</span></button>
  </div>

  <div class="menu-section">
    <button onclick="openAddForm('categoria')"><i class="fa-solid fa-plus"></i><span>Agregar Categor√≠a</span></button>
    <button onclick="nav('categoria')"><i class="fa-solid fa-tags"></i><span>Ver Categor√≠as</span></button>
  </div>

  <div class="menu-section">
    <button onclick="openAddForm('tienda')"><i class="fa-solid fa-plus"></i><span>Agregar Tienda</span></button>
    <button onclick="nav('tienda')"><i class="fa-solid fa-store"></i><span>Ver Tiendas</span></button>
  </div>
</aside>

<div class="main">
  <h2>Inventario de Tienda</h2>
  <div id="content"></div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h3 id="modal-title"></h3>
    <div id="modal-form"></div>
    <div style="text-align:right;margin-top:10px;">
      <button onclick="closeModal()">Cancelar</button>
      <button onclick="saveItem()">Guardar</button>
    </div>
  </div>
</div>

<script>
const APPWEB_URL="https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";
let inventario=[], categorias=[], tiendas=[];
let editItemIndex=null;
let currentView='dashboard';
const STORAGE_KEY='inventario3a';

// Cargar desde localStorage
function loadData(){
  const data=localStorage.getItem(STORAGE_KEY);
  if(data){
    const parsed=JSON.parse(data);
    inventario=parsed.inventario||[];
    categorias=parsed.categorias||[];
    tiendas=parsed.tiendas||[];
  }
}

// Guardar en localStorage
function saveData(){localStorage.setItem(STORAGE_KEY,JSON.stringify({inventario,categorias,tiendas}));}

// Cargar desde Google Sheet al iniciar
async function fetchSheet(sheet){
  try{
    const res=await fetch(`${APPWEB_URL}?sheet=${sheet}&action=get`);
    return await res.json();
  }catch(e){console.warn("Error fetching sheet",e); return [];}
}

async function loadInitialData(){
  const [inv,cat,td]=await Promise.all([fetchSheet('Inventario'),fetchSheet('Categorias'),fetchSheet('Tiendas')]);
  inventario=inv.map((i,idx)=>({...i,id:idx+1}));
  categorias=cat.map((c,idx)=>({...c,id:idx+1}));
  tiendas=td.map((t,idx)=>({...t,id:idx+1}));
  saveData();
  render();
}

// Sincronizaci√≥n con app web
async function syncItem(tipo,item,action){
  let sheet="";
  if(tipo==="inventario") sheet="Inventario";
  else if(tipo==="categoria") sheet="Categorias";
  else if(tipo==="tienda") sheet="Tiendas";

  const params=new URLSearchParams({sheet,action});
  if(action==="add" || action==="update"){
    Object.keys(item).forEach(k=>params.append(k,item[k]));
    if(action==="update") params.append("idCol","id").append("idValue",item.id);
  }
  try{
    await fetch(`${APPWEB_URL}?${params.toString()}`).then(r=>r.json());
  }catch(e){console.warn("Error sincronizando:",e);}
}

// Navegaci√≥n
function nav(view){currentView=view; render();}
document.getElementById('toggleSidebar').onclick=function(){document.getElementById('sidebar').classList.toggle('collapsed');};

// Render
function render(){
  const c=document.getElementById('content');
  if(currentView==='dashboard'){
    c.innerHTML=`
      <div class="cards">
        <div class="card" onclick="nav('inventario')">
          <i class="fa-solid fa-computer"></i><span>Inventario (${inventario.length})</span>
        </div>
        <div class="card" onclick="nav('categoria')">
          <i class="fa-solid fa-tags"></i><span>Categor√≠as (${categorias.length})</span>
        </div>
        <div class="card" onclick="nav('tienda')">
          <i class="fa-solid fa-store"></i><span>Tiendas (${tiendas.length})</span>
        </div>
      </div>
    `;
  } else if(currentView==='inventario'){
    let table=`<table><thead><tr><th>#</th><th>C√≥digo</th><th>Equipo</th><th>Marca</th><th>Modelo</th><th>Categoria</th><th>Tienda</th><th>Acciones</th></tr></thead><tbody>`;
    inventario.forEach((i,idx)=>{
      table+=`<tr><td>${i.id}</td><td>${i.codigo}</td><td>${i.equipo}</td><td>${i.marca}</td><td>${i.modelo}</td><td>${i.categoria}</td><td>${i.tienda}</td>
      <td class="actions">
        <button class="btn-edit" onclick="editItemFunc(${idx})">‚úèÔ∏è</button>
        <button class="btn-del" onclick="deleteItem(${idx})">üóëÔ∏è</button>
      </td></tr>`;
    });
    table+='</tbody></table>';
    c.innerHTML=table;
  } else if(currentView==='categoria'){
    let table=`<table><thead><tr><th>#</th><th>Nombre</th><th>Acciones</th></tr></thead><tbody>`;
    categorias.forEach((cat,idx)=>{
      table+=`<tr><td>${cat.id}</td><td>${cat.nombre}</td>
      <td class="actions">
        <button class="btn-edit" onclick="editItemFunc(${idx},'categoria')">‚úèÔ∏è</button>
        <button class="btn-del" onclick="deleteItem(${idx},'categoria')">üóëÔ∏è</button>
      </td></tr>`;
    });
    table+='</tbody></table>';
    c.innerHTML=table;
  } else if(currentView==='tienda'){
    let table=`<table><thead><tr><th>#</th><th>Nombre</th><th>Acciones</th></tr></thead><tbody>`;
    tiendas.forEach((t,idx)=>{
      table+=`<tr><td>${t.id}</td><td>${t.nombre}</td>
      <td class="actions">
        <button class="btn-edit" onclick="editItemFunc(${idx},'tienda')">‚úèÔ∏è</button>
        <button class="btn-del" onclick="deleteItem(${idx},'tienda')">üóëÔ∏è</button>
      </td></tr>`;
    });
    table+='</tbody></table>';
    c.innerHTML=table;
  }
}

// Modal
function openAddForm(tipo){
  editItemIndex=null;
  document.getElementById('modal-title').innerText=tipo==='inventario'?'Agregar Inventario':tipo==='categoria'?'Agregar Categor√≠a':'Agregar Tienda';
  const f=document.getElementById('modal-form');
  if(tipo==='inventario'){
    f.innerHTML=`
      <input id="codigo" placeholder="C√≥digo *"/>
      <input id="equipo" placeholder="Equipo *"/>
      <input id="marca" placeholder="Marca"/>
      <input id="modelo" placeholder="Modelo"/>
      <select id="categoria"><option value="">Seleccione Categor√≠a</option>${categorias.map(c=>`<option value="${c.nombre}">${c.nombre}</option>`).join('')}</select>
      <select id="tienda"><option value="">Seleccione Tienda</option>${tiendas.map(t=>`<option value="${t.nombre}">${t.nombre}</option>`).join('')}</select>
    `;
  } else {
    f.innerHTML=`<input id="nombre" placeholder="Nombre *"/>`;
  }
  f.dataset.tipo=tipo;
  document.getElementById('modal').style.display='flex';
}

function closeModal(){document.getElementById('modal').style.display='none';}

// Guardar
function saveItem(){
  const tipo=document.getElementById('modal-form').dataset.tipo;
  if(tipo==='inventario'){
    const codigo=document.getElementById('codigo').value.trim();
    const equipo=document.getElementById('equipo').value.trim();
    const marca=document.getElementById('marca').value.trim();
    const modelo=document.getElementById('modelo').value.trim();
    const categoria=document.getElementById('categoria').value;
    const tienda=document.getElementById('tienda').value;
    if(!codigo||!equipo||!categoria||!tienda){alert('Complete todos los campos');return;}
    if(editItemIndex!==null){
      inventario[editItemIndex]={...inventario[editItemIndex],codigo,equipo,marca,modelo,categoria,tienda};
      syncItem('inventario',inventario[editItemIndex],'update');
    } else {
      const id=inventario.length>0?inventario[inventario.length-1].id+1:1;
      const newItem={id,codigo,equipo,marca,modelo,categoria,tienda};
      inventario.push(newItem);
      syncItem('inventario',newItem,'add');
    }
  } else if(tipo==='categoria'){
    const nombre=document.getElementById('nombre').value.trim();
    if(!nombre){alert('Ingrese nombre');return;}
    if(editItemIndex!==null){
      categorias[editItemIndex].nombre=nombre;
      syncItem('categoria',categorias[editItemIndex],'update');
    } else {
      const id=categorias.length>0?categorias[categorias.length-1].id+1:1;
      const newItem={id,nombre};
      categorias.push(newItem);
      syncItem('categoria',newItem,'add');
    }
  } else if(tipo==='tienda'){
    const nombre=document.getElementById('nombre').value.trim();
    if(!nombre){alert('Ingrese nombre');return;}
    if(editItemIndex!==null){
      tiendas[editItemIndex].nombre=nombre;
      syncItem('tienda',tiendas[editItemIndex],'update');
    } else {
      const id=tiendas.length>0?tiendas[tiendas.length-1].id+1:1;
      const newItem={id,nombre};
      tiendas.push(newItem);
      syncItem('tienda',newItem,'add');
    }
  }
  saveData();
  closeModal();
  render();
}

// Editar
function editItemFunc(idx,tipo='inventario'){
  editItemIndex=idx;
  openAddForm(tipo);
  if(tipo==='inventario'){
    const i=inventario[idx];
    document.getElementById('codigo').value=i.codigo;
    document.getElementById('equipo').value=i.equipo;
    document.getElementById('marca').value=i.marca;
    document.getElementById('modelo').value=i.modelo;
    document.getElementById('categoria').value=i.categoria;
    document.getElementById('tienda').value=i.tienda;
  } else if(tipo==='categoria'){
    document.getElementById('nombre').value=categorias[idx].nombre;
  } else if(tipo==='tienda'){
    document.getElementById('nombre').value=tiendas[idx].nombre;
  }
}

// Eliminar
function deleteItem(idx,tipo='inventario'){
  if(confirm('Seguro eliminar?')){
    let item;
    if(tipo==='inventario'){item=inventario[idx]; inventario.splice(idx,1);}
    else if(tipo==='categoria'){item=categorias[idx]; categorias.splice(idx,1);}
    else if(tipo==='tienda'){item=tiendas[idx]; tiendas.splice(idx,1);}
    saveData();
    syncItem(tipo,item,'delete');
    render();
  }
}

// Inicializar
loadData();
loadInitialData();
</script>

</body>
</html>
