<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body, html { margin:0; padding:0; font-family:sans-serif; background:#f5f6fa; color:#333; }
header { background:#2c3e50; color:#fff; padding:10px 20px; display:flex; align-items:center; justify-content:space-between; }
header h1 { font-size:20px; }
#sidebar { background:#34495e; color:white; width:220px; height:100vh; position:fixed; top:0; left:0; overflow:auto; transition:width 0.3s; }
#sidebar.collapsed { width:60px; }
#sidebar h2 { text-align:center; padding:15px; margin:0; font-size:18px; }
#sidebar ul { list-style:none; padding:0; margin:0; }
#sidebar ul li { padding:12px 20px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.1); }
#sidebar ul li:hover { background:#3d566e; }
#sidebar ul li i { margin-right:10px; }
#main { margin-left:220px; padding:20px; transition:margin-left 0.3s; }
#sidebar.collapsed + #main { margin-left:60px; }
.card { background:white; border-radius:12px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin:10px; text-align:center; cursor:pointer; display:inline-block; width:180px; transition:transform 0.2s; }
.card:hover { transform:scale(1.05); }
.card i { font-size:30px; margin-bottom:10px; color:#2980b9; }
.card span { display:block; font-size:22px; font-weight:bold; color:#27ae60; }
table { width:100%; border-collapse:collapse; margin-top:15px; background:white; border-radius:10px; overflow:hidden; }
th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
th { background:#3498db; color:white; }
.actions { text-align:center; }
.actions button { border:none; background:none; cursor:pointer; margin:0 5px; font-size:16px; }
.btn-edit { color:#2980b9; }
.btn-del { color:#e74c3c; }
.search-bar { margin-bottom:10px; display:flex; justify-content:space-between; }
.search-bar input { padding:8px; width:200px; border-radius:6px; border:1px solid #ccc; }
.add-btn { background:#27ae60; color:white; padding:8px 15px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
#modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:999; }
.modal-content { background:white; padding:20px; border-radius:10px; width:90%; max-width:400px; }
.modal-content input, .modal-content select { width:100%; margin-bottom:10px; padding:8px; border-radius:6px; border:1px solid #ccc; }
.modal-content h3 { margin-top:0; text-align:center; }
.modal-actions { text-align:right; }
.modal-actions button { padding:8px 15px; margin-left:5px; border:none; border-radius:6px; cursor:pointer; }
.modal-actions .cancel { background:#e74c3c; color:white; }
.modal-actions .save { background:#27ae60; color:white; }
</style>
</head>
<body>

<header>
  <h1>Inventario Tiendas 3A</h1>
  <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
</header>

<div id="sidebar">
  <h2>Menú</h2>
  <ul>
    <li onclick="renderDashboard()"><i class="fa-solid fa-chart-line"></i> Dashboard</li>
    <li onclick="renderTable('tienda')"><i class="fa-solid fa-store"></i> Tiendas</li>
    <li onclick="renderTable('categoria')"><i class="fa-solid fa-tags"></i> Categorías</li>
    <li onclick="renderTable('inventario')"><i class="fa-solid fa-boxes-stacked"></i> Inventario</li>
  </ul>
</div>

<div id="main">
  <h2 id="main-title">Dashboard</h2>
  <div id="dashboard-cards"></div>
  <div id="content"></div>
</div>

<!-- Modal -->
<div id="modal">
  <div class="modal-content">
    <h3 id="modal-title">Agregar</h3>
    <div id="modal-form"></div>
    <div class="modal-actions">
      <button class="cancel" onclick="closeModal()">Cancelar</button>
      <button class="save" onclick="saveItem()">Guardar</button>
    </div>
  </div>
</div>

<script>
const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxZYvau-tS7jCLqsNmwUkxK4wfkcL2AveUVJGUNKw2nPhFsMPt4Yw0dh-PYjsieW2j9HA/exec';
let dataStore = { tienda:[], categoria:[], inventario:[] };
let currentSheet = '';
let editingIndex = null;

// Sidebar toggle
document.getElementById('toggleSidebar').addEventListener('click',()=>{ 
  document.getElementById('sidebar').classList.toggle('collapsed'); 
});

// Cargar datos
function fetchSheet(sheet){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).substring(2);
    window[cb]=res=>{
      if(res.success){
        dataStore[sheet]=res.data.map((r,i)=>({ ...r, id:Number(r.id)||i+1 }));
        resolve();
      } else reject(res.msg);
      delete window[cb];
    };
    const s=document.createElement('script');
    s.src=`${APP_SCRIPT_URL}?sheet=${sheet}&callback=${cb}`;
    s.onerror=()=>reject('Error cargando');
    document.body.appendChild(s);
  });
}

// Render tabla
function renderTable(sheet){
  currentSheet=sheet;
  document.getElementById('main-title').textContent=sheet.charAt(0).toUpperCase()+sheet.slice(1);
  const data=dataStore[sheet];
  let html=`<div class="search-bar">
    <input type="text" placeholder="Buscar..." oninput="filterTable(this.value)">
    <button class="add-btn" onclick="openAddForm('${sheet}')">+ Agregar</button>
  </div>`;
  if(!data.length){ html+=`<p>No hay datos registrados</p>`; document.getElementById('content').innerHTML=html; return; }
  const keys=Object.keys(data[0]);
  html+=`<table><thead><tr>`;
  keys.forEach(k=>html+=`<th>${k}</th>`);
  html+=`<th>Acciones</th></tr></thead><tbody>`;
  data.forEach((r,i)=>{
    html+=`<tr>${keys.map(k=>`<td>${r[k]}</td>`).join('')}
      <td class="actions">
        <button class="btn-edit" onclick="editItem(${i})"><i class="fa-solid fa-pen"></i></button>
        <button class="btn-del" onclick="deleteItem(${i})"><i class="fa-solid fa-trash"></i></button>
      </td></tr>`;
  });
  html+=`</tbody></table>`;
  document.getElementById('content').innerHTML=html;
}

// Buscar
function filterTable(val){
  document.querySelectorAll('tbody tr').forEach(r=>{
    r.style.display = r.textContent.toLowerCase().includes(val.toLowerCase())?'':'none';
  });
}

// Modal
function openAddForm(sheet,i=null){
  currentSheet=sheet; editingIndex=i;
  const t = sheet.charAt(0).toUpperCase()+sheet.slice(1);
  document.getElementById('modal-title').textContent = (i!==null?'Editar ':'Agregar ')+t;
  let item=i!==null?dataStore[sheet][i]:{};
  let html='';
  if(sheet==='tienda'){
    html=`<input id="codigo" placeholder="Código" value="${item.codigo||''}">
          <input id="nombre" placeholder="Nombre" value="${item.nombre||''}">`;
  } else if(sheet==='categoria'){
    html=`<input id="nombre" placeholder="Nombre" value="${item.nombre||''}">`;
  } else {
    html=`<input id="codigo" placeholder="Código" value="${item.codigo||''}">
          <input id="serie" placeholder="Serie" value="${item.serie||''}">
          <input id="equipo" placeholder="Equipo" value="${item.equipo||''}">
          <input id="marca" placeholder="Marca" value="${item.marca||''}">
          <input id="modelo" placeholder="Modelo" value="${item.modelo||''}">
          <select id="categoria"><option value="">Selecciona Categoría</option>${
            dataStore.categoria.map(c=>`<option ${c.nombre===item.categoria?'selected':''}>${c.nombre}</option>`).join('')
          }</select>
          <select id="tienda"><option value="">Selecciona Tienda</option>${
            dataStore.tienda.map(t=>`<option ${t.nombre===item.tienda?'selected':''}>${t.nombre}</option>`).join('')
          }</select>`;
  }
  document.getElementById('modal-form').innerHTML=html;
  document.getElementById('modal').style.display='flex';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }

// Guardar
function saveItem(){
  const form={}; document.querySelectorAll('#modal-form input,#modal-form select').forEach(e=>form[e.id]=e.value.trim());
  if(currentSheet==='tienda' && (!form.codigo||!form.nombre)){ alert('Código y Nombre son obligatorios'); return; }
  if(currentSheet==='tienda' && editingIndex===null && dataStore.tienda.some(t=>t.codigo===form.codigo)){ alert('Código duplicado'); return; }

  const id = editingIndex!==null ? dataStore[currentSheet][editingIndex].id : (dataStore[currentSheet].length?Math.max(...dataStore[currentSheet].map(d=>+d.id))+1:1);
  const newItem={id,...form};
  if(editingIndex!==null) dataStore[currentSheet][editingIndex]=newItem; else dataStore[currentSheet].push(newItem);
  closeModal(); renderTable(currentSheet);

  fetch(APP_SCRIPT_URL,{method:'POST',body:new URLSearchParams({...newItem,sheet:currentSheet,action:editingIndex!==null?'update':'add',idValue:id})})
  .then(r=>r.json()).then(res=>{if(!res.success)alert('Error sincronizando: '+res.msg);});
}

// Editar
function editItem(i){ openAddForm(currentSheet,i); }

// Eliminar (sin duplicar y reestructurando IDs correctamente)
function deleteItem(i){
  if(!confirm('¿Eliminar registro?')) return;
  const sheet=currentSheet;
  const delId=dataStore[sheet][i].id;
  dataStore[sheet].splice(i,1);
  dataStore[sheet].forEach((it,idx)=>it.id=idx+1);
  renderTable(sheet);

  // Eliminar en App Web
  fetch(APP_SCRIPT_URL,{method:'POST',body:new URLSearchParams({sheet,action:'delete',idValue:delId})});

  // Actualizar reestructura en App Web
  dataStore[sheet].forEach(it=>{
    fetch(APP_SCRIPT_URL,{method:'POST',body:new URLSearchParams({...it,sheet,action:'update',idValue:it.id})});
  });
}

// Dashboard
function renderDashboard(){
  const d=document.getElementById('dashboard-cards');
  d.innerHTML=`
    <div class="card" onclick="renderTable('inventario')"><i class="fa-solid fa-box"></i><span>${dataStore.inventario.length}</span>Inventario</div>
    <div class="card" onclick="renderTable('categoria')"><i class="fa-solid fa-tags"></i><span>${dataStore.categoria.length}</span>Categorías</div>
    <div class="card" onclick="renderTable('tienda')"><i class="fa-solid fa-store"></i><span>${dataStore.tienda.length}</span>Tiendas</div>`;
  document.getElementById('content').innerHTML='';
}

// Iniciar
Promise.all([fetchSheet('tienda'),fetchSheet('categoria'),fetchSheet('inventario')])
.then(()=>renderDashboard());
</script>
</body>
</html>

