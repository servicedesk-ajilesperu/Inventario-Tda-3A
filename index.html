<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario Tiendas 3A</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    body{margin:0;font-family:sans-serif;background:#f5f6fa;display:flex;height:100vh;overflow:hidden}
    aside{width:240px;background:#ff6600;color:#fff;display:flex;flex-direction:column;transition:.3s}
    aside h2{padding:1rem;text-align:center;margin:0;font-size:1.2rem}
    nav{flex:1;overflow-y:auto}
    nav button{width:100%;background:none;border:none;color:#fff;text-align:left;padding:1rem;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
    nav button:hover{background:#e65c00}
    .submenu{max-height:0;overflow:hidden;transition:max-height .3s ease}
    .submenu.open{max-height:500px}
    .submenu a{display:block;padding:.7rem 2rem;color:#fff;text-decoration:none}
    .submenu a:hover{background:#cc5200}
    main{flex:1;overflow-y:auto;padding:1rem}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1rem}
    .card{background:#fff;padding:1rem;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);text-align:center}
    .card h3{margin:0;font-size:1.5rem;color:#ff6600}
    table{width:100%;border-collapse:collapse;background:#fff;margin-top:1rem}
    th,td{border:1px solid #ddd;padding:.5rem;text-align:left}
    th{background:#ff6600;color:#fff}
    tr:nth-child(even){background:#f9f9f9}
    td button{border:none;background:none;cursor:pointer;font-size:1rem}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
    .modal-content{background:#fff;padding:1rem;border-radius:12px;max-width:400px;width:90%}
    .modal-content label{display:block;margin-top:.5rem}
    .modal-content input,.modal-content select{width:100%;padding:.5rem;margin-top:.2rem}
    .modal-content button{margin-top:1rem;padding:.5rem 1rem;border:none;border-radius:8px;cursor:pointer}
    .btn-primary{background:#ff6600;color:#fff}
    .btn-secondary{background:#ccc}
    @media(max-width:768px){aside{width:70px}aside h2{display:none}nav button{justify-content:center}nav button span{display:none}.submenu a{padding:.7rem}}
  </style>
</head>
<body>
<aside>
  <h2>Tiendas 3A</h2>
  <nav>
    <button onclick="toggleMenu(this)">üì¶ Inventario <i class="fa fa-chevron-down"></i></button>
    <div class="submenu">
      <a href="#" onclick="showSection('inventario')">Ver Inventario</a>
      <a href="#" onclick="openAddForm('inventario')">Agregar Inventario</a>
    </div>
    <button onclick="toggleMenu(this)">üìÇ Categor√≠as <i class="fa fa-chevron-down"></i></button>
    <div class="submenu">
      <a href="#" onclick="showSection('categoria')">Ver Categor√≠as</a>
      <a href="#" onclick="openAddForm('categoria')">Agregar Categor√≠a</a>
    </div>
    <button onclick="toggleMenu(this)">üè¨ Tiendas <i class="fa fa-chevron-down"></i></button>
    <div class="submenu">
      <a href="#" onclick="showSection('tienda')">Ver Tiendas</a>
      <a href="#" onclick="openAddForm('tienda')">Agregar Tienda</a>
    </div>
  </nav>
</aside>

<main>
  <div class="cards">
    <div class="card"><h3 id="countInventario">0</h3><p>Inventario</p></div>
    <div class="card"><h3 id="countCategorias">0</h3><p>Categor√≠as</p></div>
    <div class="card"><h3 id="countTiendas">0</h3><p>Tiendas</p></div>
  </div>
  <div id="section-inventario" class="section">
    <h2>Inventario</h2>
    <table id="tableInventario"><thead><tr>
      <th>ID</th><th>C√≥digo</th><th>Serie</th><th>Equipo</th><th>Marca</th><th>Modelo</th><th>Categor√≠a</th><th>Tienda</th><th>Acciones</th>
    </tr></thead><tbody></tbody></table>
  </div>
  <div id="section-categoria" class="section" style="display:none">
    <h2>Categor√≠as</h2>
    <table id="tableCategoria"><thead><tr>
      <th>ID</th><th>Nombre</th><th>Acciones</th>
    </tr></thead><tbody></tbody></table>
  </div>
  <div id="section-tienda" class="section" style="display:none">
    <h2>Tiendas</h2>
    <table id="tableTienda"><thead><tr>
      <th>ID</th><th>Nombre</th><th>Acciones</th>
    </tr></thead><tbody></tbody></table>
  </div>
</main>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3 id="modalTitle"></h3>
    <form id="form">
      <div id="formFields"></div>
      <button type="submit" class="btn-primary">Guardar</button>
      <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
    </form>
  </div>
</div>

<script>
const APPWEB_URL="TU_URL_DE_APPWEB"; // ‚ö†Ô∏è Coloca tu URL Apps Script aqu√≠
let inventario=[],categorias=[],tiendas=[];
let editTipo=null,editIndex=null;
let pendingOps=[];

/* Sidebar acorde√≥n */
function toggleMenu(btn){
  const sub=btn.nextElementSibling;
  sub.classList.toggle("open");
}

/* Secciones */
function showSection(id){
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById("section-"+id).style.display="block";
}

/* Modal */
function openAddForm(tipo,index=null){
  editTipo=tipo;editIndex=index;
  document.getElementById("modal").style.display="flex";
  const fields=document.getElementById("formFields");
  fields.innerHTML="";
  document.getElementById("modalTitle").innerText=(index===null?"Agregar ":"Editar ")+tipo;
  if(tipo==="inventario"){
    fields.innerHTML=`
      <label>C√≥digo<input name="Codigo"></label>
      <label>Serie<input name="Serie"></label>
      <label>Equipo<input name="Equipo"></label>
      <label>Marca<input name="Marca"></label>
      <label>Modelo<input name="Modelo"></label>
      <label>Categor√≠a<select name="Categoria">${categorias.map(c=>`<option>${c.nombre}</option>`).join("")}</select></label>
      <label>Tienda<select name="Tienda">${tiendas.map(t=>`<option>${t.nombre}</option>`).join("")}</select></label>
    `;
  } else if(tipo==="categoria"){
    fields.innerHTML=`<label>Nombre<input name="nombre"></label>`;
  } else {
    fields.innerHTML=`<label>ID (manual)<input name="id"></label>
                      <label>Nombre<input name="nombre"></label>`;
  }
  if(index!==null){
    const item=(tipo==="inventario"?inventario:tipo==="categoria"?categorias:tiendas)[index];
    Object.keys(item).forEach(k=>{
      const input=fields.querySelector(`[name="${k}"]`);
      if(input) input.value=item[k];
    });
  }
}
function closeModal(){document.getElementById("modal").style.display="none";}

/* Guardar */
document.getElementById("form").onsubmit=e=>{
  e.preventDefault();
  const data=Object.fromEntries(new FormData(e.target));
  if(editIndex!==null){
    const arr=(editTipo==="inventario"?inventario:editTipo==="categoria"?categorias:tiendas);
    data.idSheet=arr[editIndex].idSheet;
    arr[editIndex]={...arr[editIndex],...data};
    pendingOps.push({tipo:editTipo,item:arr[editIndex],action:"update"});
  } else {
    if(editTipo==="tienda" && !data.id) data.id="MANUAL";
    data.idLocal="L"+Date.now();
    const arr=(editTipo==="inventario"?inventario:editTipo==="categoria"?categorias:tiendas);
    arr.push(data);
    pendingOps.push({tipo:editTipo,item:data,action:"add"});
  }
  saveData();render();closeModal();
};

/* Render */
function render(){
  renderTable("inventario",inventario,"tableInventario");
  renderTable("categoria",categorias,"tableCategoria");
  renderTable("tienda",tiendas,"tableTienda");
  document.getElementById("countInventario").innerText=inventario.length;
  document.getElementById("countCategorias").innerText=categorias.length;
  document.getElementById("countTiendas").innerText=tiendas.length;
}
function renderTable(tipo,arr,tableId){
  const tbody=document.querySelector("#"+tableId+" tbody");tbody.innerHTML="";
  arr.forEach((item,i)=>{
    const idMostrar=item.idSheet||item.id||item.idLocal||i+1;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${idMostrar}</td>
      ${tipo==="inventario"?
        `<td>${item.Codigo||""}</td><td>${item.Serie||""}</td><td>${item.Equipo||""}</td>
         <td>${item.Marca||""}</td><td>${item.Modelo||""}</td><td>${item.Categoria||""}</td><td>${item.Tienda||""}</td>`:
        `<td>${item.nombre||""}</td>`}
      <td>
        <button onclick="openAddForm('${tipo}',${i})">‚úèÔ∏è</button>
        <button onclick="deleteItem('${tipo}',${i})">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* Eliminar */
function deleteItem(tipo,index){
  const arr=(tipo==="inventario"?inventario:tipo==="categoria"?categorias:tiendas);
  const item=arr[index];
  if(item.idSheet) pendingOps.push({tipo,item,action:"delete"});
  arr.splice(index,1);
  saveData();render();
}

/* LocalStorage */
function saveData(){localStorage.setItem("inv",JSON.stringify(inventario));
  localStorage.setItem("cat",JSON.stringify(categorias));
  localStorage.setItem("td",JSON.stringify(tiendas));}
function loadData(){inventario=JSON.parse(localStorage.getItem("inv")||"[]");
  categorias=JSON.parse(localStorage.getItem("cat")||"[]");
  tiendas=JSON.parse(localStorage.getItem("td")||"[]");}

/* Sincronizaci√≥n */
async function syncItem(tipo,item,action){
  if(!item) return false;
  const sheet=(tipo==="inventario"?"inventario":tipo==="categoria"?"categoria":"tienda");
  const params=new URLSearchParams();
  params.append("sheet",sheet);params.append("action",action);
  if(action==="add"||action==="update"){
    if(action==="update" && !item.idSheet) return false;
    const fields=(tipo==="inventario"?["Codigo","Serie","Equipo","Marca","Modelo","Categoria","Tienda"]:["id","nombre"]);
    if(action==="update"){params.append("idCol","id");params.append("idValue",item.idSheet);}
    fields.forEach(k=>params.append(k,item[k]||""));
  } else if(action==="delete"){
    if(!item.idSheet) return true;
    params.append("idCol","id");params.append("idValue",item.idSheet);
  }
  try{
    const res=await fetch(`${APPWEB_URL}?${params.toString()}`,{method:"POST"});
    const data=await res.json();
    if(data.success && action==="add" && data.id){
      item.idSheet=data.id;saveData();render();
    }
    return data.success;
  }catch(e){console.warn("syncItem error",e);return false;}
}
async function syncPending(){
  if(pendingOps.length===0) return;
  const ops=[...pendingOps];pendingOps=[];
  for(const op of ops){await syncItem(op.tipo,op.item,op.action);}
  reloadFromServer();
}
async function reloadFromServer(){
  try{
    const res=await fetch(APPWEB_URL+"?action=readAll");
    const data=await res.json();
    inventario=[...data.inventario];categorias=[...data.categoria];tiendas=[...data.tienda];
    saveData();render();
  }catch(e){console.warn("reload error",e);}
}

/* Init */
loadData();render();setInterval(syncPending,5000);reloadFromServer();
</script>
</body>
</html>
