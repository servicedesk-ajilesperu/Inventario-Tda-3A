<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
/* ---------------- ESTILOS GENERALES ---------------- */
body, html { margin:0; padding:0; font-family:sans-serif; background:#f7f7f7; }
* { box-sizing:border-box; }

/* ---------------- SIDEBAR ---------------- */
.sidebar { width:260px; position:fixed; height:100%; background:#ff4d00; color:white; display:flex; flex-direction:column; gap:12px; padding:20px; overflow-y:auto; transition:0.3s; z-index:10; }
.sidebar.collapsed { width:60px; padding:20px 5px; }
.brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:1.2rem; position:relative; margin-bottom:10px; }
#toggleSidebar { position:absolute; right:0; top:0; background:#cc3c00; color:white; border:none; border-radius:6px; padding:4px 8px; cursor:pointer; }

/* ---------------- ACORDEÓN ---------------- */
.menu-section { width:100%; }
.menu-section .accordion { background:transparent; color:white; border:none; padding:10px; width:100%; display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:600; justify-content:space-between; transition:0.2s; border-radius:4px; }
.menu-section .accordion.active, .menu-section .accordion:hover { background-color:#e64500; }
.menu-section .panel { padding:0 10px; max-height:0; overflow:hidden; transition:max-height 0.3s ease-in-out; background-color:#e64500; display:flex; flex-direction:column; gap:4px; }
.menu-section .panel button { background:transparent; color:white; border:none; padding:8px; text-align:left; display:flex; align-items:center; gap:6px; cursor:pointer; width:100%; border-radius:4px; }
.menu-section .panel button:hover { background-color:#cc4000; }

/* Sidebar Colapsado */
.sidebar.collapsed .brand span,
.sidebar.collapsed .menu-section .accordion span,
.sidebar.collapsed .panel button span { display:none; }
.sidebar.collapsed .accordion { justify-content:center; }
.sidebar.collapsed .accordion i.fa-chevron-down { display:none; }

/* ---------------- CONTENIDO ---------------- */
.main { margin-left:260px; padding:20px; transition:0.3s; }
.sidebar.collapsed ~ .main { margin-left:60px; }

/* ---------------- DASHBOARD ---------------- */
.cards { display:flex; gap:20px; margin-top:20px; flex-wrap:wrap; }
.card { flex:1; min-width:150px; background:white; color:#ff4d00; padding:20px; border-radius:12px; text-align:center; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.1); transition:0.2s; }
.card:hover { transform:translateY(-3px); box-shadow:0 6px 12px rgba(0,0,0,0.15); }
.card span { font-weight:700; font-size:1.3rem; display:block; margin-top:5px;}
.card i { font-size:2rem; }

/* ---------------- BÚSQUEDA ---------------- */
.search-bar { margin-bottom:15px; display:flex; gap:10px; }
.search-bar input { flex-grow:1; padding:10px; border-radius:6px; border:1px solid #ccc; font-size:1rem; }

/* ---------------- TABLAS ---------------- */
table { width:100%; border-collapse:collapse; margin-top:20px; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.05); }
th, td { border:1px solid #eee; padding:10px; text-align:center; font-size:0.9rem; }
th { background:#ff4d00; color:white; font-weight:600; }
tr:nth-child(even) { background-color:#f9f9f9; }
.actions button { margin:0 2px; padding:6px; border-radius:50%; border:none; cursor:pointer; width:32px; height:32px; transition:0.1s; }
.actions button:hover { opacity:0.8; }
.btn-edit { background:#ffb86b; color:white; }
.btn-del { background:#d9534f; color:white; }

/* ---------------- MODAL ---------------- */
.modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:50; }
.modal { background:white; padding:25px; border-radius:12px; width:450px; max-width:95%; box-shadow:0 10px 20px rgba(0,0,0,0.2); }
input, select { padding:10px; border-radius:6px; border:1px solid #ccc; width:100%; margin-bottom:12px; font-size:1rem; }
.modal button { padding:8px 15px; border-radius:6px; cursor:pointer; border:none; font-weight:600; transition:0.1s; }
.modal button:last-child { background:#ff4d00; color:white; }
.modal button:last-child:hover { background:#cc3c00; }
.modal button:first-child { background:#eee; color:#333; margin-right:10px; }
.modal button:first-child:hover { background:#ddd; }

/* ---------------- RESPONSIVE ---------------- */
@media(max-width:768px) {
    .sidebar { left:-260px; position:fixed; }
    .sidebar.collapsed { left:0; }
    .main { margin-left:0; padding:10px; }
    .cards { flex-direction:column; }
    .card { min-width:100%; }
}
</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <div class="brand">
        <i class="fa-solid fa-boxes-stacked"></i><span>Inventario 3A</span>
        <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
    </div>

    <!-- Menú -->
    <div class="menu-section">
        <button class="accordion active" onclick="nav('dashboard')"><i class="fa-solid fa-house"></i><span>Dashboard</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel" style="max-height:500px;">
            <button onclick="nav('dashboard')"><i class="fa-solid fa-gauge-high"></i><span>Ver Dashboard</span></button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-computer"></i><span>Inventario</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('inventario')"><i class="fa-solid fa-plus"></i><span>Agregar Inventario</span></button>
            <button onclick="nav('inventario')"><i class="fa-solid fa-table"></i><span>Ver Inventario</span></button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-tags"></i><span>Categorías</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('categoria')"><i class="fa-solid fa-plus"></i><span>Agregar Categoría</span></button>
            <button onclick="nav('categoria')"><i class="fa-solid fa-table"></i><span>Ver Categorías</span></button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-store"></i><span>Tiendas</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('tienda')"><i class="fa-solid fa-plus"></i><span>Agregar Tienda</span></button>
            <button onclick="nav('tienda')"><i class="fa-solid fa-table"></i><span>Ver Tiendas</span></button>
        </div>
    </div>
</aside>

<div class="main">
    <h2 id="main-title">Inventario de Tienda</h2>
    <div id="content"></div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal">
    <div class="modal">
        <h3 id="modal-title"></h3>
        <div id="modal-form"></div>
        <div style="text-align:right; margin-top:15px;">
            <button onclick="closeModal()">Cancelar</button>
            <button onclick="saveItem()">Guardar</button>
        </div>
    </div>
</div>

<script>
const APPWEB_URL = "https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";

// Variables globales
let inventario = [], categorias = [], tiendas = [], pendingOps = [];
let editItemIndex = null;
let currentView = 'dashboard';
let currentSearch = '';
const STORAGE_KEY = 'inventario3a';

// ---------------- SIDEBAR ACORDEÓN ----------------
document.getElementById('toggleSidebar').onclick = () => document.getElementById('sidebar').classList.toggle('collapsed');
document.querySelectorAll('.accordion').forEach(button=>{
    button.addEventListener('click', ()=>{
        document.querySelectorAll('.accordion').forEach(acc=>{
            if(acc!==button && acc.classList.contains('active')){
                acc.classList.remove('active'); acc.nextElementSibling.style.maxHeight=null;
            }
        });
        button.classList.toggle('active');
        const panel=button.nextElementSibling;
        panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight+"px";
    });
});

// ---------------- LOCAL STORAGE ----------------
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({inventario,categorias,tiendas,pendingOps})); }
function loadData(){
    const data=localStorage.getItem(STORAGE_KEY);
    if(data){
        const parsed=JSON.parse(data);
        inventario=parsed.inventario||[];
        categorias=parsed.categorias||[];
        tiendas=parsed.tiendas||[];
        pendingOps=parsed.pendingOps||[];
    }
}

// ---------------- FETCH ----------------
async function fetchSheet(sheet){
    try{
        const res=await fetch(`${APPWEB_URL}?sheet=${sheet}&action=get&t=${Date.now()}`);
        const json=await res.json();
        return json.map(row=>({
            idSheet: row.id,
            nombre: row.nombre||row.Nombre||row.Categoria||row.Tienda||'',
            Codigo: row.Codigo||'',
            Serie: row.Serie||'',
            Equipo: row.Equipo||'',
            Marca: row.Marca||'',
            Modelo: row.Modelo||'',
            Categoria: row.Categoria||'',
            Tienda: row.Tienda||''
        }));
    }catch(e){ console.warn(`Error fetchSheet (${sheet}):`, e); return []; }
}

async function loadInitialData(){
    const [inv,cat,td]=await Promise.all([fetchSheet('inventario'), fetchSheet('categoria'), fetchSheet('tienda')]);
    inventario=inv; categorias=cat; tiendas=td;
    saveData(); render();
}

// ---------------- SYNC ----------------
async function syncItem(tipo,item,action){
    if(!item) return false;
    if((action==='update'||action==='delete')&&!item.idSheet) return true;
    const sheet=(tipo==='inventario')?'inventario':(tipo==='categoria'?'categoria':'tienda');
    const params=new URLSearchParams();
    params.append('sheet',sheet); params.append('action',action);
    let fields=(tipo==='inventario')?['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda']:['nombre'];

    if(action==='add'||action==='update'){
        if(action==='update'){ params.append('idCol','id').append('idValue',item.idSheet); }
        fields.forEach(k=>{ params.append(k,item[k]||''); });
    }else if(action==='delete'){ params.append('idCol','id').append('idValue',item.idSheet); }

    try{
        const res=await fetch(`${APPWEB_URL}?${params.toString()}`,{method:'POST'});
        const data=await res.json();
        if(data.success&&action==='add'&&data.id){ item.idSheet=data.id; }
        return data.success;
    }catch(e){ console.warn("syncItem error:",e); return false; }
}

async function syncPending(){
    if(pendingOps.length===0) return;
    let successfulOps=[],newPendingOps=[];
    for(let op of pendingOps){
        if((op.action==='delete'||op.action==='update')&&!op.item.idSheet){
            successfulOps.push(op); continue;
        }
        const success=await syncItem(op.tipo,op.item,op.action);
        if(success){ successfulOps.push(op); }else{ newPendingOps.push(op); }
    }
    pendingOps=newPendingOps;
    saveData(); render();
}

// ---------------- MODAL ----------------
function openAddForm(tipo,index=null){
    editItemIndex=index;
    const modal=document.getElementById('modal'); modal.style.display='flex';
    const titleEl=document.getElementById('modal-title');
    const form=document.getElementById('modal-form'); form.innerHTML=''; form.dataset.tipo=tipo;

    if(tipo==='inventario'){
        titleEl.innerText=(index!==null?'Editar ':'Agregar ')+'Inventario';
        const fields=['Codigo','Serie','Equipo','Marca','Modelo'];
        fields.forEach(k=>{
            const inp=document.createElement('input'); inp.placeholder=k; inp.id='f_'+k; form.appendChild(inp);
        });
        // Combobox categoría
        const catSel=document.createElement('input'); catSel.id='f_Categoria'; catSel.setAttribute('list','listaCategorias'); form.appendChild(catSel);
        const dlCat=document.createElement('datalist'); dlCat.id='listaCategorias';
        categorias.forEach(c=>{ const opt=document.createElement('option'); opt.value=c.nombre; dlCat.appendChild(opt); }); form.appendChild(dlCat);

        // Combobox tienda
        const tSel=document.createElement('input'); tSel.id='f_Tienda'; tSel.setAttribute('list','listaTiendas'); form.appendChild(tSel);
        const dlT=document.createElement('datalist'); dlT.id='listaTiendas';
        tiendas.forEach(t=>{ const opt=document.createElement('option'); opt.value=t.nombre; dlT.appendChild(opt); }); form.appendChild(dlT);

        if(index!==null){
            const item=inventario[index];
            fields.forEach(f=>{ document.getElementById('f_'+f).value=item[f]||''; });
            catSel.value=item.Categoria||''; tSel.value=item.Tienda||'';
        }
    }else if(tipo==='categoria'||tipo==='tienda'){
        titleEl.innerText=(index!==null?'Editar ':'Agregar ')+(tipo==='categoria'?'Categoría':'Tienda');
        const inp=document.createElement('input'); inp.id='f_nombre'; inp.placeholder='Nombre';
        if(index!==null) inp.value=(tipo==='categoria'?categorias[index].nombre:tiendas[index].nombre)||'';
        form.appendChild(inp);
    }
}

function closeModal(){ document.getElementById('modal').style.display='none'; editItemIndex=null; }

// ---------------- GUARDAR ----------------
async function saveItem(){
    const form=document.getElementById('modal-form'); const tipo=form.dataset.tipo;
    let item={};
    if(tipo==='inventario'){
        const fields=['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda'];
        fields.forEach(f=>{ item[f]=document.getElementById('f_'+f).value; });
        if(editItemIndex!==null){ item.idSheet=inventario[editItemIndex].idSheet; inventario[editItemIndex]={...inventario[editItemIndex],...item}; pendingOps.push({tipo,action:'update',item}); }
        else{ pendingOps.push({tipo,action:'add',item}); inventario.push(item); }
    }else if(tipo==='categoria'){
        item.nombre=document.getElementById('f_nombre').value;
        if(editItemIndex!==null){ item.idSheet=categorias[editItemIndex].idSheet; categorias[editItemIndex]=item; pendingOps.push({tipo,action:'update',item}); }
        else{ pendingOps.push({tipo,action:'add',item}); categorias.push(item); }
    }else if(tipo==='tienda'){
        item.nombre=document.getElementById('f_nombre').value;
        if(editItemIndex!==null){ item.idSheet=tiendas[editItemIndex].idSheet; tiendas[editItemIndex]=item; pendingOps.push({tipo,action:'update',item}); }
        else{ pendingOps.push({tipo,action:'add',item}); tiendas.push(item); }
    }
    closeModal(); saveData(); render(); await syncPending();
}

// ---------------- ELIMINAR ----------------
function deleteItem(tipo,index){
    if(!confirm('¿Eliminar este registro?')) return;
    let arr=(tipo==='inventario')?inventario:(tipo==='categoria')?categorias:tiendas;
    const item=arr[index];
    pendingOps.push({tipo,action:'delete',item});
    arr.splice(index,1);
    // RESTRUCTURAR IDs locales
    if(tipo==='inventario'){ inventario=inventario.map((i,idx)=>({...i,idSheet:i.idSheet})); }
    saveData(); render(); syncPending();
}

// ---------------- NAVEGACIÓN ----------------
function nav(view){ currentView=view; render(); }
function render(){
    const content=document.getElementById('content'); content.innerHTML='';
    document.getElementById('main-title').innerText=currentView.charAt(0).toUpperCase()+currentView.slice(1);

    if(currentView==='dashboard'){
        const cards=document.createElement('div'); cards.className='cards';
        const totalInv=document.createElement('div'); totalInv.className='card'; totalInv.innerHTML=`<i class="fa-solid fa-boxes"></i><span>${inventario.length}</span>Inventario`; cards.appendChild(totalInv);
        const totalCat=document.createElement('div'); totalCat.className='card'; totalCat.innerHTML=`<i class="fa-solid fa-tags"></i><span>${categorias.length}</span>Categorías`; cards.appendChild(totalCat);
        const totalT=document.createElement('div'); totalT.className='card'; totalT.innerHTML=`<i class="fa-solid fa-store"></i><span>${tiendas.length}</span>Tiendas`; cards.appendChild(totalT);
        content.appendChild(cards);
    }else{
        // TABLA
        const table=document.createElement('table'); const trh=document.createElement('tr');
        let headers=[];
        let arr=[];
        if(currentView==='inventario'){ arr=inventario; headers=['#','Código','Serie','Equipo','Marca','Modelo','Categoría','Tienda','Acciones']; }
        else if(currentView==='categoria'){ arr=categorias; headers=['#','Nombre','Acciones']; }
        else if(currentView==='tienda'){ arr=tiendas; headers=['#','Nombre','Acciones']; }

        headers.forEach(h=>{ const th=document.createElement('th'); th.innerText=h; trh.appendChild(th); }); table.appendChild(trh);
        arr.forEach((item,i)=>{
            const tr=document.createElement('tr');
            if(currentView==='inventario'){
                tr.innerHTML=`<td>${i+1}</td><td>${item.Codigo||''}</td><td>${item.Serie||''}</td><td>${item.Equipo||''}</td><td>${item.Marca||''}</td><td>${item.Modelo||''}</td><td>${item.Categoria||''}</td><td>${item.Tienda||''}</td><td class="actions">
                <button class="btn-edit" onclick="openAddForm('inventario',${i})"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-del" onclick="deleteItem('inventario',${i})"><i class="fa-solid fa-trash"></i></button></td>`;
            }else{
                tr.innerHTML=`<td>${i+1}</td><td>${item.nombre||''}</td><td class="actions">
                <button class="btn-edit" onclick="openAddForm('${currentView}',${i})"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-del" onclick="deleteItem('${currentView}',${i})"><i class="fa-solid fa-trash"></i></button></td>`;
            }
            table.appendChild(tr);
        });
        content.appendChild(table);
    }
}

// ---------------- INIT ----------------
loadData(); loadInitialData();
</script>
</body>
</html>
