<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario Tiendas 3A</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f4f4f4;}
    header{background:#ff6600;color:#fff;text-align:center;padding:10px;}
    nav{display:flex;justify-content:center;background:#333;}
    nav button{background:#444;color:#fff;border:none;padding:10px 20px;cursor:pointer;}
    nav button:hover{background:#555;}
    section{padding:20px;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;}
    th{background:#f2f2f2;}
    .actions button{margin-right:5px;}
    #formModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
    #formModal .modal-content{background:#fff;padding:20px;border-radius:8px;min-width:300px;}
    #formModal .modal-content h3{margin-top:0;}
    #formModal input{width:100%;padding:8px;margin:5px 0;}
  </style>
</head>
<body>
  <header>
    <h1>Inventario Tiendas 3A</h1>
  </header>

  <nav>
    <button onclick="showSection('inventario')">Inventario</button>
    <button onclick="showSection('categoria')">Categorías</button>
    <button onclick="showSection('tienda')">Tiendas</button>
  </nav>

  <!-- Secciones -->
  <section id="inventarioSection">
    <h2>Inventario</h2>
    <button onclick="openForm('inventario')">Agregar Inventario</button>
    <table id="inventarioTable">
      <thead>
        <tr>
          <th>Código</th><th>Serie</th><th>Equipo</th><th>Marca</th><th>Modelo</th><th>Categoría</th><th>Tienda</th><th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="categoriaSection" style="display:none;">
    <h2>Categorías</h2>
    <button onclick="openForm('categoria')">Agregar Categoría</button>
    <table id="categoriaTable">
      <thead>
        <tr><th>Nombre</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="tiendaSection" style="display:none;">
    <h2>Tiendas</h2>
    <button onclick="openForm('tienda')">Agregar Tienda</button>
    <table id="tiendaTable">
      <thead>
        <tr><th>Nombre</th><th>Acciones</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Modal Form -->
  <div id="formModal">
    <div class="modal-content">
      <h3 id="formTitle">Formulario</h3>
      <form id="dataForm" onsubmit="event.preventDefault(); saveData();">
        <div id="inventarioFields" style="display:none;">
          <input type="text" name="Codigo" placeholder="Código"/>
          <input type="text" name="Serie" placeholder="Serie"/>
          <input type="text" name="Equipo" placeholder="Equipo"/>
          <input type="text" name="Marca" placeholder="Marca"/>
          <input type="text" name="Modelo" placeholder="Modelo"/>
          <input type="text" name="Categoria" placeholder="Categoría"/>
          <input type="text" name="Tienda" placeholder="Tienda"/>
        </div>
        <div id="categoriaFields" style="display:none;">
          <input type="text" name="nombre" placeholder="Nombre Categoría"/>
        </div>
        <div id="tiendaFields" style="display:none;">
          <input type="text" name="nombre" placeholder="Nombre Tienda"/>
        </div>
        <button type="submit">Guardar</button>
        <button type="button" onclick="closeForm()">Cancelar</button>
      </form>
    </div>
  </div>

  <script>
  const APPWEB_URL = "TU_URL_DEL_SCRIPT"; // Reemplazar con tu URL de Apps Script

  let inventario=[], categorias=[], tiendas=[];
  let pendingOps=[];
  let currentSheet="inventario";
  let editId=null;

  function showSection(tipo){
    document.getElementById("inventarioSection").style.display="none";
    document.getElementById("categoriaSection").style.display="none";
    document.getElementById("tiendaSection").style.display="none";
    document.getElementById(tipo+"Section").style.display="block";
    currentSheet=tipo;
    renderTable(tipo, tipo==="inventario"?inventario:(tipo==="categoria"?categorias:tiendas));
  }

  function openForm(tipo){
    editId=null;
    currentSheet=tipo;
    document.getElementById("dataForm").reset();
    document.getElementById("inventarioFields").style.display="none";
    document.getElementById("categoriaFields").style.display="none";
    document.getElementById("tiendaFields").style.display="none";
    if(tipo==="inventario") document.getElementById("inventarioFields").style.display="block";
    if(tipo==="categoria") document.getElementById("categoriaFields").style.display="block";
    if(tipo==="tienda") document.getElementById("tiendaFields").style.display="block";
    document.getElementById("formModal").style.display="flex";
  }

  function closeForm(){ document.getElementById("formModal").style.display="none"; }

  function renderTable(tipo,data){
    const tbody=document.querySelector(`#${tipo}Table tbody`);
    tbody.innerHTML="";
    data.forEach(item=>{
      const tr=document.createElement("tr");
      if(tipo==="inventario"){
        tr.innerHTML=`<td>${item.Codigo||""}</td>
          <td>${item.Serie||""}</td>
          <td>${item.Equipo||""}</td>
          <td>${item.Marca||""}</td>
          <td>${item.Modelo||""}</td>
          <td>${item.Categoria||""}</td>
          <td>${item.Tienda||""}</td>
          <td class="actions">
            <button onclick="editItem('${tipo}',${item.id||item.idLocal})">Editar</button>
            <button onclick="deleteItem('${tipo}',${item.id||item.idLocal})">Eliminar</button>
          </td>`;
      }else{
        tr.innerHTML=`<td>${item.nombre||""}</td>
          <td class="actions">
            <button onclick="editItem('${tipo}',${item.id||item.idLocal})">Editar</button>
            <button onclick="deleteItem('${tipo}',${item.id||item.idLocal})">Eliminar</button>
          </td>`;
      }
      tbody.appendChild(tr);
    });
  }

  function saveData(){
    const form=document.getElementById("dataForm");
    const formData=new FormData(form);
    let obj={};
    for(let [k,v] of formData.entries()) obj[k]=v.trim();
    if(Object.values(obj).every(v=>!v)){
      alert("Debes completar al menos un campo.");
      return;
    }
    if(editId){
      obj.id=editId;
      pendingOps.push({tipo:currentSheet,action:'update',data:obj});
    }else{
      obj.idLocal=Date.now();
      pendingOps.push({tipo:currentSheet,action:'add',data:obj});
      if(currentSheet==="inventario") inventario.push(obj);
      if(currentSheet==="categoria") categorias.push(obj);
      if(currentSheet==="tienda") tiendas.push(obj);
    }
    closeForm();
    renderTable(currentSheet,currentSheet==="inventario"?inventario:(currentSheet==="categoria"?categorias:tiendas));
    syncAll();
  }

  function editItem(tipo,id){
    let arr=tipo==="inventario"?inventario:(tipo==="categoria"?categorias:tiendas);
    let item=arr.find(x=>(x.id||x.idLocal)==id);
    if(!item) return;
    editId=id;
    const form=document.getElementById("dataForm");
    form.reset();
    for(let k in item){ if(form.elements[k]) form.elements[k].value=item[k]; }
    document.getElementById("inventarioFields").style.display="none";
    document.getElementById("categoriaFields").style.display="none";
    document.getElementById("tiendaFields").style.display="none";
    if(tipo==="inventario") document.getElementById("inventarioFields").style.display="block";
    if(tipo==="categoria") document.getElementById("categoriaFields").style.display="block";
    if(tipo==="tienda") document.getElementById("tiendaFields").style.display="block";
    document.getElementById("formModal").style.display="flex";
  }

  function deleteItem(tipo,id){
    let arr=tipo==="inventario"?inventario:(tipo==="categoria"?categorias:tiendas);
    let idx=arr.findIndex(x=>(x.id||x.idLocal)==id);
    if(idx===-1) return;
    let item=arr[idx];
    arr.splice(idx,1);
    pendingOps.push({tipo,action:'delete',data:item});
    renderTable(tipo,arr);
    syncAll();
  }

  async function syncAll(){
    for(let i=0;i<pendingOps.length;i++){
      let op=pendingOps[i];
      let ok=await syncItem(op.tipo,op.data,op.action);
      if(ok){ pendingOps.splice(i,1); i--; }
    }
  }

  async function syncItem(tipo,item,action){
    if(!item) return false;
    const params=new URLSearchParams();
    params.append("sheet",tipo);
    params.append("action",action);

    if(action==="update"||action==="delete"){
      if(!item.id) return false;
      params.append("idValue",item.id);
      params.append("idCol","id");
    }

    if(action==="add"||action==="update"){
      if(tipo==="inventario"){
        params.append("Codigo",item.Codigo||"");
        params.append("Serie",item.Serie||"");
        params.append("Equipo",item.Equipo||"");
        params.append("Marca",item.Marca||"");
        params.append("Modelo",item.Modelo||"");
        params.append("Categoria",item.Categoria||"");
        params.append("Tienda",item.Tienda||"");
      }else{
        params.append("nombre",item.nombre||"");
      }
    }

    try{
      const res=await fetch(APPWEB_URL,{method:"POST",body:params});
      const data=await res.json();
      if(data && data.success){
        if(action==="add" && data.id){
          let arr=tipo==="inventario"?inventario:(tipo==="categoria"?categorias:tiendas);
          const idx=arr.findIndex(x=>x.idLocal===item.idLocal);
          if(idx!==-1){
            delete arr[idx].idLocal;
            arr[idx].id=data.id;
          }
        }
        return true;
      }else{
        console.warn("syncItem failed",data);
        return false;
      }
    }catch(e){
      console.error("syncItem error",e);
      return false;
    }
  }
  </script>
</body>
</html>
