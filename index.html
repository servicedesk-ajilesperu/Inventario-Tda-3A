<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventario Tiendas 3A</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        /* (Aquí van todos tus estilos actuales, sin cambios) */
        body, html { margin: 0; padding: 0; font-family: sans-serif; background: #f7f7f7; }
        * { box-sizing: border-box; }
        .sidebar { width: 260px; position: fixed; height: 100%; background: #ff4d00; color: white; display: flex; flex-direction: column; gap: 12px; padding: 20px; transition: 0.3s; overflow-y: auto; z-index: 10; }
        .sidebar.collapsed { width: 60px; padding: 20px 5px; }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.2rem; position: relative; margin-bottom: 10px; }
        #toggleSidebar { position: absolute; right: 0; top: 0; background: #cc3c00; color: white; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; }
        .menu-section { width: 100%; }
        .menu-section .accordion { background: transparent; color: white; border: none; padding: 10px; width: 100%; display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; justify-content: space-between; transition: 0.2s; border-radius: 4px; }
        .menu-section .accordion.active, .menu-section .accordion:hover { background-color: #e64500; }
        .menu-section .panel { padding: 0 10px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; background-color: #e64500; display: flex; flex-direction: column; gap: 4px; }
        .menu-section .panel button { background: transparent; color: white; border: none; padding: 8px; text-align: left; display: flex; align-items: center; gap: 6px; cursor: pointer; width: 100%; border-radius: 4px; }
        .menu-section .panel button:hover { background-color: #cc4000; }
        .sidebar.collapsed .brand span,
        .sidebar.collapsed .menu-section .accordion span,
        .sidebar.collapsed .panel button span { display: none; }
        .sidebar.collapsed .accordion { justify-content: center; }
        .sidebar.collapsed .accordion i.fa-chevron-down { display: none; }
        .main { margin-left: 260px; padding: 20px; transition: 0.3s; }
        .sidebar.collapsed ~ .main { margin-left: 60px; }
        .cards { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .card { flex: 1; min-width: 150px; background: white; color: #ff4d00; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .card span { font-weight: 700; font-size: 1.3rem; display: block; margin-top: 5px;}
        .card i { font-size: 2rem; }
        .search-bar { margin-bottom: 15px; display: flex; gap: 10px; }
        .search-bar input { flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 0.9rem; }
        th { background: #ff4d00; color: white; font-weight: 600; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .actions button { margin: 0 2px; padding: 6px; border-radius: 50%; border: none; cursor: pointer; width: 32px; height: 32px; transition: 0.1s; }
        .actions button:hover { opacity: 0.8; }
        .btn-edit { background: #ffb86b; color: white; }
        .btn-del { background: #d9534f; color: white; }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 450px; max-width: 95%; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        input, select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; width: 100%; margin-bottom: 12px; font-size: 1rem; }
        .modal button { padding: 8px 15px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; transition: 0.1s; }
        .modal button:last-child { background:#ff4d00; color:white; }
        .modal button:last-child:hover { background:#cc3c00; }
        .modal button:first-child { background:#eee; color:#333; margin-right: 10px; }
        .modal button:first-child:hover { background:#ddd; }
        @media(max-width:768px) {
            .sidebar { left: -260px; position: fixed; }
            .sidebar.collapsed { left: 0; }
            .main { margin-left: 0; padding: 10px; }
            .cards { flex-direction: column; }
            .card { min-width: 100%; }
        }
    </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <div class="brand">
        <i class="fa-solid fa-boxes-stacked"></i><span>Inventario 3A</span>
        <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
    </div>

    <div class="menu-section">
        <button class="accordion active" onclick="nav('dashboard')"><i class="fa-solid fa-house"></i><span>Dashboard</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel" style="max-height: 500px;">
            <button onclick="nav('dashboard')"><i class="fa-solid fa-gauge-high"></i><span>Ver Dashboard</span></button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-computer"></i><span>Inventario</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('inventario')"><i class="fa-solid fa-plus"></i><span>Agregar Inventario</span></button>
            <button onclick="nav('inventario')"><i class="fa-solid fa-table"></i><span>Ver Inventario</span></button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-tags"></i><span>Categorías</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('categoria')"><i class="fa-solid fa-plus"></i><span>Agregar Categoría</span></button>
            <button onclick="nav('categoria')"><i class="fa-solid fa-table"></i><span>Ver Categorías</span></button>
        </div>
    </div>

    <div class="menu-section">
        <button class="accordion"><i class="fa-solid fa-store"></i><span>Tiendas</span><i class="fa-solid fa-chevron-down"></i></button>
        <div class="panel">
            <button onclick="openAddForm('tienda')"><i class="fa-solid fa-plus"></i><span>Agregar Tienda</span></button>
            <button onclick="nav('tienda')"><i class="fa-solid fa-table"></i><span>Ver Tiendas</span></button>
        </div>
    </div>
</aside>

<div class="main">
    <h2 id="main-title">Inventario de Tienda</h2>
    <div id="content"></div>
</div>

<div class="modal-backdrop" id="modal">
    <div class="modal">
        <h3 id="modal-title"></h3>
        <div id="modal-form"></div>
        <div style="text-align:right; margin-top:15px;">
            <button onclick="closeModal()">Cancelar</button>
            <button onclick="saveItem()">Guardar</button>
        </div>
    </div>
</div>

<script>
const APPWEB_URL = "https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";

let inventario = [], categorias = [], tiendas = [], pendingOps = [];
let editItemIndex = null, currentView = 'dashboard', currentSearch = '';
const STORAGE_KEY = 'inventario3a';

// Sidebar
document.getElementById('toggleSidebar').onclick = () => document.getElementById('sidebar').classList.toggle('collapsed');
document.querySelectorAll('.accordion').forEach(button => {
    button.addEventListener('click', () => {
        if(button.innerText.includes('Dashboard')) nav('dashboard');
        toggleAccordion(button);
    });
});

function toggleAccordion(button){
    document.querySelectorAll('.accordion').forEach(acc=>{
        if(acc!==button && acc.classList.contains('active')){
            acc.classList.remove('active');
            acc.nextElementSibling.style.maxHeight = null;
        }
    });
    button.classList.toggle('active');
    const panel = button.nextElementSibling;
    panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
}

// Local Storage
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({inventario, categorias, tiendas, pendingOps})); }
function loadData(){
    const data = localStorage.getItem(STORAGE_KEY);
    if(data){
        const parsed = JSON.parse(data);
        inventario = parsed.inventario || [];
        categorias = parsed.categorias || [];
        tiendas = parsed.tiendas || [];
        pendingOps = parsed.pendingOps || [];
    }
}

// Fetch inicial
async function fetchSheet(sheet){
    try {
        const res = await fetch(`${APPWEB_URL}?sheet=${sheet}&action=get&t=${Date.now()}`); 
        const json = await res.json();
        return json.map(row=>({
            idSheet: row.id, 
            nombre: row.nombre || row.Nombre || row.Categoria || row.Tienda || '',
            Codigo: row.Codigo || '', Serie: row.Serie || '', Equipo: row.Equipo || '', Marca: row.Marca || '', Modelo: row.Modelo || '',
            Categoria: row.Categoria || '', Tienda: row.Tienda || ''
        }));
    } catch(e){ console.warn(`Error fetchSheet (${sheet}):`, e); return []; }
}

async function loadInitialData(){
    const [inv, cat, td] = await Promise.all([ fetchSheet('inventario'), fetchSheet('categoria'), fetchSheet('tienda') ]);
    inventario = inv; categorias = cat; tiendas = td; saveData(); render(); 
}

// ———— Sync Functions ————
async function syncItem(tipo, item, action){
    if(!item){ console.error("syncItem: Item inválido.", {tipo, action}); return false; }
    if((action==='update'||action==='delete') && !item.idSheet){ console.warn(`syncItem: Falta idSheet para ${action}`, {item}); return true; }

    const sheet = tipo==='inventario'?'inventario':(tipo==='categoria'?'categoria':'tienda');
    const params = new URLSearchParams();
    params.append('sheet', sheet);
    params.append('action', action);

    let fields = tipo==='inventario'?['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda']:['nombre'];

    if(action==='add'||action==='update'){
        if(action==='update'){ params.append('idCol','id'); params.append('idValue', item.idSheet); }
        fields.forEach(k=>params.append(k, item[k]||''));
    } else if(action==='delete'){ params.append('idCol','id'); params.append('idValue', item.idSheet); }

    try{
        const res = await fetch(`${APPWEB_URL}?${params.toString()}`, {method:'POST'});
        const data = await res.json();
        if(data.success && action==='add' && data.id){ item.idSheet = data.id; replaceLocalId(item); }
        return data.success;
    } catch(e){ console.warn("syncItem error:", e); return false; }
}

function replaceLocalId(item){
    const arr = item.Equipo!==undefined?inventario:(item.Tienda!==undefined?tiendas:categorias);
    let idx = arr.findIndex(r=>r.idLocal===item.idLocal);
    if(idx>=0 && arr[idx].idLocal===item.idLocal){ arr[idx].idSheet=item.idSheet; delete arr[idx].idLocal; }
}

async function syncPending(){
    if(pendingOps.length===0) return;
    let newPendingOps=[];
    for(let op of pendingOps){
        const isDelUpdate = op.action==='delete'||op.action==='update';
        if(isDelUpdate && !op.item.idSheet){ console.warn("PENDING_CLEANUP: ítem sin ID", op); continue; }
        try{
            const success = await syncItem(op.tipo, op.item, op.action);
            if(!success) newPendingOps.push(op);
        } catch(e){ console.warn("syncPending error", op, e); newPendingOps.push(op); }
    }
    pendingOps=newPendingOps; saveData(); render();
}

// ———— Modal / Add / Edit ————
function openAddForm(tipo, index=null){
    editItemIndex=index;
    const modal=document.getElementById('modal'); modal.style.display='flex';
    const titleEl=document.getElementById('modal-title'); const form=document.getElementById('modal-form'); form.innerHTML=''; form.dataset.tipo=tipo;

    if(tipo==='inventario'){
        titleEl.innerText=(index!==null?'Editar ':'Agregar ')+'Inventario';
        const fields=['Codigo','Serie','Equipo','Marca','Modelo'];
        fields.forEach(k=>{ const inp=document.createElement('input'); inp.placeholder=k; inp.id='f_'+k; form.appendChild(inp); });

        const catSel=document.createElement('select'); catSel.id='f_Categoria'; catSel.innerHTML='<option value="">Seleccione Categoría</option>';
        categorias.forEach(c=>{ catSel.innerHTML+=`<option value="${c.nombre}">${c.nombre}</option>`; });
        form.appendChild(catSel);

        const tSel=document.createElement('select'); tSel.id='f_Tienda'; tSel.innerHTML='<option value="">Seleccione Tienda</option>';
        tiendas.forEach(t=>{ tSel.innerHTML+=`<option value="${t.nombre}">${t.nombre}</option>`; });
        form.appendChild(tSel);

        if(index!==null){ const item=inventario[index]; fields.forEach(k=>document.getElementById('f_'+k).value=item[k]||''); catSel.value=item.Categoria||''; tSel.value=item.Tienda||''; }
    } else {
        const name=tipo.charAt(0).toUpperCase()+tipo.slice(1);
        titleEl.innerText=(index!==null?'Editar ':'Agregar ')+name;
        const inp=document.createElement('input'); inp.placeholder='Nombre de la '+name; inp.id='f_nombre'; form.appendChild(inp);
        if(index!==null){ const item=tipo==='categoria'?categorias[index]:tiendas[index]; document.getElementById('f_nombre').value=item.nombre||''; }
    }
}

function closeModal(){ document.getElementById('modal').style.display='none'; editItemIndex=null; }

function saveItem(){
    const form=document.getElementById('modal-form'); const tipo=form.dataset.tipo;
    let obj={}; const isEditing=editItemIndex!==null;
    let arr=tipo==='inventario'?inventario:(tipo==='categoria'?categorias:tiendas);
    const itemBase=isEditing?arr[editItemIndex]:{};

    if(tipo==='inventario'){
        obj={ idSheet:itemBase.idSheet||null, idLocal:itemBase.idLocal||null,
            Codigo:document.getElementById('f_Codigo').value,
            Serie:document.getElementById('f_Serie').value,
            Equipo:document.getElementById('f_Equipo').value,
            Marca:document.getElementById('f_Marca').value,
            Modelo:document.getElementById('f_Modelo').value,
            Categoria:document.getElementById('f_Categoria').value,
            Tienda:document.getElementById('f_Tienda').value
        };
    } else { obj={ idSheet:itemBase.idSheet||null, idLocal:itemBase.idLocal||null, nombre:document.getElementById('f_nombre').value }; }

    if(!obj.idSheet && !obj.idLocal) obj.idLocal=Date.now(); // ID temporal local

    if(isEditing){ arr[editItemIndex]=obj; pendingOps.push({tipo, item:obj, action:'update'}); }
    else { arr.push(obj); pendingOps.push({tipo, item:obj, action:'add'}); }

    saveData(); render(); closeModal(); syncPending();
}

// ———— Delete ————
function deleteItem(tipo,index){
    if(!confirm('¿Desea eliminar este ítem?')) return;
    const arr=tipo==='inventario'?inventario:(tipo==='categoria'?categorias:tiendas);
    const item=arr[index]; arr.splice(index,1);
    pendingOps.push({tipo,item,action:'delete'}); saveData(); render(); syncPending();
}

// ———— Render ————
function render(){
    const content=document.getElementById('content'); content.innerHTML='';
    if(currentView==='dashboard'){ content.innerHTML='<div class="cards"><div class="card"><i class="fa-solid fa-box"></i><span>'+inventario.length+'</span><p>Inventario</p></div><div class="card"><i class="fa-solid fa-tags"></i><span>'+categorias.length+'</span><p>Categorías</p></div><div class="card"><i class="fa-solid fa-store"></i><span>'+tiendas.length+'</span><p>Tiendas</p></div></div>'; return; }

    let arr=currentView==='inventario'?inventario:(currentView==='categoria'?categorias:tiendas);
    const searchHTML='<div class="search-bar"><input type="text" placeholder="Buscar..." oninput="currentSearch=this.value; render();"></div>';
    let tableHTML='<table><thead><tr>';
    const headers=currentView==='inventario'?['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda','Acciones']:['Nombre','Acciones'];
    headers.forEach(h=>tableHTML+='<th>'+h+'</th>'); tableHTML+='</tr></thead><tbody>';

    arr.filter(it=>currentSearch===''||Object.values(it).some(v=>v.toLowerCase().includes(currentSearch.toLowerCase())))
        .forEach((it,i)=>{
            tableHTML+='<tr>';
            if(currentView==='inventario'){ ['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda'].forEach(k=>tableHTML+='<td>'+ (it[k]||'') +'</td>'); }
            else tableHTML+='<td>'+ (it.nombre||'') +'</td>';
            tableHTML+='<td class="actions"><button class="btn-edit" onclick="openAddForm(\''+currentView+'\','+i+')"><i class="fa-solid fa-pen-to-square"></i></button><button class="btn-del" onclick="deleteItem(\''+currentView+'\','+i+')"><i class="fa-solid fa-trash"></i></button></td></tr>';
        });

    tableHTML+='</tbody></table>';
    content.innerHTML=searchHTML+tableHTML;
}

function nav(view){ currentView=view; document.getElementById('main-title').innerText=view.charAt(0).toUpperCase()+view.slice(1); render(); }

// Inicialización
loadData();
loadInitialData();
</script>
</body>
</html>
