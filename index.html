<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
    body,html{margin:0;padding:0;font-family:sans-serif;background:#f7f7f7}*{box-sizing:border-box}
    .sidebar{width:260px;position:fixed;height:100%;background:#ff4d00;color:white;display:flex;flex-direction:column;gap:12px;padding:20px;transition:.3s;overflow-y:auto;z-index:10}
    .sidebar.collapsed{width:60px;padding:20px 5px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:1.2rem;position:relative;margin-bottom:10px}
    #toggleSidebar{position:absolute;right:0;top:0;background:#cc3c00;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer}
    .menu-section{width:100%}
    .menu-section .accordion{background:transparent;color:white;border:none;padding:10px;width:100%;display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:600;justify-content:space-between;transition:.2s;border-radius:4px}
    .menu-section .accordion.active,.menu-section .accordion:hover{background-color:#e64500}
    .menu-section .panel{padding:0 10px;max-height:0;overflow:hidden;transition:max-height .3s ease-in-out;background-color:#e64500;display:flex;flex-direction:column;gap:4px}
    .menu-section .panel button{background:transparent;color:white;border:none;padding:8px;text-align:left;display:flex;align-items:center;gap:6px;cursor:pointer;width:100%;border-radius:4px}
    .menu-section .panel button:hover{background-color:#cc4000}
    .sidebar.collapsed .brand span,.sidebar.collapsed .menu-section .accordion span,.sidebar.collapsed .panel button span{display:none}
    .sidebar.collapsed .accordion{justify-content:center}
    .sidebar.collapsed .accordion i.fa-chevron-down{display:none}
    .main{margin-left:260px;padding:20px;transition:.3s}
    .sidebar.collapsed~.main{margin-left:60px}
    .cards{display:flex;gap:20px;margin-top:20px;flex-wrap:wrap}
    .card{flex:1;min-width:150px;background:white;color:#ff4d00;padding:20px;border-radius:12px;text-align:center;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,.1);transition:.2s}
    .card:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,.15)}
    .card span{font-weight:700;font-size:1.3rem;display:block;margin-top:5px}
    .card i{font-size:2rem}
    .search-bar{margin-bottom:15px;display:flex;gap:10px}
    .search-bar input{flex-grow:1;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:1rem}
    table{width:100%;border-collapse:collapse;margin-top:20px;background:white;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    th,td{border:1px solid #eee;padding:10px;text-align:center;font-size:.9rem}
    th{background:#ff4d00;color:white;font-weight:600}
    tr:nth-child(even){background-color:#f9f9f9}
    .actions button{margin:0 2px;padding:6px;border-radius:50%;border:none;cursor:pointer;width:32px;height:32px;transition:.1s}
    .actions button:hover{opacity:.8}
    .btn-edit{background:#ffb86b;color:white}
    .btn-del{background:#d9534f;color:white}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:white;padding:25px;border-radius:12px;width:450px;max-width:95%;box-shadow:0 10px 20px rgba(0,0,0,.2)}
    input,select{padding:10px;border-radius:6px;border:1px solid #ccc;width:100%;margin-bottom:12px;font-size:1rem}
    .modal button{padding:8px 15px;border-radius:6px;cursor:pointer;border:none;font-weight:600;transition:.1s}
    .modal button:last-child{background:#ff4d00;color:white}
    .modal button:last-child:hover{background:#cc3c00}
    .modal button:first-child{background:#eee;color:#333;margin-right:10px}
    .modal button:first-child:hover{background:#ddd}
    @media(max-width:768px){.sidebar{left:-260px;position:fixed}.sidebar.collapsed{left:0}.main{margin-left:0;padding:10px}.cards{flex-direction:column}.card{min-width:100%}}
</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
<div class="brand"><i class="fa-solid fa-boxes-stacked"></i><span>Inventario 3A</span><button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button></div>

<div class="menu-section">
<button class="accordion active" onclick="nav('dashboard')"><i class="fa-solid fa-house"></i><span>Dashboard</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel" style="max-height:500px;">
<button onclick="nav('dashboard')"><i class="fa-solid fa-gauge-high"></i><span>Ver Dashboard</span></button>
</div>
</div>

<div class="menu-section">
<button class="accordion"><i class="fa-solid fa-computer"></i><span>Inventario</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel">
<button onclick="openAddForm('inventario')"><i class="fa-solid fa-plus"></i><span>Agregar Inventario</span></button>
<button onclick="nav('inventario')"><i class="fa-solid fa-table"></i><span>Ver Inventario</span></button>
</div>
</div>

<div class="menu-section">
<button class="accordion"><i class="fa-solid fa-tags"></i><span>Categorías</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel">
<button onclick="openAddForm('categoria')"><i class="fa-solid fa-plus"></i><span>Agregar Categoría</span></button>
<button onclick="nav('categoria')"><i class="fa-solid fa-table"></i><span>Ver Categorías</span></button>
</div>
</div>

<div class="menu-section">
<button class="accordion"><i class="fa-solid fa-store"></i><span>Tiendas</span><i class="fa-solid fa-chevron-down"></i></button>
<div class="panel">
<button onclick="openAddForm('tienda')"><i class="fa-solid fa-plus"></i><span>Agregar Tienda</span></button>
<button onclick="nav('tienda')"><i class="fa-solid fa-table"></i><span>Ver Tiendas</span></button>
</div>
</div>
</aside>

<div class="main">
<h2 id="main-title">Inventario de Tienda</h2>
<div id="content"></div>
</div>

<div class="modal-backdrop" id="modal">
<div class="modal">
<h3 id="modal-title"></h3>
<div id="modal-form"></div>
<div style="text-align:right;margin-top:15px;">
<button onclick="closeModal()">Cancelar</button>
<button onclick="saveItem()">Guardar</button>
</div>
</div>
</div>

<script>
const APPWEB_URL="https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";

let inventario=[],categorias=[],tiendas=[],pendingOps=[];
let editItemIndex=null,currentView='dashboard',currentSearch='';
const STORAGE_KEY='inventario3a';

// — Sidebar
document.getElementById('toggleSidebar').onclick=()=>document.getElementById('sidebar').classList.toggle('collapsed');
document.querySelectorAll('.accordion').forEach(btn=>btn.addEventListener('click',()=>{toggleAccordion(btn);navByBtn(btn);}));
function toggleAccordion(button){document.querySelectorAll('.accordion').forEach(acc=>{if(acc!==button&&acc.classList.contains('active')){acc.classList.remove('active');acc.nextElementSibling.style.maxHeight=null}});button.classList.toggle('active');const panel=button.nextElementSibling;if(panel.style.maxHeight){panel.style.maxHeight=null}else{panel.style.maxHeight=panel.scrollHeight+"px"}}
function navByBtn(button){if(button.innerText.includes('Dashboard'))nav('dashboard');else if(button.innerText.includes('Inventario'))nav('inventario');else if(button.innerText.includes('Categorías'))nav('categoria');else if(button.innerText.includes('Tiendas'))nav('tienda');}

// — Local Storage
function saveData(){localStorage.setItem(STORAGE_KEY,JSON.stringify({inventario,categorias,tiendas,pendingOps}))}
function loadData(){const data=localStorage.getItem(STORAGE_KEY);if(data){const parsed=JSON.parse(data);inventario=parsed.inventario||[];categorias=parsed.categorias||[];tiendas=parsed.tiendas||[];pendingOps=parsed.pendingOps||[]}}

async function fetchSheet(sheet){try{const res=await fetch(`${APPWEB_URL}?sheet=${sheet}&action=get&t=${Date.now()}`);const json=await res.json();return json.map(row=>({idSheet:row.id,nombre:row.nombre||row.Nombre||row.Categoria||row.Tienda||'',Codigo:row.Codigo||'',Serie:row.Serie||'',Equipo:row.Equipo||'',Marca:row.Marca||'',Modelo:row.Modelo||'',Categoria:row.Categoria||'',Tienda:row.Tienda||''}))}catch(e){console.warn(`Error fetchSheet (${sheet}):`,e);return[]}}

async function loadInitialData(){const [inv,cat,td]=await Promise.all([fetchSheet('inventario'),fetchSheet('categoria'),fetchSheet('tienda')]);inventario=inv;categorias=cat;tiendas=td;saveData();render();}

function openAddForm(tipo,index=null){
    editItemIndex=index;
    const form=document.getElementById('modal-form');form.innerHTML='';form.dataset.tipo=tipo;
    const titleEl=document.getElementById('modal-title');titleEl.innerText=(index!==null?'Editar ':'Agregar ')+(tipo==='inventario'?'Inventario':tipo.charAt(0).toUpperCase()+tipo.slice(1));
    const item=index!==null?(tipo==='inventario'?inventario[index]:(tipo==='categoria'?categorias[index]:tiendas[index])):{};
    
    if(tipo==='inventario'){
        ['Codigo','Serie','Equipo','Marca','Modelo'].forEach(f=>{
            const inp=document.createElement('input');
            inp.id='form-'+f;
            inp.placeholder=f;
            inp.value=item[f]||'';
            form.appendChild(inp);
        });

        // CATEGORÍA
        const catDiv=document.createElement('div');catDiv.style.position='relative';
        const catInput=document.createElement('input');catInput.id='form-Categoria';catInput.placeholder='Categoría';catInput.autocomplete='off';catInput.value=item.Categoria||'';catDiv.appendChild(catInput);
        const catList=document.createElement('div');catList.id='categoria-list';catList.style.position='absolute';catList.style.top='100%';catList.style.left='0';catList.style.right='0';catList.style.background='#fff';catList.style.border='1px solid #ccc';catList.style.zIndex='100';catList.style.maxHeight='120px';catList.style.overflowY='auto';catDiv.appendChild(catList);form.appendChild(catDiv);

        // TIENDA
        const tDiv=document.createElement('div');tDiv.style.position='relative';
        const tInput=document.createElement('input');tInput.id='form-Tienda';tInput.placeholder='Tienda';tInput.autocomplete='off';tInput.value=item.Tienda||'';tDiv.appendChild(tInput);
        const tList=document.createElement('div');tList.id='tienda-list';tList.style.position='absolute';tList.style.top='100%';tList.style.left='0';tList.style.right='0';tList.style.background='#fff';tList.style.border='1px solid #ccc';tList.style.zIndex='100';tList.style.maxHeight='120px';tList.style.overflowY='auto';tDiv.appendChild(tList);form.appendChild(tDiv);

        function setupAutocomplete(input,listDiv,sourceArray){
            input.addEventListener('input',()=>{
                const val=input.value.toLowerCase();listDiv.innerHTML='';
                sourceArray.filter(s=>s.nombre.toLowerCase().includes(val)).forEach(s=>{
                    const itemDiv=document.createElement('div');itemDiv.textContent=s.nombre;
                    itemDiv.style.padding='4px 6px';itemDiv.style.cursor='pointer';
                    itemDiv.addEventListener('click',()=>{input.value=s.nombre;listDiv.innerHTML='';});
                    listDiv.appendChild(itemDiv);
                });
            });
            document.addEventListener('click',e=>{if(!input.contains(e.target)) listDiv.innerHTML='';});
        }
        setupAutocomplete(catInput,catList,categorias);
        setupAutocomplete(tInput,tList,tiendas);
    } else { // categoria o tienda
        const inp=document.createElement('input');inp.id='form-nombre';inp.placeholder='Nombre';inp.value=item.nombre||'';form.appendChild(inp);
    }
    document.getElementById('modal').style.display='flex';
}

function closeModal(){document.getElementById('modal').style.display='none';editItemIndex=null;}
function saveItem(){
    const form=document.getElementById('modal-form');const tipo=form.dataset.tipo;let newItem={};
    if(tipo==='inventario'){
        ['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda'].forEach(f=>{newItem[f]=document.getElementById('form-'+f).value});
        if(editItemIndex!==null){inventario[editItemIndex]={...inventario[editItemIndex],...newItem}} else{newItem.id='id-'+Date.now();inventario.push(newItem);}
    } else {const val=document.getElementById('form-nombre').value;if(editItemIndex!==null){if(tipo==='categoria')categorias[editItemIndex].nombre=val;else tiendas[editItemIndex].nombre=val;}else{const nItem={id:'id-'+Date.now(),nombre:val};if(tipo==='categoria')categorias.push(nItem);else tiendas.push(nItem);}}
    saveData();closeModal();render();
}

function deleteItem(tipo,index){if(!confirm('¿Eliminar este registro?')) return;if(tipo==='inventario'){inventario.splice(index,1);restructureIDs(inventario);} else if(tipo==='categoria'){categorias.splice(index,1);} else{tiendas.splice(index,1);}saveData();render();}

function restructureIDs(arr){arr.forEach((item,i)=>{item.id='id-'+(i+1)});}

function render(){
    const cont=document.getElementById('content');cont.innerHTML='';if(currentView==='dashboard'){renderDashboard(cont)}else if(currentView==='inventario'){renderTable(cont,'inventario',inventario)}else if(currentView==='categoria'){renderTable(cont,'categoria',categorias)}else if(currentView==='tienda'){renderTable(cont,'tienda',tiendas)}
}

function renderDashboard(container){
    const cardsData=[
        {title:'Inventario',count:inventario.length,icon:'fa-box'},
        {title:'Categorías',count:categorias.length,icon:'fa-tags'},
        {title:'Tiendas',count:tiendas.length,icon:'fa-store'}
    ];
    const cardsDiv=document.createElement('div');cardsDiv.className='cards';
    cardsData.forEach(c=>{const card=document.createElement('div');card.className='card';card.innerHTML=`<i class="fa-solid ${c.icon}"></i><span>${c.count}</span><span>${c.title}</span>`;cardsDiv.appendChild(card);});
    container.appendChild(cardsDiv);
}

function renderTable(container,tipo,data){
    const searchDiv=document.createElement('div');searchDiv.className='search-bar';
    const input=document.createElement('input');input.placeholder='Buscar...';input.value=currentSearch;
    input.oninput=e=>{currentSearch=e.target.value;render();}
    searchDiv.appendChild(input);
    container.appendChild(searchDiv);
    const table=document.createElement('table');const thead=document.createElement('thead');const trh=document.createElement('tr');
    const cols=tipo==='inventario'?['ID','Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda','Acciones']:['ID','Nombre','Acciones'];
    cols.forEach(c=>{const th=document.createElement('th');th.innerText=c;trh.appendChild(th)});
    thead.appendChild(trh);table.appendChild(thead);
    const tbody=document.createElement('tbody');
    data.forEach((item,i)=>{
        if(currentSearch && !Object.values(item).join(' ').toLowerCase().includes(currentSearch.toLowerCase())) return;
        const tr=document.createElement('tr');
        if(tipo==='inventario'){['id','Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda'].forEach(f=>{const td=document.createElement('td');td.innerText=item[f]||'';tr.appendChild(td)})} else {const td1=document.createElement('td');td1.innerText=item.id;tr.appendChild(td1);const td2=document.createElement('td');td2.innerText=item.nombre;tr.appendChild(td2);}
        const tdA=document.createElement('td');tdA.className='actions';
        const editBtn=document.createElement('button');editBtn.className='btn-edit';editBtn.innerHTML='<i class="fa-solid fa-pen"></i>';editBtn.onclick=()=>openAddForm(tipo,i);
        const delBtn=document.createElement('button');delBtn.className='btn-del';delBtn.innerHTML='<i class="fa-solid fa-trash"></i>';delBtn.onclick=()=>deleteItem(tipo,i);
        tdA.appendChild(editBtn);tdA.appendChild(delBtn);tr.appendChild(tdA);
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);container.appendChild(table);
}

function nav(view){currentView=view;document.getElementById('main-title').innerText=view.charAt(0).toUpperCase()+view.slice(1);render()}

// Inicialización
loadData();
loadInitialData();
</script>
</body>
</html>
