<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f9f9f9;}
header{background:#ff4d00;color:white;padding:10px;font-size:20px;text-align:center;}
nav{display:flex;gap:10px;background:#333;padding:10px;flex-wrap:wrap;}
nav button{background:#444;color:white;border:none;padding:8px 12px;cursor:pointer;border-radius:5px;}
nav button.active{background:#ff4d00;}
#content{padding:20px;}
.card{background:white;border-radius:10px;padding:20px;box-shadow:0 2px 5px rgba(0,0,0,0.1);margin:10px;display:flex;align-items:center;gap:10px;}
.cards{display:flex;gap:20px;flex-wrap:wrap;}
table{width:100%;border-collapse:collapse;background:white;margin-top:20px;}
th,td{padding:8px;border:1px solid #ddd;text-align:left;}
button{cursor:pointer;}
</style>
</head>
<body>
<header>Inventario Tiendas 3A</header>
<nav>
  <button onclick="nav('dashboard')" id="btnDashboard" class="active">Dashboard</button>
  <button onclick="nav('inventario')" id="btnInventario">Inventario</button>
  <button onclick="nav('categoria')" id="btnCategoria">Categor√≠as</button>
  <button onclick="nav('tienda')" id="btnTienda">Tiendas</button>
</nav>

<div id="content"></div>

<script>
const APPWEB_URL="TU_URL_DE_APPS_SCRIPT_AQUI"; // ‚ö° Pega tu URL de despliegue aqu√≠
let inventario=[], categorias=[], tiendas=[], pendingOps=[];
let currentView='dashboard';
const STORAGE_KEY='inventario3a';

// ===== Local Storage =====
function saveData(){localStorage.setItem(STORAGE_KEY, JSON.stringify({inventario,categorias,tiendas,pendingOps}));}
function loadData(){
  const data=localStorage.getItem(STORAGE_KEY);
  if(data){
    const parsed=JSON.parse(data);
    inventario=parsed.inventario||[];
    categorias=parsed.categorias||[];
    tiendas=parsed.tiendas||[];
    pendingOps=parsed.pendingOps||[];
  }
}

// ===== Fetch desde AppWeb =====
async function fetchSheet(sheet){
  try{
    const res=await fetch(`${APPWEB_URL}?sheet=${sheet}&action=get`);
    const json=await res.json();
    return json.map(row=>{
      return {
        idSheet: row.id, 
        nombre: row.nombre || row.Nombre || row.Categoria || row.Tienda || '',
        Codigo: row.Codigo||'',
        Serie: row.Serie||'',
        Equipo: row.Equipo||'',
        Marca: row.Marca||'',
        Modelo: row.Modelo||'',
        Categoria: row.Categoria||'',
        Tienda: row.Tienda||''
      };
    });
  }catch(e){console.warn("Error fetch",e); return [];}
}

async function loadInitialData(){
  const [inv,cat,td]=await Promise.all([fetchSheet('Inventario'),fetchSheet('Categorias'),fetchSheet('Tiendas')]);
  inventario=inv; categorias=cat; tiendas=td; pendingOps=[];
  saveData(); render();
}

// ===== Cola de sincronizaci√≥n =====
async function syncItem(tipo,item,action){
  let sheet=tipo==="inventario"?"Inventario":tipo==="categoria"?"Categorias":"Tiendas";
  const params=new URLSearchParams({sheet,action});
  
  if(action==="add"){
    Object.keys(item).forEach(k=>{ if(k!=="idLocal") params.append(k,item[k]||""); });
  }else if(action==="update" || action==="delete"){
    params.append("idCol","id").append("idValue", item.idSheet);
    if(action==="update"){
      Object.keys(item).forEach(k=>{
        if(k!=="idLocal" && k!=="idSheet") params.append(k,item[k]||"");
      });
    }
  }

  const res=await fetch(`${APPWEB_URL}?${params.toString()}`);
  const data=await res.json();
  if(action==="add" && data.id){ // AppWeb devuelve id real
    item.idSheet=data.id;
    replaceLocalId(item);
  }
  return true;
}

function replaceLocalId(item){
  let arr=(item.Equipo!==undefined)?inventario:(item.Tienda!==undefined?tiendas:categorias);
  let idx=arr.findIndex(r=>r.idLocal===item.idLocal);
  if(idx>-1){
    arr[idx].idSheet=item.idSheet;
    delete arr[idx].idLocal;
  }
}

async function syncPending(){
  if(pendingOps.length===0) return;
  let ops=[...pendingOps];
  for(let op of ops){
    try{
      await syncItem(op.tipo,op.item,op.action);
      pendingOps=pendingOps.filter(p=>p!==op);
    }catch(e){console.warn("Sync error:",e);}
  }
  saveData();
}

// ===== Operaciones locales =====
function addLocal(tipo,obj){
  obj.idLocal=crypto.randomUUID();
  if(tipo==='inventario') inventario.push(obj);
  if(tipo==='categoria') categorias.push(obj);
  if(tipo==='tienda') tiendas.push(obj);
  pendingOps.push({tipo,action:'add',item:obj});
  saveData(); render();
}

function updateLocal(tipo,index,obj){
  let arr=(tipo==='inventario')?inventario:(tipo==='categoria')?categorias:tiendas;
  let old=arr[index];
  obj.idSheet=old.idSheet||null; obj.idLocal=old.idLocal||null;
  arr[index]=obj;
  pendingOps.push({tipo,action:'update',item:obj});
  saveData(); render();
}

function deleteLocal(tipo,index){
  let arr=(tipo==='inventario')?inventario:(tipo==='categoria')?categorias:tiendas;
  let obj=arr[index];
  arr.splice(index,1);
  pendingOps.push({tipo,action:'delete',item:obj});
  saveData(); render();
}

// ===== Render =====
function render(){
  const c=document.getElementById('content'); c.innerHTML='';
  if(currentView==='dashboard'){
    c.innerHTML=`<div class="cards">
      <div class="card"><i class="fa-solid fa-computer"></i><span>Equipos: ${inventario.length}</span></div>
      <div class="card"><i class="fa-solid fa-tags"></i><span>Categor√≠as: ${categorias.length}</span></div>
      <div class="card"><i class="fa-solid fa-store"></i><span>Tiendas: ${tiendas.length}</span></div>
    </div>`;
  }
  if(currentView==='categoria'){
    let html=`<button onclick="addLocal('categoria',{nombre:'Nueva Categor√≠a'})">‚ûï Nueva Categor√≠a</button>`;
    html+=`<table><tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr>`;
    categorias.forEach((c,idx)=>{
      html+=`<tr><td>${c.idSheet||c.idLocal}</td><td>${c.nombre}</td>
      <td><button onclick="updateLocal('categoria',${idx},{nombre:'Editada'})">‚úèÔ∏è</button>
      <button onclick="deleteLocal('categoria',${idx})">üóëÔ∏è</button></td></tr>`;
    });
    html+="</table>"; c.innerHTML=html;
  }
  if(currentView==='tienda'){
    let html=`<button onclick="addLocal('tienda',{nombre:'Nueva Tienda'})">‚ûï Nueva Tienda</button>`;
    html+=`<table><tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr>`;
    tiendas.forEach((t,idx)=>{
      html+=`<tr><td>${t.idSheet||t.idLocal}</td><td>${t.nombre}</td>
      <td><button onclick="updateLocal('tienda',${idx},{nombre:'Editada'})">‚úèÔ∏è</button>
      <button onclick="deleteLocal('tienda',${idx})">üóëÔ∏è</button></td></tr>`;
    });
    html+="</table>"; c.innerHTML=html;
  }
  if(currentView==='inventario'){
    let html=`<button onclick="addLocal('inventario',{Equipo:'PC',Codigo:'X1'})">‚ûï Nuevo Equipo</button>`;
    html+=`<table><tr><th>ID</th><th>Equipo</th><th>C√≥digo</th><th>Acciones</th></tr>`;
    inventario.forEach((i,idx)=>{
      html+=`<tr><td>${i.idSheet||i.idLocal}</td><td>${i.Equipo}</td><td>${i.Codigo}</td>
      <td><button onclick="updateLocal('inventario',${idx},{Equipo:'Editado',Codigo:'Z9'})">‚úèÔ∏è</button>
      <button onclick="deleteLocal('inventario',${idx})">üóëÔ∏è</button></td></tr>`;
    });
    html+="</table>"; c.innerHTML=html;
  }
}

// ===== Navegaci√≥n =====
function nav(view){
  currentView=view;
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn"+view.charAt(0).toUpperCase()+view.slice(1)).classList.add("active");
  render();
}

// ===== Start =====
loadData(); render(); loadInitialData();
setInterval(syncPending, 10000); // sincroniza cada 10s
</script>
</body>
</html>
