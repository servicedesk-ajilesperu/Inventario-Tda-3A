<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:sans-serif;}
body,html{height:100%;width:100%;}
.hidden{display:none;}
/* Sidebar */
.sidebar{width:260px;position:fixed;height:100%;overflow:hidden;background:#0f62fe;color:white;display:flex;flex-direction:column;gap:12px;padding:20px;transition:width 0.3s;}
.sidebar.collapsed{width:60px;padding:20px 5px;}
.brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:1.15rem;position:relative;}
#toggleSidebar{position:absolute; right:10px; top:10px; background:#0f62fe; color:white; border:none; border-radius:6px; padding:4px 8px; cursor:pointer; z-index:1000;}
.menu-section .accordion{background:transparent;color:white;border:none;padding:10px;width:100%;cursor:pointer;font-weight:600;display:flex;justify-content:space-between;align-items:center;border-radius:8px;transition:0.2s;position:relative;}
.menu-section .accordion:hover{background: rgba(255,255,255,0.1);}
.menu-section .panel{display:flex;flex-direction:column;padding-left:10px;gap:6px;overflow:hidden;max-height:0;transition:max-height 0.3s ease;}
.menu-section .accordion.active + .panel{max-height:500px;}
.menu-section .panel button{padding:6px 10px;font-size:0.9rem;text-align:left;background:rgba(255,255,255,0.05);border:none;border-radius:6px;color:white;cursor:pointer;display:flex;align-items:center;gap:6px;position:relative;}
.menu-section .panel button:hover{background: rgba(255,255,255,0.15);}
.sidebar.collapsed .brand span,.sidebar.collapsed .panel button span,.sidebar.collapsed .accordion span,.sidebar.collapsed .menu-section button span { display: none; }
.sidebar.collapsed .panel button::after,.sidebar.collapsed .accordion::after,.sidebar.collapsed .menu-section button::after{
  content: attr(title);
  position: absolute;
  left: 70px;
  background: #0f62fe;
  color: white;
  padding: 3px 6px;
  border-radius: 4px;
  display: none;
  white-space: nowrap;
  font-size: 0.8rem;
  z-index:1000;
}
.sidebar.collapsed .panel button:hover::after,.sidebar.collapsed .accordion:hover::after,.sidebar.collapsed .menu-section button:hover::after{ display: block; }
.main{flex:1;margin-left:260px;transition:margin-left 0.3s;display:flex;flex-direction:column;height:100vh;}
.sidebar.collapsed ~ .main{margin-left:60px;}
header.appbar{height:64px;background:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 22px;box-shadow:0 2px 8px rgba(15,98,254,0.06);position:sticky;top:0;z-index:10;}
.app-title{font-weight:700;color:#0f62fe;}
.counter{background:linear-gradient(90deg, rgba(15,98,254,0.08), rgba(255,77,0,0.06));padding:8px 12px;border-radius:999px;font-weight:600;display:flex;gap:10px;align-items:center;font-size:0.95rem;}
.content{padding:20px;height:calc(100vh - 64px);overflow:auto;display:flex;flex-direction:column;gap:18px;}
.cards{display:flex;gap:20px;flex-wrap:wrap;}
.card{flex:1;min-width:150px;background:white;padding:15px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.08);display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center;cursor:pointer;transition:0.2s;}
.card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.15);}
.card i{font-size:24px;color:#0f62fe;}
.card .card-title{font-weight:700;font-size:1.2rem;}
.card .card-count{font-size:0.9rem;color:#555;}
input, select{padding:6px;border-radius:6px;border:1px solid #ccc;width:100%;}
button.btn-save{background:#0f62fe;color:white;padding:8px 12px;border-radius:6px;border:none;cursor:pointer;}
button.btn-cancel{background:#ccc;color:black;padding:8px 12px;border-radius:6px;border:none;cursor:pointer;}
table{width:100%;border-collapse:collapse;font-size:0.95rem;margin-top:10px;}
thead th{background:#ff4d00;color:#fff;padding:12px;text-align:center;}
tbody td{padding:10px;border-bottom:1px solid #edf0f5;text-align:center;vertical-align:middle;}
.actions button{margin:0 2px;padding:6px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;width:32px;height:32px;transition:0.2s;}
.btn-edit{background:#ffb86b;color:white;}
.btn-edit:hover{background:#ffa500;}
.btn-del{background:#ff6b6b;color:white;}
.btn-del:hover{background:#ff3b3b;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:50;}
.modal{background:white;padding:20px;border-radius:12px;width:400px;max-width:95%;}
.search-input{margin-bottom:10px;padding:6px;border-radius:6px;border:1px solid #ccc;width:300px;}
@media(max-width:768px){.sidebar{left:-260px;position:fixed}.sidebar.collapsed{left:0}.main{margin-left:0}}
</style>
</head>
<body>

<div id="app">
  <aside class="sidebar">
    <div class="brand"><i class="fa-solid fa-boxes-stacked"></i><span>Inventario</span><button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button></div>
    
    <div class="menu-section"><button title="Dashboard" onclick="nav('dashboard')"><i class="fa-solid fa-house"></i><span>Dashboard</span></button></div>
    
    <div class="menu-section">
      <button class="accordion" title="Equipos"><i class="fa-solid fa-computer"></i> <span>Equipos</span> <i class="fa-solid fa-chevron-down"></i></button>
      <div class="panel">
        <button title="Agregar equipo" onclick="openModal()"><i class="fa-solid fa-plus"></i> <span>Agregar equipo</span></button>
        <button title="Ver inventario" onclick="nav('list')"><i class="fa-solid fa-table-list"></i> <span>Ver inventario</span></button>
        <button title="Exportar Inventario" onclick="exportExcel()"><i class="fa-solid fa-file-excel"></i> <span>Exportar</span></button>
      </div>
    </div>
    
    <div class="menu-section">
      <button class="accordion" title="Categorías"><i class="fa-solid fa-tags"></i> <span>Categorías</span> <i class="fa-solid fa-chevron-down"></i></button>
      <div class="panel">
        <button title="Ver categorías" onclick="showCategories()"><i class="fa-solid fa-table-list"></i> <span>Ver categorías</span></button>
        <button title="Agregar categoría" onclick="openCategoryModal()"><i class="fa-solid fa-plus"></i> <span>Agregar categoría</span></button>
      </div>
    </div>
    
    <div class="menu-section">
      <button class="accordion" title="Tiendas"><i class="fa-solid fa-store"></i> <span>Tiendas</span> <i class="fa-solid fa-chevron-down"></i></button>
      <div class="panel">
        <button title="Ver tiendas" onclick="showStores()"><i class="fa-solid fa-table-list"></i> <span>Ver tiendas</span></button>
        <button title="Agregar tienda" onclick="openStoreModal()"><i class="fa-solid fa-plus"></i> <span>Agregar tienda</span></button>
      </div>
    </div>
  </aside>

  <div class="main">
    <header class="appbar"><div class="app-title">Inventario Tiendas 3A</div><div class="counter" id="header-counter">Total: 0</div></header>
    <main class="content" id="main-content"></main>
  </div>

  <!-- Modal Agregar/Editar Equipo -->
  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <h3 id="modalTitle">Agregar Equipo</h3>
      <div class="form-grid" style="display:flex;flex-direction:column;gap:10px;">
        <input id="f_codigo" placeholder="Código de Inventario *"/>
        <input id="f_serie" placeholder="Serie *"/>
        <input id="f_equipo" placeholder="Nombre Equipo *"/>
        <input id="f_marca" placeholder="Marca"/>
        <input id="f_modelo" placeholder="Modelo"/>
        <select id="f_categoria"></select>
        <select id="f_tienda"></select>
      </div>
      <div style="text-align:right;margin-top:12px">
        <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
        <button class="btn-save" onclick="saveFromModal()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Agregar/Editar Categoría/Tienda -->
  <div class="modal-backdrop" id="modal-category-store">
    <div class="modal">
      <h3 id="modalCategoryStoreTitle"></h3>
      <input type="text" id="f_category_store_name" placeholder="Nombre *"/>
      <div style="text-align:right;margin-top:12px">
        <button class="btn-cancel" onclick="closeCategoryStoreModal()">Cancelar</button>
        <button class="btn-save" onclick="saveCategoryStore()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
// URL de Google Apps Script
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec';

let inventario=[], categorias=[], tiendas=[], state={view:'dashboard'}, editIdx=null, categoryOrStore='';

// --- Inicialización ---
window.onload=function(){ initApp(); }
async function initApp(){
  await loadAllData();
  document.querySelectorAll('.accordion').forEach(a=>a.addEventListener('click',function(){this.classList.toggle('active'); let p=this.nextElementSibling; if(p){p.style.maxHeight=p.style.maxHeight?'0':p.scrollHeight+'px';}}));
  document.getElementById('toggleSidebar').addEventListener('click',()=>document.querySelector('.sidebar').classList.toggle('collapsed'));
  render();
}

// --- Fetch/POST/PUT/DELETE ---
async function fetchData(sheet){ 
  const res = await fetch(GAS_WEB_APP_URL+'?action=get&sheet='+sheet); 
  return await res.json(); 
}

async function postData(sheet,data){ 
  await fetch(GAS_WEB_APP_URL,{method:'POST',body:JSON.stringify({action:'add',sheet:sheet,data:data})});
}

async function updateData(sheet,index,data){ 
  await fetch(GAS_WEB_APP_URL,{method:'POST',body:JSON.stringify({action:'update',sheet:sheet,index:index,data:data})});
}

async function deleteData(sheet,index){ 
  await fetch(GAS_WEB_APP_URL,{method:'POST',body:JSON.stringify({action:'delete',sheet:sheet,index:index})});
}

// --- Cargar todo ---
async function loadAllData(){
  inventario = await fetchData('Inventario');
  categorias = await fetchData('Categorias');
  tiendas = await fetchData('Tiendas');
}

// --- Navegación ---
function nav(view){ state.view=view; render(); }

// --- Render ---
function render(){
  const main = document.getElementById('main-content');
  main.innerHTML='';
  if(state.view==='dashboard'){
    main.innerHTML=`<h3>Dashboard</h3>
    <div class="cards">
      <div class="card" onclick="nav('list')"><i class="fa-solid fa-computer"></i><div class="card-title">Equipos</div><div class="card-count">${inventario.length}</div></div>
      <div class="card" onclick="showCategories()"><i class="fa-solid fa-tags"></i><div class="card-title">Categorías</div><div class="card-count">${categorias.length}</div></div>
      <div class="card" onclick="showStores()"><i class="fa-solid fa-store"></i><div class="card-title">Tiendas</div><div class="card-count">${tiendas.length}</div></div>
    </div>`;
  } else if(state.view==='list'){
    main.innerHTML=`<input class="search-input" placeholder="Buscar..." oninput="filterTable(this.value)"/>
      <table id="inventario-table"><thead><tr><th>ID</th><th>Código</th><th>Serie</th><th>Equipo</th><th>Marca</th><th>Modelo</th><th>Categoria</th><th>Tienda</th><th>Acciones</th></tr></thead><tbody>${inventario.map((i,idx)=>`<tr>
        <td>${idx+1}</td><td>${i.codigo}</td><td>${i.serie}</td><td>${i.equipo}</td><td>${i.marca}</td><td>${i.modelo}</td><td>${i.categoria}</td><td>${i.tienda}</td>
        <td class="actions"><button class="btn-edit" onclick="editItem(${idx})"><i class="fa-solid fa-pen"></i></button>
        <button class="btn-del" onclick="removeItem(${idx})"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('')}</tbody></table>`;
  }
  updateCounter();
}

// --- Contador ---
function updateCounter(){ document.getElementById('header-counter').innerText='Total: '+inventario.length; }

// --- Filtrar tabla ---
function filterTable(q){ const table=document.getElementById('inventario-table'); if(!table) return; table.querySelectorAll('tbody tr').forEach(tr=>{tr.style.display=tr.innerText.toLowerCase().includes(q.toLowerCase())?'':'none';}); }

// --- Modal Equipo ---
function openModal(){ editIdx=null; document.getElementById('modalTitle').innerText='Agregar Equipo'; document.getElementById('f_codigo').value=''; document.getElementById('f_serie').value=''; document.getElementById('f_equipo').value=''; document.getElementById('f_marca').value=''; document.getElementById('f_modelo').value=''; fillSelect('f_categoria',categorias); fillSelect('f_tienda',tiendas); document.getElementById('modal').style.display='flex';}
function closeModal(){ document.getElementById('modal').style.display='none'; }
function fillSelect(id,arr){ const sel=document.getElementById(id); sel.innerHTML=''; arr.forEach(e=>{const opt=document.createElement('option'); opt.value=e.nombre||e.tienda; opt.text=e.nombre||e.tienda; sel.add(opt);});}
async function saveFromModal(){
  const data={codigo:document.getElementById('f_codigo').value, serie:document.getElementById('f_serie').value, equipo:document.getElementById('f_equipo').value, marca:document.getElementById('f_marca').value, modelo:document.getElementById('f_modelo').value, categoria:document.getElementById('f_categoria').value, tienda:document.getElementById('f_tienda').value};
  if(editIdx!==null){ await updateData('Inventario',editIdx,data);} else { await postData('Inventario',data);}
  await loadAllData(); closeModal(); render();
}
function editItem(idx){ editIdx=idx; const i=inventario[idx]; document.getElementById('modalTitle').innerText='Editar Equipo'; document.getElementById('f_codigo').value=i.codigo; document.getElementById('f_serie').value=i.serie; document.getElementById('f_equipo').value=i.equipo; document.getElementById('f_marca').value=i.marca; document.getElementById('f_modelo').value=i.modelo; fillSelect('f_categoria',categorias); document.getElementById('f_categoria').value=i.categoria; fillSelect('f_tienda',tiendas); document.getElementById('f_tienda').value=i.tienda; document.getElementById('modal').style.display='flex'; }
async function removeItem(idx){ if(confirm('Eliminar equipo?')){ await deleteData('Inventario',idx); await loadAllData(); render(); }}

// --- Modal Categoría/Tienda ---
function openCategoryModal(){ categoryOrStore='Categorias'; document.getElementById('modalCategoryStoreTitle').innerText='Agregar Categoría'; document.getElementById('f_category_store_name').value=''; document.getElementById('modal-category-store').style.display='flex'; }
function openStoreModal(){ categoryOrStore='Tiendas'; document.getElementById('modalCategoryStoreTitle').innerText='Agregar Tienda'; document.getElementById('f_category_store_name').value=''; document.getElementById('modal-category-store').style.display='flex'; }
function closeCategoryStoreModal(){ document.getElementById('modal-category-store').style.display='none'; }
async function saveCategoryStore(){ const name=document.getElementById('f_category_store_name').value; if(!name) return alert('Ingrese nombre'); await postData(categoryOrStore,{nombre:name}); await loadAllData(); closeCategoryStoreModal(); render(); }
function showCategories(){ state.view='categories'; const main=document.getElementById('main-content'); main.innerHTML='<h3>Categorías</h3><ul>'+categorias.map(c=>`<li>${c.nombre}</li>`).join('')+'</ul>'; }
function showStores(){ state.view='stores'; const main=document.getElementById('main-content'); main.innerHTML='<h3>Tiendas</h3><ul>'+tiendas.map(t=>`<li>${t.tienda}</li>`).join('')+'</ul>'; }

// --- Export CSV ---
function exportExcel(){ let csv='Código,Serie,Equipo,Marca,Modelo,Categoria,Tienda\n'; inventario.forEach(i=>csv+=`${i.codigo},${i.serie},${i.equipo},${i.marca},${i.modelo},${i.categoria},${i.tienda}\n`); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='inventario.csv'; a.click(); URL.revokeObjectURL(url);}
</script>
</body>
</html>
