<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventario Tiendas 3A</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body{margin:0;font-family:Arial,sans-serif;display:flex;height:100vh}
    .sidebar{width:220px;background:#333;color:#fff;padding:20px}
    .sidebar h2{font-size:20px;margin-bottom:20px}
    .sidebar a{display:block;color:#fff;text-decoration:none;margin:10px 0;padding:8px;border-radius:4px}
    .sidebar a:hover{background:#444}
    .content{flex:1;padding:20px;overflow:auto}
    .dashboard{display:flex;gap:20px;margin-bottom:20px}
    .card{flex:1;padding:20px;border-radius:10px;background:#f5f5f5;box-shadow:0 2px 5px rgba(0,0,0,0.1);text-align:center}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ccc;padding:8px;text-align:left}
    th{background:#eee}
    .actions button{margin:0 2px;padding:6px;border-radius:50%;border:none;cursor:pointer;width:32px;height:32px}
    .btn-edit{background:#ffb86b;color:white}
    .btn-del{background:#ff6b6b;color:white}
    .btn-add{padding:6px 12px;margin:10px 0;background:#4CAF50;color:#fff;border:none;border-radius:5px;cursor:pointer}
    .search-input{padding:5px;margin-bottom:10px;width:200px}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
    .modal-content{background:#fff;padding:20px;border-radius:8px;min-width:300px}
    .modal-content input,select{width:100%;margin:5px 0;padding:6px}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Menú</h2>
    <a href="#" onclick="renderInventario()">Inventario</a>
    <a href="#" onclick="showCategories()">Categorías</a>
    <a href="#" onclick="showStores()">Tiendas</a>
  </div>

  <div class="content">
    <div class="dashboard">
      <div class="card"><h3>Inventario</h3><p id="countInventario">0</p></div>
      <div class="card"><h3>Categorías</h3><p id="countCategorias">0</p></div>
      <div class="card"><h3>Tiendas</h3><p id="countTiendas">0</p></div>
    </div>
    <div id="main-content"></div>
  </div>

  <!-- Modal Inventario -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h3>Equipo</h3>
      <input id="f_codigo" placeholder="Código">
      <input id="f_serie" placeholder="Serie">
      <input id="f_equipo" placeholder="Equipo">
      <input id="f_marca" placeholder="Marca">
      <input id="f_modelo" placeholder="Modelo">
      <select id="f_categoria"></select>
      <select id="f_tienda"></select>
      <button onclick="saveFromModal()">Guardar</button>
      <button onclick="closeModal()">Cancelar</button>
    </div>
  </div>

  <!-- Modal Categoría/Tienda -->
  <div id="modal-category-store" class="modal">
    <div class="modal-content">
      <h3 id="modalCategoryStoreTitle"></h3>
      <input id="f_category_store_name" placeholder="Nombre">
      <button onclick="saveCategoryStore()">Guardar</button>
      <button onclick="closeCategoryStoreModal()">Cancelar</button>
    </div>
  </div>

  <script>
    const API_URL="https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";
    let inventario=[],categorias=[],tiendas=[];
    let categoryOrStore="";

    async function loadData(){
      [inventario,categorias,tiendas]=await Promise.all([
        fetch(API_URL+"?sheet=Inventario&action=get").then(r=>r.json()),
        fetch(API_URL+"?sheet=Categorias&action=get").then(r=>r.json()),
        fetch(API_URL+"?sheet=Tiendas&action=get").then(r=>r.json())
      ]);
      document.getElementById("countInventario").innerText=inventario.length;
      document.getElementById("countCategorias").innerText=categorias.length;
      document.getElementById("countTiendas").innerText=tiendas.length;
      renderInventario();
    }

    /* --- INVENTARIO --- */
    function renderInventario(){
      const main=document.getElementById('main-content');
      let table='<h3>Inventario</h3><button class="btn-add" onclick="openModal()">+ Agregar</button>';
      table+='<table><thead><tr><th>ID</th><th>Código</th><th>Serie</th><th>Equipo</th><th>Marca</th><th>Modelo</th><th>Categoría</th><th>Tienda</th><th>Acciones</th></tr></thead><tbody>';
      inventario.forEach((i,idx)=>{
        table+=`<tr>
          <td>${idx+1}</td><td>${i.Codigo}</td><td>${i.Serie}</td><td>${i.Equipo}</td><td>${i.Marca}</td><td>${i.Modelo}</td>
          <td>${i.Categoría}</td><td>${i.Tienda}</td>
          <td class="actions">
            <button class="btn-edit" onclick="editEquipo(${idx})"><i class="fa fa-pen"></i></button>
            <button class="btn-del" onclick="deleteEquipo('${i.Codigo}')"><i class="fa fa-trash"></i></button>
          </td>
        </tr>`;
      });
      table+='</tbody></table>'; 
      main.innerHTML=table;
    }
    function openModal(){document.getElementById('modal').style.display='flex';fillSelects(); }
    function closeModal(){document.getElementById('modal').style.display='none';clearForm();}
    function fillSelects(){
      let selC=document.getElementById('f_categoria');selC.innerHTML=categorias.map(c=>`<option>${c.Nombre||c.Categoria||c}</option>`).join("");
      let selT=document.getElementById('f_tienda');selT.innerHTML=tiendas.map(t=>`<option>${t.Nombre||t.Tienda||t}</option>`).join("");
    }
    function clearForm(){['f_codigo','f_serie','f_equipo','f_marca','f_modelo'].forEach(id=>document.getElementById(id).value="");document.getElementById('modal').removeAttribute('data-edit');}
    function editEquipo(idx){
      const e=inventario[idx];openModal();
      f_codigo.value=e.Codigo;f_serie.value=e.Serie;f_equipo.value=e.Equipo;f_marca.value=e.Marca;f_modelo.value=e.Modelo;
      f_categoria.value=e.Categoría;f_tienda.value=e.Tienda;
      document.getElementById('modal').setAttribute('data-edit',e.Codigo);
    }
    async function saveFromModal(){
      const codigo=f_codigo.value.trim(),serie=f_serie.value.trim(),equipo=f_equipo.value.trim(),marca=f_marca.value.trim(),modelo=f_modelo.value.trim();
      const categoria=f_categoria.value,tienda=f_tienda.value;
      if(!codigo||!serie||!equipo||!categoria||!tienda){alert("Campos obligatorios");return;}
      const editId=document.getElementById('modal').getAttribute('data-edit');
      if(editId){
        await fetch(`${API_URL}?sheet=Inventario&action=update&idCol=Codigo&idValue=${editId}&Codigo=${codigo}&Serie=${serie}&Equipo=${equipo}&Marca=${marca}&Modelo=${modelo}&Categoría=${categoria}&Tienda=${tienda}`);
      }else{
        await fetch(`${API_URL}?sheet=Inventario&action=add&Codigo=${codigo}&Serie=${serie}&Equipo=${equipo}&Marca=${marca}&Modelo=${modelo}&Categoría=${categoria}&Tienda=${tienda}`);
      }
      closeModal();loadData();
    }
    async function deleteEquipo(codigo){
      if(confirm("¿Eliminar este equipo?")){
        await fetch(`${API_URL}?sheet=Inventario&action=delete&idCol=Codigo&idValue=${codigo}`);
        loadData();
      }
    }

    /* --- CATEGORÍAS --- */
    function showCategories(){
      const main=document.getElementById('main-content');
      let table='<h3>Categorías</h3><button class="btn-add" onclick="openCategoryModal(\'Categorias\')">+ Agregar</button>';
      table+='<table><thead><tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr></thead><tbody>';
      categorias.forEach((c,i)=>{
        let nombre=c.Nombre||c.Categoria||c;
        table+=`<tr><td>${i+1}</td><td>${nombre}</td>
          <td class="actions">
            <button class="btn-edit" onclick="editCategory('${nombre}')"><i class="fa fa-pen"></i></button>
            <button class="btn-del" onclick="deleteCategory('${nombre}')"><i class="fa fa-trash"></i></button>
          </td></tr>`;
      });
      table+='</tbody></table>';main.innerHTML=table;
    }
    function openCategoryModal(type){categoryOrStore=type;document.getElementById('modalCategoryStoreTitle').innerText="Nueva "+type;document.getElementById('modal-category-store').style.display='flex';}
    function closeCategoryStoreModal(){document.getElementById('modal-category-store').style.display='none';f_category_store_name.value="";document.getElementById('modal-category-store').removeAttribute('data-edit');}
    function editCategory(nombre){categoryOrStore='Categorias';document.getElementById('modalCategoryStoreTitle').innerText='Editar Categoría';f_category_store_name.value=nombre;document.getElementById('modal-category-store').setAttribute('data-edit',nombre);document.getElementById('modal-category-store').style.display='flex';}
    async function saveCategoryStore(){
      const name=f_category_store_name.value.trim();if(!name){alert("Ingresa un nombre");return;}
      const editId=document.getElementById('modal-category-store').getAttribute('data-edit');
      if(editId){await fetch(`${API_URL}?sheet=${categoryOrStore}&action=update&idCol=Nombre&idValue=${editId}&Nombre=${name}`);}
      else{await fetch(`${API_URL}?sheet=${categoryOrStore}&action=add&Nombre=${name}`);}
      closeCategoryStoreModal();loadData();
    }
    async function deleteCategory(nombre){if(confirm("¿Eliminar esta categoría?")){await fetch(`${API_URL}?sheet=Categorias&action=delete&idCol=Nombre&idValue=${nombre}`);loadData();}}

    /* --- TIENDAS --- */
    function showStores(){
      const main=document.getElementById('main-content');
      let table='<h3>Tiendas</h3><button class="btn-add" onclick="openCategoryModal(\'Tiendas\')">+ Agregar</button>';
      table+='<table><thead><tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr></thead><tbody>';
      tiendas.forEach((t,i)=>{
        let nombre=t.Nombre||t.Tienda||t;
        table+=`<tr><td>${i+1}</td><td>${nombre}</td>
          <td class="actions">
            <button class="btn-edit" onclick="editStore('${nombre}')"><i class="fa fa-pen"></i></button>
            <button class="btn-del" onclick="deleteStore('${nombre}')"><i class="fa fa-trash"></i></button>
          </td></tr>`;
      });
      table+='</tbody></table>';main.innerHTML=table;
    }
    function editStore(nombre){categoryOrStore='Tiendas';document.getElementById('modalCategoryStoreTitle').innerText='Editar Tienda';f_category_store_name.value=nombre;document.getElementById('modal-category-store').setAttribute('data-edit',nombre);document.getElementById('modal-category-store').style.display='flex';}
    async function deleteStore(nombre){if(confirm("¿Eliminar esta tienda?")){await fetch(`${API_URL}?sheet=Tiendas&action=delete&idCol=Nombre&idValue=${nombre}`);loadData();}}

    loadData();
  </script>
</body>
</html>
