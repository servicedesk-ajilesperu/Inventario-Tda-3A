<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
/* === ESTILOS GENERALES === */
body,html{margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;background:#f4f6f9;color:#333;}
h1,h2,h3{margin:0;}
.container{display:flex;min-height:100vh;}
/* === SIDEBAR === */
.sidebar{width:220px;background:#2c3e50;color:#fff;display:flex;flex-direction:column;}
.sidebar h2{padding:1rem;text-align:center;border-bottom:1px solid rgba(255,255,255,0.1);}
.sidebar a{padding:1rem;color:#fff;text-decoration:none;display:block;border-bottom:1px solid rgba(255,255,255,0.1);}
.sidebar a:hover{background:#34495e;}
/* === MAIN === */
.main{flex:1;padding:1rem;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
header h1{font-size:1.5rem;}
.btn{background:#3498db;color:#fff;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;}
.btn:hover{background:#2980b9;}
/* === DASHBOARD CARDS === */
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;}
.card{background:#fff;padding:1.5rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);display:flex;flex-direction:column;align-items:center;justify-content:center;}
.card i{font-size:2rem;margin-bottom:0.5rem;color:#3498db;}
.card h3{margin:0;font-size:1.2rem;}
.card p{font-size:1.5rem;font-weight:bold;margin:0;}
/* === TABLAS === */
table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
th,td{padding:0.75rem;text-align:left;border-bottom:1px solid #ddd;}
th{background:#3498db;color:#fff;}
tr:hover{background:#f1f1f1;}
.actions button{border:none;padding:0.3rem 0.6rem;margin:0 0.2rem;border-radius:4px;cursor:pointer;}
.btn-edit{background:#f39c12;color:#fff;}
.btn-edit:hover{background:#d68910;}
.btn-del{background:#e74c3c;color:#fff;}
.btn-del:hover{background:#c0392b;}
/* === MODAL === */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
.modal-content{background:#fff;padding:2rem;border-radius:8px;min-width:300px;max-width:500px;width:100%;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
.close{cursor:pointer;font-size:1.2rem;}
/* === SEARCH BAR === */
.search-bar{margin-bottom:1rem;}
.search-bar input{width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:4px;}
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h2>Inventario 3A</h2>
    <a href="#" onclick="renderTable('dashboard')"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
    <a href="#" onclick="renderTable('tienda')"><i class="fa-solid fa-store"></i> Tiendas</a>
    <a href="#" onclick="renderTable('categoria')"><i class="fa-solid fa-tags"></i> Categorías</a>
    <a href="#" onclick="renderTable('inventario')"><i class="fa-solid fa-boxes-stacked"></i> Inventario</a>
  </div>
  <div class="main">
    <header>
      <h1 id="main-title">Dashboard</h1>
      <button class="btn" onclick="openModal()">Agregar</button>
    </header>
    <div id="content"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">Agregar</h2>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <form id="form">
      <div id="form-fields"></div>
      <button type="submit" class="btn">Guardar</button>
    </form>
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxZYvau-tS7jCLqsNmwUkxK4wfkcL2AveUVJGUNKw2n/exec";
let currentSheet="dashboard";
let currentData=[];
let editIndex=-1;
let dataStore={tienda:[],categoria:[],inventario:[]};

// === FETCH SHEET ===
async function fetchSheet(sheet){
  try{
    const res=await fetch(`${scriptURL}?sheet=${sheet}`);
    const data=await res.json();
    if(data.success){
      dataStore[sheet]=data.records;
      return data.records;
    }else throw new Error(data.msg);
  }catch(err){
    console.error(err);
    throw new Error("Error cargando datos");
  }
}

// === RENDER DASHBOARD ===
function renderDashboard(){
  let html='<div class="dashboard">';
  html+=`<div class="card"><i class="fa-solid fa-store"></i><h3>Tiendas</h3><p>${dataStore.tienda.length}</p></div>`;
  html+=`<div class="card"><i class="fa-solid fa-tags"></i><h3>Categorías</h3><p>${dataStore.categoria.length}</p></div>`;
  html+=`<div class="card"><i class="fa-solid fa-boxes-stacked"></i><h3>Inventario</h3><p>${dataStore.inventario.length}</p></div>`;
  html+='</div>';
  document.getElementById('content').innerHTML=html;
}

// === RENDER TABLE ===
function renderTable(sheet){
  if(sheet==='dashboard'){
    currentSheet=sheet;
    document.getElementById('main-title').textContent="Dashboard";
    renderDashboard();
    return;
  }
  fetchSheet(sheet).then(data=>{
    currentSheet=sheet;
    document.getElementById('main-title').textContent=sheet.charAt(0).toUpperCase()+sheet.slice(1);

    let html='<div class="search-bar"><input type="text" placeholder="Buscar..." oninput="filterTable(this.value)"></div>';
    if(data.length>0){
      html+='<table><thead><tr>';
      Object.keys(data[0]).forEach(h=> html+=`<th>${h}</th>`);
      html+='<th>Acciones</th></tr></thead><tbody>';
      data.forEach((r,i)=>{
        html+='<tr>';
        Object.values(r).forEach(v=> html+=`<td>${v}</td>`);
        html+=`<td class="actions">
          <button class="btn-edit" onclick="editItem(${i})"><i class="fa-solid fa-pen"></i></button>
          <button class="btn-del" onclick="deleteItem(${i})"><i class="fa-solid fa-trash"></i></button>
        </td>`;
        html+='</tr>';
      });
      html+='</tbody></table>';
    }else html+='<table><tr><td colspan="100%">No hay datos</td></tr></table>';
    document.getElementById('content').innerHTML=html;
  }).catch(err=>{
    document.getElementById('content').innerHTML=`<p style="color:red;">${err}</p>`;
  });
}

// === FILTER TABLE ===
function filterTable(query){
  query=query.toLowerCase();
  const rows=document.querySelectorAll("tbody tr");
  rows.forEach(r=>{
    const show=[...r.children].some(td=>td.textContent.toLowerCase().includes(query));
    r.style.display=show?"":"none";
  });
}

// === MODAL ===
function openModal(edit=false){
  document.getElementById("modal").style.display="flex";
  document.getElementById("modal-title").textContent=edit?"Editar":"Agregar";
  const fieldsDiv=document.getElementById("form-fields");
  fieldsDiv.innerHTML="";
  const sample=dataStore[currentSheet][0]||{};
  Object.keys(sample).forEach(k=>{
    fieldsDiv.innerHTML+=`<div><label>${k}</label><input name="${k}" required></div>`;
  });
}
function closeModal(){document.getElementById("modal").style.display="none";}

// === EDIT ITEM ===
function editItem(i){
  editIndex=i;
  openModal(true);
  const record=dataStore[currentSheet][i];
  Object.entries(record).forEach(([k,v])=>{
    const input=document.querySelector(`[name="${k}"]`);
    if(input) input.value=v;
  });
}

// === DELETE ITEM ===
function deleteItem(i){
  if(!confirm("¿Eliminar este registro?")) return;
  const id=dataStore[currentSheet][i].id;
  fetch(scriptURL,{
    method:"POST",
    body:JSON.stringify({sheet:currentSheet,action:"delete",id})
  }).then(r=>r.json()).then(res=>{
    if(res.success) renderTable(currentSheet);
    else alert(res.msg);
  });
}

// === FORM SUBMIT ===
document.getElementById("form").addEventListener("submit",e=>{
  e.preventDefault();
  const formData=Object.fromEntries(new FormData(e.target).entries());
  const action=editIndex>-1?"update":"insert";
  if(editIndex>-1) formData.id=dataStore[currentSheet][editIndex].id;
  fetch(scriptURL,{
    method:"POST",
    body:JSON.stringify({sheet:currentSheet,action,data:formData})
  }).then(r=>r.json()).then(res=>{
    if(res.success){
      closeModal();
      renderTable(currentSheet);
    }else alert(res.msg);
  });
});

// === INIT ===
Promise.all([
  fetchSheet('tienda'),
  fetchSheet('categoria'),
  fetchSheet('inventario')
]).then(()=>{
  renderTable('dashboard');
});
</script>
</body>
</html>
