<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body,html{margin:0;padding:0;font-family:'Segoe UI',sans-serif;background:#f4f6f9;color:#333;height:100%;}
#app{display:flex;height:100vh;overflow:hidden;}
#sidebar{width:260px;background:#111827;color:#fff;transition:width .3s;overflow-y:auto;}
#sidebar.collapsed{width:70px;}
#sidebar .logo{display:flex;align-items:center;justify-content:center;height:70px;font-size:20px;font-weight:bold;background:#1f2937;}
#sidebar ul{list-style:none;padding:0;margin:0;}
#sidebar li{border-bottom:1px solid rgba(255,255,255,0.05);}
#sidebar li button{width:100%;background:none;border:none;color:#fff;text-align:left;padding:15px;font-size:15px;cursor:pointer;display:flex;align-items:center;gap:10px;}
#sidebar li button:hover{background:#374151;}
#toggleSidebar{position:absolute;top:20px;right:-15px;background:#1f2937;border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;}
.accordion{background:#1f2937;cursor:pointer;padding:15px;width:100%;border:none;text-align:left;outline:none;color:#fff;font-size:15px;transition:0.4s;}
.accordion.active,.accordion:hover{background:#374151;}
.panel{padding:0;background:#111827;max-height:0;overflow:hidden;transition:max-height 0.3s ease-out;}
.panel button{padding-left:30px;}
#main{flex:1;display:flex;flex-direction:column;overflow-y:auto;}
header{background:#fff;padding:15px 25px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
header h1{margin:0;font-size:22px;}
#content{padding:20px;overflow:auto;}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:20px;}
.card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);transition:transform .2s;}
.card:hover{transform:translateY(-3px);}
.search-bar{margin-bottom:15px;display:flex;justify-content:flex-end;}
.search-bar input{padding:8px 12px;width:200px;border:1px solid #ccc;border-radius:8px;}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.05);}
th,td{padding:12px;text-align:left;border-bottom:1px solid #eee;}
th{background:#f9fafb;}
tr:hover{background:#f1f5f9;}
.actions{display:flex;gap:10px;}
button{cursor:pointer;border:none;}
.btn-add{background:#2563eb;color:#fff;padding:10px 16px;border-radius:8px;font-size:14px;}
.btn-add:hover{background:#1e40af;}
.btn-edit{background:#10b981;color:#fff;padding:6px 10px;border-radius:6px;}
.btn-del{background:#ef4444;color:#fff;padding:6px 10px;border-radius:6px;}
/* Modal */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;}
.modal-content{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:400px;}
.modal-content h2{margin-top:0;}
.modal-content input,.modal-content select{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:8px;}
.modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:15px;}
</style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="logo">3A Tiendas</div>
    <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
    <ul>
      <li><button onclick="renderTable('inventario')"><i class="fa-solid fa-box"></i>Inventario</button></li>
      <li>
        <button class="accordion"><i class="fa-solid fa-tags"></i>Catálogos</button>
        <div class="panel">
          <button onclick="renderTable('categoria')">Categorías</button>
          <button onclick="renderTable('tienda')">Tiendas</button>
        </div>
      </li>
    </ul>
  </div>
  <div id="main">
    <header>
      <h1 id="main-title">Dashboard</h1>
      <button class="btn-add" onclick="openAddForm(currentSheet)">+ Agregar</button>
    </header>
    <div id="content">
      <div id="dashboard-cards" class="dashboard"></div>
    </div>
  </div>
</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <h2 id="modal-title"></h2>
    <div id="modal-form"></div>
    <div class="modal-actions">
      <button class="btn-add" onclick="saveItem()">Guardar</button>
      <button class="btn-del" onclick="closeModal()">Cancelar</button>
    </div>
  </div>
</div>

<script>
const APP_SCRIPT_URL='https://script.google.com/macros/s/AKfycbxZYvau-tS7jCLqsNmwUkxK4wfkcL2AveUVJGUNKw2nPhFsMPt4Yw0dh-PYjsieW2j9HA/exec';
let dataStore={inventario:[],categoria:[],tienda:[]};
let currentSheet='',editingIndex=null;

document.getElementById('toggleSidebar').addEventListener('click',()=>{document.getElementById('sidebar').classList.toggle('collapsed');});
document.querySelectorAll('.accordion').forEach(acc=>{
  acc.addEventListener('click',function(){
    this.classList.toggle('active');
    let panel=this.nextElementSibling;
    panel.style.maxHeight=panel.style.maxHeight?null:panel.scrollHeight+'px';
  });
});

function fetchSheet(sheet){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).substring(2,15);
    window[cb]=res=>{
      if(res.success){dataStore[sheet]=res.data;resolve(res.data);}else reject(res.msg);
      delete window[cb];
    };
    const s=document.createElement('script');
    s.src=`${APP_SCRIPT_URL}?sheet=${sheet}&callback=${cb}`;
    s.onerror=()=>reject('Error cargando datos');
    document.body.appendChild(s);
  });
}

function renderTable(sheet){
  currentSheet=sheet;
  document.getElementById('main-title').textContent=sheet.charAt(0).toUpperCase()+sheet.slice(1);
  const data=dataStore[sheet];
  let html=`<div class="search-bar"><input type="text" placeholder="Buscar..." oninput="filterTable(this.value)"></div>`;
  if(data.length>0){
    html+=`<table><thead><tr>`;
    Object.keys(data[0]).forEach(h=>{if(h.toLowerCase()!=='id')html+=`<th>${h}</th>`;});
    html+=`<th>Acciones</th></tr></thead><tbody>`;
    data.forEach((r,i)=>{
      html+=`<tr>`;
      Object.entries(r).forEach(([k,v])=>{if(k.toLowerCase()!=='id')html+=`<td>${v}</td>`;});
      html+=`<td class="actions">
      <button class="btn-edit" onclick="editItem(${i})"><i class='fa-solid fa-pen'></i></button>
      <button class="btn-del" onclick="deleteItem(${i})"><i class='fa-solid fa-trash'></i></button>
      </td></tr>`;
    });
    html+=`</tbody></table>`;
  }else html+=`<table><tr><td colspan='100%'>No hay datos</td></tr></table>`;
  document.getElementById('content').innerHTML=html;
}

function filterTable(v){
  const tb=document.querySelector('tbody');
  if(!tb)return;
  Array.from(tb.rows).forEach(r=>{
    r.style.display=Array.from(r.cells).some(c=>c.textContent.toLowerCase().includes(v.toLowerCase()))?'':'none';
  });
}

function openAddForm(sheet,i=null){
  currentSheet=sheet;editingIndex=i;
  document.getElementById('modal-title').textContent=i!==null?'Editar '+sheet:'Agregar '+sheet;
  let html='';
  if(sheet==='categoria'){
    const item=i!==null?dataStore.categoria[i]:{};
    html=`<input type='text' id='nombre' placeholder='Nombre de Categoria' value='${item.nombre||''}'>`;
  }
  else if(sheet==='tienda'){
    const item=i!==null?dataStore.tienda[i]:{};
    html=`
      <input type='text' id='codigo' placeholder='Código' value='${item.codigo||''}'>
      <input type='text' id='nombre' placeholder='Nombre de Tienda' value='${item.nombre||''}'>
    `;
  }
  document.getElementById('modal-form').innerHTML=html;
  document.getElementById('modal').style.display='flex';
}
function closeModal(){document.getElementById('modal').style.display='none';}

function saveItem(){
  const form={};
  document.querySelectorAll('#modal-form input').forEach(el=>form[el.id]=el.value.trim());

  if(currentSheet==='tienda'){
    if(!form.codigo){alert('El código es obligatorio');return;}
    if(!form.nombre){alert('El nombre es obligatorio');return;}
    const dup=dataStore.tienda.some((t,idx)=>t.codigo===form.codigo&&idx!==editingIndex);
    if(dup){alert('El código ya existe');return;}
  }
  if(currentSheet==='categoria'&&!form.nombre){alert('El nombre es obligatorio');return;}

  form.id=editingIndex!==null?dataStore[currentSheet][editingIndex].id:dataStore[currentSheet].length+1;

  if(editingIndex!==null)dataStore[currentSheet][editingIndex]={...dataStore[currentSheet][editingIndex],...form};
  else dataStore[currentSheet].push(form);

  closeModal();renderTable(currentSheet);

  const payload={...form,sheet:currentSheet,action:editingIndex!==null?'update':'add'};
  fetch(APP_SCRIPT_URL,{method:'POST',body:new URLSearchParams(payload)})
  .then(r=>r.json()).then(res=>{if(!res.success)alert('Error: '+res.msg);})
  .catch(e=>console.log('Error',e));
}

function editItem(i){openAddForm(currentSheet,i);}

function deleteItem(i){
  if(currentSheet!=='categoria'&&currentSheet!=='tienda')return;
  if(confirm('¿Eliminar este registro?')){
    const oldId=dataStore[currentSheet][i].id;
    dataStore[currentSheet].splice(i,1);
    dataStore[currentSheet].forEach((item,idx)=>item.id=idx+1);
    renderTable(currentSheet);
    fetch(APP_SCRIPT_URL,{method:'POST',body:new URLSearchParams({sheet:currentSheet,action:'delete',idValue:oldId})})
    .then(r=>r.json()).then(res=>{
      if(res.success)console.log('Eliminado y reestructurado');
    });
  }
}

Promise.all(['inventario','categoria','tienda'].map(fetchSheet))
.then(()=>renderTable('inventario'))
.catch(err=>console.error('Error inicial:',err));
</script>
</body>
</html>
