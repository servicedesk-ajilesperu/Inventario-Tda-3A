<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body{margin:0;font-family:Arial;background:#f4f4f9;color:#333;}
.sidebar{width:220px;background:#222;height:100vh;position:fixed;top:0;left:0;overflow:auto;}
.sidebar h2{color:#fff;text-align:center;padding:15px 0;margin:0;}
.sidebar button.accordion{background:#222;color:#fff;cursor:pointer;padding:15px;width:100%;border:none;text-align:left;outline:none;font-size:16px;transition:0.4s;}
.sidebar button.accordion.active,.sidebar button.accordion:hover{background:#444;}
.sidebar .panel{padding:0;background:#333;max-height:0;overflow:hidden;transition:max-height 0.2s ease-out;}
.sidebar .panel a{padding:12px;display:block;color:#ddd;text-decoration:none;}
.sidebar .panel a:hover{background:#575757;}
.content{margin-left:230px;padding:20px;}
h1{color:#222;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
table,th,td{border:1px solid #ccc;}
th,td{padding:8px;text-align:left;}
.btn{padding:5px 10px;cursor:pointer;border:none;border-radius:5px;}
.btn-add{background:#28a745;color:#fff;}
.btn-edit{background:#007bff;color:#fff;}
.btn-del{background:#dc3545;color:#fff;}
</style>
</head>
<body>

<div class="sidebar">
  <h2>Menú</h2>
  <button class="accordion">Dashboard</button>
  <div class="panel">
    <a href="#" onclick="nav('dashboard')">Inicio</a>
  </div>
  <button class="accordion">Inventario</button>
  <div class="panel">
    <a href="#" onclick="nav('inventario')">Ver Inventario</a>
  </div>
  <button class="accordion">Categorías</button>
  <div class="panel">
    <a href="#" onclick="nav('categoria')">Gestión Categorías</a>
  </div>
  <button class="accordion">Tiendas</button>
  <div class="panel">
    <a href="#" onclick="nav('tienda')">Gestión Tiendas</a>
  </div>
</div>

<div class="content" id="content"></div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";

let data = {inventario:[], categoria:[], tienda:[]};
let currentView = "dashboard";

// ===== Menú acordeón =====
document.querySelectorAll(".accordion").forEach(btn=>{
  btn.addEventListener("click",function(){
    document.querySelectorAll(".accordion").forEach(b=>{
      if(b!==this){
        b.classList.remove("active");
        b.nextElementSibling.style.maxHeight=null;
      }
    });
    this.classList.toggle("active");
    let panel=this.nextElementSibling;
    panel.style.maxHeight=panel.style.maxHeight?null:panel.scrollHeight+"px";
  });
});

// ===== Fetch inicial desde Sheets =====
async function loadInitialData(){
  let res = await fetch(apiUrl+"?action=getAll");
  let json = await res.json();
  data.inventario=json.inventario||[];
  data.categoria=json.categorias||[];
  data.tienda=json.tiendas||[];
  render();
}

// ===== Render =====
function render(){
  let c=document.getElementById("content");
  c.innerHTML="";
  if(currentView==="dashboard"){
    c.innerHTML="<h1>Dashboard</h1><p>Total Inventario: "+data.inventario.length+"</p>";
  }
  if(currentView==="inventario"){renderTable("inventario");}
  if(currentView==="categoria"){renderTable("categoria");}
  if(currentView==="tienda"){renderTable("tienda");}
}

function renderTable(tipo){
  let c=document.getElementById("content");
  let title = tipo==="inventario"?"Inventario":tipo==="categoria"?"Categorías":"Tiendas";
  let btn = `<button class="btn btn-add" onclick="addItem('${tipo}')">Agregar ${title}</button>`;
  c.innerHTML="<h1>"+title+"</h1>"+btn;
  let tbl=document.createElement("table");
  let thead=document.createElement("thead");
  let tr=document.createElement("tr");
  let cols=[];
  if(tipo==="inventario") cols=["id","Codigo","Serie","Equipo","Marca","Modelo","Categoria","Tienda","Acciones"];
  if(tipo==="categoria") cols=["id","nombre","Acciones"];
  if(tipo==="tienda") cols=["id","nombre","Acciones"];
  cols.forEach(col=>{let th=document.createElement("th");th.textContent=col;tr.appendChild(th);});
  thead.appendChild(tr);tbl.appendChild(thead);
  let tb=document.createElement("tbody");
  data[tipo].forEach((row,idx)=>{
    let tr=document.createElement("tr");
    if(tipo==="inventario"){
      tr.innerHTML=`<td>${row.idSheet||""}</td><td>${row.Codigo||""}</td><td>${row.Serie||""}</td>
      <td>${row.Equipo||""}</td><td>${row.Marca||""}</td><td>${row.Modelo||""}</td>
      <td>${row.Categoria||""}</td><td>${row.Tienda||""}</td>
      <td>
        <button class="btn btn-edit" onclick="editItem('${tipo}',${idx})">Editar</button>
        <button class="btn btn-del" onclick="deleteItem('${tipo}',${idx})">Eliminar</button>
      </td>`;
    } else {
      tr.innerHTML=`<td>${row.idSheet||""}</td><td>${row.nombre||""}</td>
      <td>
        <button class="btn btn-edit" onclick="editItem('${tipo}',${idx})">Editar</button>
        <button class="btn btn-del" onclick="deleteItem('${tipo}',${idx})">Eliminar</button>
      </td>`;
    }
    tb.appendChild(tr);
  });
  tbl.appendChild(tb);c.appendChild(tbl);
}

// ===== CRUD =====
function addItem(tipo){
  let item={};
  if(tipo==="inventario"){
    item={Codigo:prompt("Código"),Serie:prompt("Serie"),Equipo:prompt("Equipo"),
      Marca:prompt("Marca"),Modelo:prompt("Modelo"),Categoria:prompt("Categoria"),Tienda:prompt("Tienda")};
  } else {
    item={nombre:prompt("Nombre")};
  }
  data[tipo].push(item);
  syncItem(tipo,item);
  render();
}

function editItem(tipo,idx){
  let item=data[tipo][idx];
  if(tipo==="inventario"){
    item.Codigo=prompt("Código",item.Codigo);
    item.Serie=prompt("Serie",item.Serie);
    item.Equipo=prompt("Equipo",item.Equipo);
    item.Marca=prompt("Marca",item.Marca);
    item.Modelo=prompt("Modelo",item.Modelo);
    item.Categoria=prompt("Categoria",item.Categoria);
    item.Tienda=prompt("Tienda",item.Tienda);
  } else {
    item.nombre=prompt("Nombre",item.nombre);
  }
  syncItem(tipo,item);
  render();
}

function deleteItem(tipo,idx){
  let item=data[tipo][idx];
  data[tipo].splice(idx,1);
  if(item.idSheet){
    fetch(apiUrl+"?tipo="+tipo+"&action=delete&id="+item.idSheet);
  }
  render();
}

// ===== Sincronizar =====
function syncItem(tipo,item){
  let action = item.idSheet ? "update" : "add";
  fetch(apiUrl+"?tipo="+tipo+"&action="+action,{
    method:"POST",
    body:JSON.stringify(item)
  })
  .then(r=>r.json())
  .then(res=>{
    if(action==="add" && res.id){
      item.idSheet=res.id; // actualizar ID para evitar duplicados
    }
  });
}

// ===== Navegación =====
function nav(view){currentView=view;render();}

// ===== Start =====
loadInitialData();
</script>
</body>
</html>
