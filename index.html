<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
/* estilos idénticos a los que usas (resumidos para brevedad) */
body, html{margin:0;padding:0;font-family:sans-serif;background:#f7f7f7}
*{box-sizing:border-box}
.sidebar{width:260px;position:fixed;height:100%;background:#ff4d00;color:#fff;display:flex;flex-direction:column;gap:12px;padding:20px;overflow-y:auto;z-index:10}
.sidebar.collapsed{width:60px;padding:20px 5px}
.brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:1.2rem;position:relative;margin-bottom:10px}
#toggleSidebar{position:absolute;right:0;top:0;background:#cc3c00;color:#fff;border:none;border-radius:6px;padding:4px 8px;cursor:pointer}
.menu-section .accordion{background:transparent;color:white;border:none;padding:10px;width:100%;display:flex;align-items:center;gap:10px;cursor:pointer;font-weight:600;justify-content:space-between;border-radius:4px}
.menu-section .accordion.active,.menu-section .accordion:hover{background:#e64500}
.menu-section .panel{padding:0 10px;max-height:0;overflow:hidden;transition:max-height .3s;background:#e64500;display:flex;flex-direction:column;gap:4px}
.menu-section .panel button{background:transparent;color:white;border:none;padding:8px;text-align:left;display:flex;align-items:center;gap:6px;cursor:pointer;width:100%;border-radius:4px}
.menu-section .panel button:hover{background:#cc4000}
.sidebar.collapsed .brand span,.sidebar.collapsed .accordion span,.sidebar.collapsed .panel button span{display:none}
.main{margin-left:260px;padding:20px;transition:.3s}
.sidebar.collapsed~.main{margin-left:60px}
.cards{display:flex;gap:20px;margin-top:20px;flex-wrap:wrap}
.card{flex:1;min-width:150px;background:#fff;color:#ff4d00;padding:20px;border-radius:12px;text-align:center;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,.1);transition:.2s}
.card:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,.15)}
.card span{font-weight:700;font-size:1.3rem;display:block;margin-top:5px}
.search-bar{margin-bottom:15px;display:flex;gap:10px}
.search-bar input{flex-grow:1;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:1rem}
table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,.05);display:block;overflow-x:auto;white-space:nowrap}
th,td{border:1px solid #eee;padding:10px;text-align:center;font-size:.9rem}
th{background:#ff4d00;color:#fff;font-weight:600}
tr:nth-child(even){background:#f9f9f9}
.actions button{margin:0 2px;padding:6px;border-radius:50%;border:none;cursor:pointer;width:32px;height:32px;transition:.1s}
.btn-edit{background:#ffb86b;color:#fff}
.btn-del{background:#d9534f;color:#fff}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#fff;padding:25px;border-radius:12px;width:450px;max-width:95%;box-shadow:0 10px 20px rgba(0,0,0,.2)}
input,select{padding:10px;border-radius:6px;border:1px solid #ccc;width:100%;margin-bottom:12px;font-size:1rem}
.modal button{padding:8px 15px;border-radius:6px;cursor:pointer;border:none;font-weight:600}
.modal button:last-child{background:#ff4d00;color:#fff}
.modal button:first-child{background:#eee;color:#333;margin-right:10px}
@media(max-width:768px){.cards{flex-direction:column}.card{min-width:100%}.sidebar{left:-260px}.sidebar.collapsed{left:0}.main{margin-left:0;padding:10px}}
</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="brand"><i class="fa-solid fa-boxes-stacked"></i><span>Inventario 3A</span>
    <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
  </div>

  <div class="menu-section">
    <button class="accordion active"><i class="fa-solid fa-house"></i><span>Dashboard</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel" style="max-height:500px;"><button onclick="renderDashboard()"><i class="fa-solid fa-gauge-high"></i><span>Ver Dashboard</span></button></div>
  </div>

  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-computer"></i><span>Inventario</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('inventario')"><i class="fa-solid fa-plus"></i><span>Agregar Inventario</span></button>
      <button onclick="nav('inventario')"><i class="fa-solid fa-table"></i><span>Ver Inventario</span></button>
    </div>
  </div>

  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-tags"></i><span>Categorías</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('categoria')"><i class="fa-solid fa-plus"></i><span>Agregar Categoría</span></button>
      <button onclick="nav('categoria')"><i class="fa-solid fa-table"></i><span>Ver Categorías</span></button>
    </div>
  </div>

  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-store"></i><span>Tiendas</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('tienda')"><i class="fa-solid fa-plus"></i><span>Agregar Tienda</span></button>
      <button onclick="nav('tienda')"><i class="fa-solid fa-table"></i><span>Ver Tiendas</span></button>
    </div>
  </div>
</aside>

<div class="main">
  <h2 id="main-title">Dashboard</h2>
  <div class="cards" id="dashboard-cards"></div>
  <div id="content"></div>
</div>

<div class="modal-backdrop" id="modal"><div class="modal">
  <h3 id="modal-title"></h3>
  <div id="modal-form"></div>
  <div style="text-align:right;margin-top:15px">
    <button onclick="closeModal()">Cancelar</button>
    <button onclick="saveItem()">Guardar</button>
  </div>
</div></div>

<script>
const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxZYvau-tS7jCLqsNmwUkxK4wfkcL2AveUVJGUNKw2nPhFsMPt4Yw0dh-PYjsieW2j9HA/exec';
let dataStore = { inventario:[], categoria:[], tienda:[] };
let currentSheet = '';
let editingIndex = null;

/* SIDEBAR */
document.getElementById('toggleSidebar').addEventListener('click',()=>document.getElementById('sidebar').classList.toggle('collapsed'));
document.querySelectorAll('.accordion').forEach(acc=>acc.addEventListener('click',function(){ this.classList.toggle('active'); let panel=this.nextElementSibling; panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight+'px'; }));

/* JSONP fetch helper (usa el mismo endpoint que tu Apps Script) */
function fetchSheet(sheet){
  return new Promise((resolve,reject)=>{
    const cb = 'cb_'+Math.random().toString(36).slice(2);
    window[cb] = function(res){
      delete window[cb];
      if(res && res.success) { dataStore[sheet]=res.data; resolve(res.data); }
      else reject((res && res.msg) || 'Error al obtener datos');
    };
    const s = document.createElement('script');
    s.src = `${APP_SCRIPT_URL}?sheet=${sheet}&callback=${cb}`;
    s.onerror = ()=>{ delete window[cb]; reject('Error cargando datos'); };
    document.body.appendChild(s);
  });
}

/* RENDER TABLE */
function renderTable(sheet){
  currentSheet = sheet;
  document.getElementById('main-title').textContent = sheet.charAt(0).toUpperCase() + sheet.slice(1);
  document.getElementById('dashboard-cards').innerHTML = '';
  const data = dataStore[sheet] || [];
  let html = `<div class="search-bar"><input type="text" placeholder="Buscar..." oninput="filterTable(this.value)"></div>`;

  if(data.length>0){
    html += `<table><thead><tr>`;
    Object.keys(data[0]).forEach(h=>{ if(h.toLowerCase()!=='id') html += `<th>${h}</th>`; });
    html += `<th>Acciones</th></tr></thead><tbody>`;
    data.forEach((r,i)=>{
      html += `<tr>`;
      Object.entries(r).forEach(([k,v])=>{ if(k.toLowerCase()!=='id') html += `<td>${v||''}</td>`; });
      html += `<td class="actions">
        <button class="btn-edit" onclick="editItem(${i})"><i class="fa-solid fa-pen"></i></button>
        <button class="btn-del" onclick="deleteItem(${i})"><i class="fa-solid fa-trash"></i></button>
      </td></tr>`;
    });
    html += `</tbody></table>`;
  } else {
    html += `<table><tr><td colspan="100%">No hay datos</td></tr></table>`;
  }
  document.getElementById('content').innerHTML = html;
}

/* FILTER */
function filterTable(value){
  const tbody = document.querySelector('tbody');
  if(!tbody) return;
  Array.from(tbody.rows).forEach(r => r.style.display = Array.from(r.cells).some(c => c.textContent.toLowerCase().includes(value.toLowerCase())) ? '' : 'none');
}

/* MODAL FORM */
function openAddForm(sheet,index=null){
  currentSheet = sheet;
  editingIndex = index;
  document.getElementById('modal-title').textContent = index!==null ? 'Editar '+sheet : 'Agregar '+sheet;
  let html = '';

  if(sheet==='categoria'){
    const item = index!==null ? dataStore.categoria[index] : {};
    html = `<input type="text" id="nombre" placeholder="Nombre de Categoría" value="${item.nombre||''}">`;
  } else if(sheet==='tienda'){
    const item = index!==null ? dataStore.tienda[index] : {};
    html = `<input type="text" id="codigo" placeholder="Código" value="${item.codigo||''}">
            <input type="text" id="nombre" placeholder="Nombre de Tienda" value="${item.nombre||''}">`;
  } else if(sheet==='inventario'){
    const item = index!==null ? dataStore.inventario[index] : {};
    html = `<input type="text" id="codigo" placeholder="Código (opcional)" value="${item.codigo||''}">
            <input type="text" id="serie" placeholder="Serie" value="${item.serie||''}">
            <input type="text" id="equipo" placeholder="Equipo" value="${item.equipo||''}">
            <input type="text" id="marca" placeholder="Marca" value="${item.marca||''}">
            <input type="text" id="modelo" placeholder="Modelo" value="${item.modelo||''}">`;
    html += `<select id="categoria"><option value="">Selecciona Categoría</option>`;
    dataStore.categoria.forEach(c => html += `<option value="${c.nombre}" ${item.categoria===c.nombre ? 'selected' : ''}>${c.nombre}</option>`);
    html += `</select>`;
    html += `<select id="tienda"><option value="">Selecciona Tienda</option>`;
    dataStore.tienda.forEach(t => html += `<option value="${t.nombre}" ${item.tienda===t.nombre ? 'selected' : ''}>${t.nombre}</option>`);
    html += `</select>`;
  }

  document.getElementById('modal-form').innerHTML = html;
  document.getElementById('modal').style.display = 'flex';
}
function closeModal(){ document.getElementById('modal').style.display = 'none'; }

/* SAVE (add/update) */
function saveItem(){
  const form = {};
  document.querySelectorAll('#modal-form input,#modal-form select').forEach(el => form[el.id] = el.value.trim());

  // validaciones
  if(currentSheet === 'tienda'){
    if(!form.codigo || !form.nombre){ alert('Código y Nombre son obligatorios'); return; }
    if(dataStore.tienda.some((t,i)=> i!==editingIndex && t.codigo === form.codigo)){ alert('Código repetido en Tienda'); return; }
  }

  if(currentSheet === 'inventario' && form.codigo){
    if(dataStore.inventario.some((t,i)=> i!==editingIndex && t.codigo === form.codigo)){ alert('Código repetido en Inventario'); return; }
  }

  // id correlativo local
  if(editingIndex === null) form.id = dataStore[currentSheet].length>0 ? Math.max(...dataStore[currentSheet].map(d=>Number(d.id)))+1 : 1;
  else form.id = dataStore[currentSheet][editingIndex].id;

  if(editingIndex !== null) dataStore[currentSheet][editingIndex] = {...dataStore[currentSheet][editingIndex], ...form};
  else dataStore[currentSheet].push(form);

  closeModal();
  renderTable(currentSheet);

  // armar payload con nombres que espera tu Apps Script
  let payload = { sheet: currentSheet, action: editingIndex!==null ? 'update' : 'add', idValue: form.id, id: form.id };

  if(currentSheet === 'inventario'){
    payload.Codigo = form.codigo || '';
    payload.Serie  = form.serie || '';
    payload.Equipo = form.equipo || '';
    payload.Marca  = form.marca || '';
    payload.Modelo = form.modelo || '';
    payload.Categoria = form.categoria || '';
    payload.Tienda = form.tienda || '';
  } else if(currentSheet === 'tienda'){
    payload.codigo = form.codigo || '';
    payload.nombre = form.nombre || '';
  } else if(currentSheet === 'categoria'){
    payload.nombre = form.nombre || '';
  }

  fetch(APP_SCRIPT_URL, { method:'POST', body:new URLSearchParams(payload) })
    .then(r => r.json())
    .then(res => { if(!res.success) alert('Error sincronizando App Web: '+res.msg); })
    .catch(e => console.error('Error sincronizando:', e));
}

/* EDIT */
function editItem(i){ openAddForm(currentSheet, i); }

/* DELETE + RESTRUCTURE */
function deleteItem(i){
  if(!confirm('¿Seguro que deseas eliminar este registro?')) return;

  // obtener id antes de eliminar
  const item = dataStore[currentSheet][i];
  if(!item){ alert('Registro no encontrado'); return; }
  const oldId = item.id;

  // eliminar local y reestructurar ids locales
  dataStore[currentSheet].splice(i,1);
  dataStore[currentSheet].forEach((it, idx) => it.id = idx + 1);
  renderTable(currentSheet);

  // 1) eliminar en App Web
  fetch(APP_SCRIPT_URL, { method:'POST', body: new URLSearchParams({ sheet: currentSheet, action:'delete', idValue: oldId }) })
    .then(r => r.json())
    .then(res => {
      if(!res.success){
        alert('Error eliminando en App Web: ' + res.msg);
        return;
      }
      // 2) obtener hoja actualizada desde App Script (JSONP) y reestructurar ids en App Web
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      window[cb] = function(json){
        try{
          delete window[cb];
          if(!json || !json.success){ console.error('No se pudo obtener la hoja para reestructurar'); return; }
          const remoteData = json.data || [];
          // por cada fila remota, verificar si el id coincide con el correlativo; si no, enviar update
          remoteData.forEach((row, idx) => {
            const expectedId = idx + 1;
            const remoteId = Number(row.id);
            if(remoteId !== expectedId){
              // armar payload de update usando los nombres que tu Apps Script espera
              const updatePayload = new URLSearchParams();
              updatePayload.append('sheet', currentSheet);
              updatePayload.append('action', 'update');
              updatePayload.append('idValue', row.id);
              updatePayload.append('id', expectedId);

              if(currentSheet === 'inventario'){
                updatePayload.append('Codigo', row.Codigo || '');
                updatePayload.append('Serie', row.Serie || '');
                updatePayload.append('Equipo', row.Equipo || '');
                updatePayload.append('Marca', row.Marca || '');
                updatePayload.append('Modelo', row.Modelo || '');
                updatePayload.append('Categoria', row.Categoria || '');
                updatePayload.append('Tienda', row.Tienda || '');
              } else if(currentSheet === 'tienda'){
                updatePayload.append('codigo', row.codigo || '');
                updatePayload.append('nombre', row.nombre || '');
              } else if(currentSheet === 'categoria'){
                updatePayload.append('nombre', row.nombre || '');
              }

              // enviar actualización para cambiar el id y (re)escribir fila
              fetch(APP_SCRIPT_URL, { method:'POST', body: updatePayload })
                .then(rr => rr.json())
                .then(res2 => {
                  if(!res2.success) console.warn('No se pudo actualizar fila remota id', row.id, res2.msg);
                })
                .catch(err => console.error('Error actualizando fila remota:', err));
            }
          });
        }catch(e){
          console.error('Error en callback JSONP:', e);
        }
      };
      // inyectar script para obtener hoja actualizada
      const s = document.createElement('script');
      s.src = `${APP_SCRIPT_URL}?sheet=${currentSheet}&callback=${cb}`;
      s.onerror = ()=>{ delete window[cb]; console.error('Error cargando hoja remota para reestructurar'); };
      document.body.appendChild(s);
    })
    .catch(e => {
      console.error('Error eliminando en App Web:', e);
      alert('Error eliminando en App Web: ' + (e.message || e));
    });
}

/* DASHBOARD & NAV */
function renderDashboard(){
  const cards = document.getElementById('dashboard-cards');
  cards.innerHTML = `
    <div class="card" onclick="nav('inventario')"><i class="fa-solid fa-computer"></i><span>${dataStore.inventario.length}</span>Inventario</div>
    <div class="card" onclick="nav('categoria')"><i class="fa-solid fa-tags"></i><span>${dataStore.categoria.length}</span>Categorías</div>
    <div class="card" onclick="nav('tienda')"><i class="fa-solid fa-store"></i><span>${dataStore.tienda.length}</span>Tiendas</div>
  `;
  document.getElementById('main-title').textContent = 'Dashboard';
  document.getElementById('content').innerHTML = '';
}
function nav(sheet){ renderTable(sheet); }

/* INIT: cargar tres hojas */
Promise.all([fetchSheet('inventario'), fetchSheet('categoria'), fetchSheet('tienda')])
  .then(()=> renderDashboard())
  .catch(e => { console.error('Error inicial:', e); alert('Error cargando datos iniciales: '+e); });
</script>
</body>
</html>
