<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
/* === ESTILOS === */
body, html { margin:0; padding:0; font-family:sans-serif; background:#f7f7f7; }
* { box-sizing:border-box; }
/* ... (mantengo exactamente tus estilos, no los repito para ahorrar espacio) ... */
</style>
</head>
<body>
<aside class="sidebar" id="sidebar">
  <div class="brand">
    <i class="fa-solid fa-boxes-stacked"></i><span>Inventario 3A</span>
    <button id="toggleSidebar"><i class="fa-solid fa-bars"></i></button>
  </div>
  <div class="menu-section">
    <button class="accordion active"><i class="fa-solid fa-house"></i><span>Dashboard</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel" style="max-height:500px;">
      <button onclick="nav('dashboard')"><i class="fa-solid fa-gauge-high"></i><span>Ver Dashboard</span></button>
    </div>
  </div>
  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-computer"></i><span>Inventario</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('inventario')"><i class="fa-solid fa-plus"></i><span>Agregar Inventario</span></button>
      <button onclick="nav('inventario')"><i class="fa-solid fa-table"></i><span>Ver Inventario</span></button>
    </div>
  </div>
  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-tags"></i><span>Categorias</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('categoria')"><i class="fa-solid fa-plus"></i><span>Agregar Categoria</span></button>
      <button onclick="nav('categoria')"><i class="fa-solid fa-table"></i><span>Ver Categorias</span></button>
    </div>
  </div>
  <div class="menu-section">
    <button class="accordion"><i class="fa-solid fa-store"></i><span>Tiendas</span><i class="fa-solid fa-chevron-down"></i></button>
    <div class="panel">
      <button onclick="openAddForm('tienda')"><i class="fa-solid fa-plus"></i><span>Agregar Tienda</span></button>
      <button onclick="nav('tienda')"><i class="fa-solid fa-table"></i><span>Ver Tiendas</span></button>
    </div>
  </div>
</aside>

<div class="main">
  <h2 id="main-title">Dashboard</h2>
  <div class="cards" id="dashboard-cards"></div>
  <div id="content"></div>
</div>

<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h3 id="modal-title"></h3>
    <div id="modal-form"></div>
    <div style="text-align:right; margin-top:15px;">
      <button onclick="closeModal()">Cancelar</button>
      <button onclick="saveItem()">Guardar</button>
    </div>
  </div>
</div>

<script>
const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxZYvau-tS7jCLqsNmwUkxK4wfkcL2AveUVJGUNKw2nPhFsMPt4Yw0dh-PYjsieW2j9HA/exec';
let dataStore = { inventario:[], categoria:[], tienda:[] };
let currentSheet = '';
let editingIndex = null;

// SIDEBAR
document.getElementById('toggleSidebar').addEventListener('click',()=>{
  document.getElementById('sidebar').classList.toggle('collapsed');
});
document.querySelectorAll('.accordion').forEach(acc=>{
  acc.addEventListener('click', function(){
    this.classList.toggle('active');
    let panel = this.nextElementSibling;
    panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight+'px';
  });
});

// FETCH JSONP
function fetchSheet(sheet){
  return new Promise((resolve,reject)=>{
    const cb = 'cb_'+Math.random().toString(36).substring(2,15);
    window[cb] = function(res){
      if(res.success){
        dataStore[sheet]=res.data;
        resolve(res.data);
      } else reject(res.msg);
      delete window[cb];
    };
    const s = document.createElement('script');
    s.src = `${APP_SCRIPT_URL}?sheet=${sheet}&callback=${cb}`;
    s.onerror = ()=>reject('Error cargando datos');
    document.body.appendChild(s);
  });
}

// RENDER TABLE
function renderTable(sheet){
  fetchSheet(sheet).then(data=>{
    currentSheet = sheet;
    document.getElementById('main-title').textContent = sheet.charAt(0).toUpperCase()+sheet.slice(1);

    if(sheet==='dashboard'){ renderDashboard(); return; }

    let html = `<div class="search-bar"><input type="text" placeholder="Buscar..." oninput="filterTable(this.value)"></div>`;
    if(data.length>0){
      html += `<table><thead><tr>`;
      Object.keys(data[0]).forEach(h=> html+=`<th>${h}</th>`);
      html += `<th>Acciones</th></tr></thead><tbody>`;
      data.forEach((r,i)=>{
        html+=`<tr>`;
        Object.values(r).forEach(v=> html+=`<td>${v}</td>`);
        html+=`<td class="actions">
          <button class="btn-edit" onclick="editItem(${i})"><i class="fa-solid fa-pen"></i></button>
          <button class="btn-del" onclick="deleteItem(${i})"><i class="fa-solid fa-trash"></i></button>
        </td>`;
        html+=`</tr>`;
      });
      html+=`</tbody></table>`;
    } else {
      html+=`<table><tr><td colspan="100%">No hay datos</td></tr></table>`;
    }
    document.getElementById('content').innerHTML = html;
  }).catch(err=>{
    document.getElementById('content').innerHTML = `<p style="color:red;">${err}</p>`;
  });
}

// FILTRO
function filterTable(value){
  const tbody = document.querySelector('tbody');
  if(!tbody) return;
  Array.from(tbody.rows).forEach(r=>
    r.style.display=Array.from(r.cells).some(c=>c.textContent.toLowerCase().includes(value.toLowerCase()))?'':'none'
  );
}

// MODAL
function openAddForm(sheet,index=null){
  currentSheet=sheet; editingIndex=index;
  document.getElementById('modal-title').textContent = index!==null?'Editar '+sheet:'Agregar '+sheet;
  let html='';
  if(sheet==='categoria'){
    const item=index!==null?dataStore.categoria[index]:{};
    html=`<input type="text" id="nombre" placeholder="Nombre de Categoria" value="${item.nombre||''}">`;
  } else if(sheet==='tienda'){
    const item=index!==null?dataStore.tienda[index]:{};
    html=`<input type="text" id="codigo" placeholder="Código" value="${item.codigo||''}">
          <input type="text" id="nombre" placeholder="Nombre de Tienda" value="${item.nombre||''}">`;
  } else if(sheet==='inventario'){
    const item=index!==null?dataStore.inventario[index]:{};
    html=`<input type="text" id="nombre" placeholder="Nombre de Item" value="${item.nombre||''}">`;
    html+=`<select id="categoria"><option value="">Selecciona Categoria</option>`;
    dataStore.categoria.forEach(c=>{
      html+=`<option value="${c.codigo||c.id}" ${item.categoria==c.codigo?'selected':''}>${c.nombre}</option>`;
    });
    html+=`</select>`;
    html+=`<select id="tienda"><option value="">Selecciona Tienda</option>`;
    dataStore.tienda.forEach(t=>{
      html+=`<option value="${t.codigo||t.id}" ${item.tienda==t.codigo?'selected':''}>${t.nombre}</option>`;
    });
    html+=`</select>`;
  }
  document.getElementById('modal-form').innerHTML = html;
  document.getElementById('modal').style.display='flex';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }

// SAVE ITEM
function saveItem(){
  const form={};
  document.querySelectorAll('#modal-form input,#modal-form select').forEach(el=> form[el.id]=el.value);
  let action=editingIndex!==null?'update':'add';
  if(editingIndex!==null) form.idValue=currentSheet==='tienda'?form.codigo:dataStore[currentSheet][editingIndex].codigo||dataStore[currentSheet][editingIndex].id;
  fetch(APP_SCRIPT_URL,{ method:'POST', body:new URLSearchParams({sheet:currentSheet,action,...form}) })
    .then(r=>r.json()).then(res=>{
      if(res.success){
        closeModal();
        fetchSheet(currentSheet).then(()=>renderTable(currentSheet));
      } else alert('Error: '+res.msg);
    }).catch(e=>alert('Error al guardar'));
}

// EDIT & DELETE
function editItem(i){ openAddForm(currentSheet,i); }
function deleteItem(i){
  if(confirm('¿Seguro de eliminar?')){
    const id = currentSheet==='tienda'?dataStore[currentSheet][i].codigo:dataStore[currentSheet][i].codigo||dataStore[currentSheet][i].id;
    fetch(APP_SCRIPT_URL,{ method:'POST', body:new URLSearchParams({sheet:currentSheet,action:'delete',idValue:id,codigo:id}) })
      .then(r=>r.json()).then(res=>{
        if(res.success) fetchSheet(currentSheet).then(()=>renderTable(currentSheet));
        else alert('Error: '+res.msg);
      }).catch(e=>alert('Error al eliminar'));
  }
}

// DASHBOARD
function renderDashboard(){
  const cardsDiv=document.getElementById('dashboard-cards');
  cardsDiv.innerHTML='';
  cardsDiv.innerHTML+=`<div class="card"><i class="fa-solid fa-store"></i><span>${dataStore.tienda.length}</span>Tiendas</div>`;
  cardsDiv.innerHTML+=`<div class="card"><i class="fa-solid fa-tags"></i><span>${dataStore.categoria.length}</span>Categorias</div>`;
  cardsDiv.innerHTML+=`<div class="card"><i class="fa-solid fa-computer"></i><span>${dataStore.inventario.length}</span>Inventario</div>`;
  document.getElementById('content').innerHTML='';
}

// NAV
function nav(sheet){ renderTable(sheet); }

// INIT
Promise.all([fetchSheet('tienda'),fetchSheet('categoria'),fetchSheet('inventario')]).then(()=>{
  renderTable('dashboard');
});
</script>
</body>
</html>
