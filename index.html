const SPREADSHEET_ID = 'TU_ID_DE_HOJA'; // Reemplaza con tu ID de Google Sheet

// ------------------------
// GET - DEVUELVE JSON
// ------------------------
function doGet(e){
  const sheetName = e.parameter.sheet;
  if(!sheetName){
    return ContentService
      .createTextOutput(JSON.stringify({ success:false, msg:"Hoja no especificada" }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader("Access-Control-Allow-Origin","*");
  }

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sh = ss.getSheetByName(sheetName);
  if(!sh){
    return ContentService
      .createTextOutput(JSON.stringify({ success:false, msg:"Hoja no encontrada" }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader("Access-Control-Allow-Origin","*");
  }

  const data = sh.getDataRange().getValues();
  const headers = data.shift();
  const jsonData = data.map(row => {
    let obj = {};
    headers.forEach((h,i)=> obj[h] = row[i]);
    return obj;
  });

  return ContentService
    .createTextOutput(JSON.stringify({ success:true, data: jsonData }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin","*");
}

// ------------------------
// POST - ADD / DELETE / UPDATE
// ------------------------
function doPost(e){
  const params = e.parameter;
  const sheetName = params.sheet;
  const action = params.action;
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);

  if(!sheetName || !action){
    return ContentService
      .createTextOutput(JSON.stringify({ success:false, msg:"Faltan parámetros" }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader("Access-Control-Allow-Origin","*");
  }

  if(action==='add') return ContentService.createTextOutput(JSON.stringify(addData(ss,sheetName,params))).setMimeType(ContentService.MimeType.JSON).setHeader("Access-Control-Allow-Origin","*");
  if(action==='delete') return ContentService.createTextOutput(JSON.stringify(deleteData(ss,sheetName,params))).setMimeType(ContentService.MimeType.JSON).setHeader("Access-Control-Allow-Origin","*");
  if(action==='update') return ContentService.createTextOutput(JSON.stringify(updateData(ss,sheetName,params))).setMimeType(ContentService.MimeType.JSON).setHeader("Access-Control-Allow-Origin","*");

  return ContentService
    .createTextOutput(JSON.stringify({ success:false, msg:"Acción no válida" }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin","*");
}

// ------------------------
// ADD
// ------------------------
function addData(ss,sheetName,params){
  const sh = ss.getSheetByName(sheetName);
  if(!sh) return { success:false, msg:"Hoja no encontrada" };
  const headers = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  const newRow = headers.map(h=> params[h] || '');
  sh.appendRow(newRow);
  return { success:true, msg:"Registro agregado" };
}

// ------------------------
// DELETE
// ------------------------
function deleteData(ss,sheetName,params){
  const sh = ss.getSheetByName(sheetName);
  if(!sh) return { success:false, msg:"Hoja no encontrada" };
  const id = params.codigo || params.idValue;
  if(!id) return { success:false, msg:"Código no enviado" };

  const data = sh.getDataRange().getValues();
  for(let i=1;i<data.length;i++){
    if(String(data[i][0])===String(id)){
      sh.deleteRow(i+1);
      return { success:true, msg:"Registro eliminado" };
    }
  }
  return { success:false, msg:"Código no encontrado" };
}

// ------------------------
// UPDATE
// ------------------------
function updateData(ss,sheetName,params){
  const sh = ss.getSheetByName(sheetName);
  if(!sh) return { success:false, msg:"Hoja no encontrada" };
  const idValue = params.idValue;
  if(!idValue) return { success:false, msg:"ID no enviado" };

  const headers = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  const data = sh.getDataRange().getValues();

  for(let i=1;i<data.length;i++){
    if(String(data[i][0])===String(idValue)){
      headers.forEach((h,j)=>{
        if(params[h]!==undefined) sh.getRange(i+1,j+1).setValue(params[h]);
      });
      return { success:true, msg:"Registro actualizado" };
    }
  }
  return { success:false, msg:"ID no encontrado" };
}
