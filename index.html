<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario Tiendas 3A</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
/* ---------- Reset básico ---------- */
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial, sans-serif;}
body{display:flex;min-height:100vh;flex-direction:column;}
a{text-decoration:none;color:inherit;}
button{cursor:pointer;border:none;background:none;}

/* ---------- Sidebar ---------- */
#sidebar{width:250px;background:#ff4d00;color:#fff;transition:width .3s;flex-shrink:0;overflow:hidden;}
#sidebar.collapsed{width:60px;}
#sidebar h2{padding:20px;text-align:center;}
#sidebar .accordion{padding:15px 20px;cursor:pointer;background:#ff6600;margin:5px 0;border-radius:5px;display:flex;justify-content:space-between;align-items:center;}
#sidebar .accordion.active{background:#ff5500;}
#sidebar .panel{max-height:0;overflow:hidden;transition:max-height .3s;background:#ff7700;margin-bottom:5px;border-radius:5px;}
#sidebar .panel a{display:block;padding:10px 20px;color:#fff;}

/* ---------- Main ---------- */
#main{flex:1;display:flex;flex-direction:column;}
#main-header{background:#0f62fe;color:#fff;padding:15px;display:flex;align-items:center;justify-content:space-between;}
#main-header h1{font-size:1.2rem;}
#toggleSidebar{font-size:1.5rem;cursor:pointer;}

/* ---------- Cards Dashboard ---------- */
.cards{display:flex;flex-wrap:wrap;gap:20px;padding:20px;}
.card{flex:1 1 150px;background:#fff;color:#000;padding:20px;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.2);transition:transform .2s;}
.card:hover{transform:scale(1.05);}
.card i{font-size:2rem;margin-bottom:10px;}

/* ---------- Tabla ---------- */
table{width:100%;border-collapse:collapse;margin:20px 0;}
th,td{padding:10px;border:1px solid #ddd;text-align:center;}
th{background:#0f62fe;color:#fff;}
.actions button{margin:0 5px;font-size:1rem;}

/* ---------- Search ---------- */
.search-bar{padding:10px;}
.search-bar input{width:100%;padding:10px;border-radius:5px;border:1px solid #ccc;}

/* ---------- Modal ---------- */
#modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:999;}
#modal .modal-content{background:#fff;padding:20px;border-radius:10px;width:90%;max-width:500px;}
#modal input{width:100%;padding:10px;margin:5px 0;border:1px solid #ccc;border-radius:5px;}

/* ---------- Responsive ---------- */
@media(max-width:768px){
    .cards{flex-direction:column;}
    #sidebar{position:absolute;z-index:1000;height:100%;}
    #main{margin-left:60px;}
    #sidebar.collapsed{width:0;}
}
</style>
</head>
<body>

<div id="sidebar">
    <h2>Menú</h2>
    <div class="accordion">Dashboard <i class="fa fa-angle-down"></i></div>
    <div class="panel">
        <a href="javascript:nav('dashboard')">Inicio</a>
        <a href="javascript:nav('inventario')">Inventario</a>
        <a href="javascript:nav('categoria')">Categorías</a>
        <a href="javascript:nav('tienda')">Tiendas</a>
    </div>
</div>

<div id="main">
    <div id="main-header">
        <span id="toggleSidebar"><i class="fa fa-bars"></i></span>
        <h1 id="main-title">Dashboard</h1>
        <button onclick="openAddForm(currentView)"><i class="fa fa-plus"></i> Agregar</button>
    </div>
    <div id="content"></div>
</div>

<!-- Modal -->
<div id="modal">
    <div class="modal-content">
        <h2 id="modal-title"></h2>
        <div id="modal-form"></div>
        <button onclick="saveItem()">Guardar</button>
        <button onclick="closeModal()">Cancelar</button>
    </div>
</div>

<script>
// ------------------------- SCRIPT -------------------------
const APPWEB_URL = "https://script.google.com/macros/s/AKfycbz5af-9YvEbD_2Lkwss6xPhBXqh9UEaqMqHIQ1OdXrv44SSxsYYa47Z5x4e6LFyPHFN/exec";
let inventario=[], categorias=[], tiendas=[], pendingOps=[];
let editItemIndex=null, currentView='dashboard', currentSearch='';
const STORAGE_KEY='inventario3a';

// Sidebar y acordeón
document.getElementById('toggleSidebar').onclick = () => document.getElementById('sidebar').classList.toggle('collapsed');
function toggleAccordion(button){
    document.querySelectorAll('.accordion').forEach(acc => {
        if(acc!==button && acc.classList.contains('active')){
            acc.classList.remove('active');
            if(acc.nextElementSibling) acc.nextElementSibling.style.maxHeight=null;
        }
    });
    button.classList.toggle('active');
    const panel = button.nextElementSibling;
    if(panel) panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight+"px";
}
document.querySelectorAll('.accordion').forEach(btn => btn.addEventListener('click', () => toggleAccordion(btn)));

// LocalStorage
function saveData(){localStorage.setItem(STORAGE_KEY,JSON.stringify({inventario,categorias,tiendas,pendingOps}));}
function loadData(){
    const data = localStorage.getItem(STORAGE_KEY);
    if(data){
        const parsed = JSON.parse(data);
        inventario = parsed.inventario || [];
        categorias = parsed.categorias || [];
        tiendas = parsed.tiendas || [];
        pendingOps = parsed.pendingOps || [];
    }
}

// Fetch inicial
async function fetchSheet(sheet){
    try{
        const res = await fetch(`${APPWEB_URL}?sheet=${sheet}&action=get&t=${Date.now()}`);
        const json = await res.json();
        return json.map(row => ({
            idSheet: row.id || '',
            nombre: row.nombre || row.Nombre || row.Categoria || row.Tienda || '',
            Codigo: row.Codigo||'',
            Serie: row.Serie||'',
            Equipo: row.Equipo||'',
            Marca: row.Marca||'',
            Modelo: row.Modelo||'',
            Categoria: row.Categoria||'',
            Tienda: row.Tienda||''
        }));
    }catch(e){console.warn("fetchSheet error",e); return [];}
}

// Sync item
async function syncItem(tipo,item,action){
    if(!item) return false;
    const sheet=(tipo==='inventario')?'inventario':(tipo==='categoria'?'categoria':'tienda');
    const params=new URLSearchParams();
    params.append('sheet',sheet);
    params.append('action',action);

    if(action==='add'||action==='update'){
        if(action==='update' && !item.idSheet) return false;
        const fields=(tipo==='inventario')?['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda']:['nombre'];
        if(action==='update'){params.append('idCol','id'); params.append('idValue',item.idSheet);}
        fields.forEach(k=>params.append(k,item[k]||''));
    } else if(action==='delete'){
        if(!item.idSheet) return true;
        params.append('idCol','id'); params.append('idValue',item.idSheet);
    }

    try{
        const res = await fetch(`${APPWEB_URL}?${params.toString()}`,{method:'POST'});
        const data = await res.json();
        if(data.success && action==='add' && data.id){item.idSheet = data.id;}
        return data.success;
    }catch(e){console.warn("syncItem error:",e); return false;}
}

async function syncPending(){
    if(pendingOps.length===0) return;
    for(const op of [...pendingOps]){
        const ok = await syncItem(op.tipo,op.item,op.action);
        if(ok) pendingOps.splice(pendingOps.indexOf(op),1);
    }
    saveData();
}

// Render
function render(){
    const container = document.getElementById('content'); container.innerHTML='';
    if(currentView==='dashboard'){
        container.innerHTML = `<div class="cards">
            <div class="card" onclick="nav('inventario')"><i class="fa-solid fa-computer"></i><span>Inventario (${inventario.length})</span></div>
            <div class="card" onclick="nav('categoria')"><i class="fa-solid fa-tags"></i><span>Categorías (${categorias.length})</span></div>
            <div class="card" onclick="nav('tienda')"><i class="fa-solid fa-store"></i><span>Tiendas (${tiendas.length})</span></div>
        </div>`; return;
    }

    const arr = (currentView==='inventario')?inventario:(currentView==='categoria')?categorias:tiendas;
    const filtered = arr.filter(item => (item.nombre||'').toLowerCase().includes(currentSearch.toLowerCase()) || (item.Codigo||'').toLowerCase().includes(currentSearch.toLowerCase()));

    let html = `<div class="search-bar"><input type="text" placeholder="Buscar..." oninput="searchItems(this.value)" value="${currentSearch}"></div>
    <table><thead><tr>`;
    if(currentView==='inventario'){html+='<th>ID</th><th>Codigo</th><th>Serie</th><th>Equipo</th><th>Marca</th><th>Modelo</th><th>Categoria</th><th>Tienda</th>';}
    else{html+='<th>ID</th><th>Nombre</th>';}
    html+='<th>Acciones</th></tr></thead><tbody>';

    filtered.forEach((item,i)=>{
        html+='<tr>';
        if(currentView==='inventario'){
            html+=`<td>${item.idSheet||''}</td><td>${item.Codigo||''}</td><td>${item.Serie||''}</td><td>${item.Equipo||''}</td>
            <td>${item.Marca||''}</td><td>${item.Modelo||''}</td><td>${item.Categoria||''}</td><td>${item.Tienda||''}</td>`;
        }else{html+=`<td>${item.idSheet||''}</td><td>${item.nombre||''}</td>`;}
        html+=`<td class="actions">
            <button class="btn-edit" onclick="openEditForm('${currentView}',${arr.indexOf(item)})"><i class="fa-solid fa-pen"></i></button>
            <button class="btn-del" onclick="deleteItem('${currentView}',${arr.indexOf(item)})"><i class="fa-solid fa-trash"></i></button>
        </td></tr>`;
    });

    html+='</tbody></table>'; container.innerHTML=html;
}

// Navegación y búsqueda
function nav(view){currentView=view;currentSearch='';document.getElementById('main-title').innerText=view.charAt(0).toUpperCase()+view.slice(1);render();}
function searchItems(val){currentSearch=val; render();}

// Modal
function openAddForm(tipo){
    editItemIndex=null;
    document.getElementById('modal').style.display='flex';
    document.getElementById('modal-title').innerText='Agregar '+tipo;
    const formDiv = document.getElementById('modal-form');
    let html='';
    if(tipo==='inventario'){
        html+=`<input placeholder="Codigo" id="Codigo"><input placeholder="Serie" id="Serie"><input placeholder="Equipo" id="Equipo">
        <input placeholder="Marca" id="Marca"><input placeholder="Modelo" id="Modelo">`;
        html+='<input list="listaCategorias" placeholder="Categoria" id="Categoria"><datalist id="listaCategorias">';
        categorias.forEach(c=>html+=`<option value="${c.nombre}">`);
        html+='</datalist>';
        html+='<input list="listaTiendas" placeholder="Tienda" id="Tienda"><datalist id="listaTiendas">';
        tiendas.forEach(t=>html+=`<option value="${t.nombre}">`);
        html+='</datalist>';
    }else{html+='<input placeholder="Nombre" id="nombre">';}
    formDiv.innerHTML=html;
}

function openEditForm(tipo,index){
    editItemIndex=index;
    document.getElementById('modal').style.display='flex';
    document.getElementById('modal-title').innerText='Editar '+tipo;
    const formDiv = document.getElementById('modal-form');
    const item = (tipo==='inventario')?inventario[index]:(tipo==='categoria')?categorias[index]:tiendas[index];
    let html='';
    if(tipo==='inventario'){
        html+=`<input placeholder="Codigo" id="Codigo" value="${item.Codigo||''}"><input placeholder="Serie" id="Serie" value="${item.Serie||''}">
        <input placeholder="Equipo" id="Equipo" value="${item.Equipo||''}"><input placeholder="Marca" id="Marca" value="${item.Marca||''}">
        <input placeholder="Modelo" id="Modelo" value="${item.Modelo||''}">`;
        html+='<input list="listaCategorias" placeholder="Categoria" id="Categoria" value="'+(item.Categoria||'')+'"><datalist id="listaCategorias">';
        categorias.forEach(c=>html+=`<option value="${c.nombre}">`); html+='</datalist>';
        html+='<input list="listaTiendas" placeholder="Tienda" id="Tienda" value="'+(item.Tienda||'')+'"><datalist id="listaTiendas">';
        tiendas.forEach(t=>html+=`<option value="${t.nombre}">`); html+='</datalist>';
    }else{html+='<input placeholder="Nombre" id="nombre" value="'+(item.nombre||'')+'">';}
    formDiv.innerHTML=html;
}

function closeModal(){document.getElementById('modal').style.display='none';}
async function saveItem(){
    const tipo=currentView;
    const fields=(tipo==='inventario')?['Codigo','Serie','Equipo','Marca','Modelo','Categoria','Tienda']:['nombre'];
    const item={}; fields.forEach(f=>item[f]=document.getElementById(f).value.trim());
    const arr=(tipo==='inventario')?inventario:(tipo==='categoria')?categorias:tiendas;
    if(editItemIndex!==null){
        const oldItem=arr[editItemIndex]; fields.forEach(f=>oldItem[f]=item[f]);
        await syncItem(tipo,oldItem,'update');
    }else{
        await syncItem(tipo,item,'add'); arr.push(item);
    }
    closeModal(); saveData(); render(); syncPending();
}

function deleteItem(tipo,index){
    if(!confirm('¿Eliminar este registro?')) return;
    const arr=(tipo==='inventario')?inventario:(tipo==='categoria')?categorias:tiendas;
    const item=arr[index]; if(item.idSheet) pendingOps.push({tipo,action:'delete',item});
    arr.splice(index,1); saveData(); render(); syncPending();
}

// Inicializar
async function init(){
    loadData();
    if(inventario.length===0) inventario=await fetchSheet('inventario');
    if(categorias.length===0) categorias=await fetchSheet('categoria');
    if(tiendas.length===0) tiendas=await fetchSheet('tienda');
    render();
    syncPending();
}
init();
</script>
</body>
</html>
